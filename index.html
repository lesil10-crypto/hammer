<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vocabulary Builder</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-icons@0.378.0/dist/lucide.min.js"></script>

    <style>
        /* Noto Sans KR font global application */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #e0e5ec; /* Updated background color for neumorphism */
            color: #4a5568; /* Default text color */
        }

        /* --- Global 3D Text Effect (Neumorphic Texture) --- */
        body, h1, h2, h3, h4, p, span, div, button, a {
            text-shadow: 1px 1px 1px #ffffff, -1px -1px 1px #c5c9d2;
        }
        input, select, textarea {
            text-shadow: none; /* Input fields should not have text shadow for readability */
            background-color: #e0e5ec;
        }
        .prose p, .prose li { /* Reset for long-form text to improve readability */
            text-shadow: none;
        }
        /* --- END --- */

        /* 3D texture (embossed effect) button style */
        .btn-3d {
            background-color: #e0e5ec;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            color: #4a5568;
            box-shadow: 6px 6px 12px #c5c9d2, -6px -6px 12px #fdffff;
            transition: all 0.2s ease-in-out;
            outline: none;
            text-shadow: 1px 1px 1px #ffffff, -1px -1px 1px #c5c9d2; /* Button text texture */
        }

        .btn-3d:hover {
            box-shadow: 4px 4px 8px #c5c9d2, -4px -4px 8px #fdffff;
        }
        
        .btn-3d:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: inset 2px 2px 4px #c5c9d2, inset -2px -2px 4px #fdffff;
        }

        .btn-3d:active {
            box-shadow: inset 4px 4px 8px #c5c9d2, inset -4px -4px 8px #fdffff;
        }
        
        /* Card design */
        .card {
            background-color: #e0e5ec;
            border-radius: 15px;
            box-shadow: 8px 8px 16px #c5c9d2, -8px -8px 16px #fdffff;
            margin-bottom: 2rem;
        }
        
        /* Click to Search style */
        .clickable-word {
            cursor: pointer;
            font-weight: 500;
            color: #2b6cb0;
            transition: color 0.2s;
            border-bottom: 1px dotted #2b6cb0;
            text-shadow: none; /* Clickable words should be clear */
        }
        .clickable-word:hover {
            color: #2c5282;
            background-color: #bee3f8;
        }
        
        /* Loading spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal style */
        .modal {
            transition: opacity 0.3s ease;
        }
        
        /* Toast message style */
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        
        .clickable-image {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .clickable-image:hover {
            transform: scale(1.03);
        }

        /* Icon Button Base Style (Circular Neumorphism) */
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem; /* 36px */
            height: 2.25rem; /* 36px */
            border-radius: 9999px;
            background-color: #e2e8f0;
            transition: all 0.2s;
            color: #4a5568;
            box-shadow: 3px 3px 6px #c5c9d2, -3px -3px 6px #fdffff;
            position: relative; /* For tooltip positioning */
        }
        .icon-btn:hover {
            color: #1a202c;
            box-shadow: 2px 2px 4px #c5c9d2, -2px -2px 4px #fdffff;
        }
        .icon-btn:active {
            box-shadow: inset 2px 2px 4px #c5c9d2, inset -2px -2px 4px #fdffff;
        }

        /* Icon SVG Styling - Adding Neumorphism Texture to the Icon Path itself */
        .icon-btn svg path, .icon-btn svg circle, .icon-btn svg polygon {
            filter: drop-shadow(1px 1px 1px rgba(255, 255, 255, 0.7)) drop-shadow(-1px -1px 1px rgba(0, 0, 0, 0.2));
            transition: filter 0.2s;
        }
        
        /* Tooltip styles */
        .tooltip {
            visibility: hidden;
            opacity: 0;
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the button */
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.2s;
            white-space: nowrap;
            font-size: 0.75rem;
            text-shadow: none; /* Tooltip text should be clear */
        }

        .icon-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Print-specific styles for better output (FIXED) */
        @media print {
            body {
                background-color: #fff !important;
                font-family: 'Times New Roman', serif;
                margin: 0;
                padding: 0;
            }
            
            /* 모든 주요 UI와 컨테이너를 숨기고, print-container만 보이게 함 */
            #app-container,
            #search-bar-container,
            #shortcut-buttons, 
            #loading-container,
            #tab-bar, 
            footer, 
            .modal, .toast, .tooltip, #auth-container, #confirmation-modal {
                display: none !important;
            }

            /* print-container만 인쇄 영역에 표시 */
            #print-container {
                display: block !important;
                width: 100%;
                margin: 0 auto;
                padding: 0 1cm; /* 여백 추가 */
            }

            /* 인쇄 헤더 (제목) */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                padding-top: 10px;
            }
            .print-header h1 {
                font-size: 24pt;
                font-weight: bold;
                color: #000;
                text-shadow: none;
            }
            
            /* 카드 스타일 리셋 */
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                background-color: #fff !important;
                margin-bottom: 1.5rem;
                padding: 10px !important;
            }
            
            /* 이미지 처리 */
            img {
                max-width: 100%;
                height: auto;
                page-break-inside: avoid;
            }

            /* 인쇄 전용 콘텐츠에만 텍스트 섀도우 제거 */
            #print-container * {
                text-shadow: none !important;
            }
        }

    </style>
</head>
<body class="bg-slate-100 text-gray-800">
    <div id="app-container" style="visibility: hidden;">
        <div class="max-w-4xl mx-auto p-4 pb-24">
            <!-- Header -->
            <header class="text-center my-8 flex justify-center items-center">
                <div>
                    <h1 class="text-4xl font-bold text-gray-700" style="text-shadow: 2px 2px 4px #d1d9e6;">AI Vocabulary Builder</h1>
                    <p class="text-gray-500 mt-2">AI와 함께 단어의 모든 것을 탐험하세요</p>
                </div>
            </header>

            <!-- Search Bar -->
            <div id="search-bar-container" class="card p-6 mb-8 sticky top-4 z-10">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-input" placeholder="영단어 또는 한글 뜻을 입력하세요..." class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    <button id="search-button" class="btn-3d w-full sm:w-auto">
                        <i data-lucide="search" class="inline-block mr-2"></i> 검색
                    </button>
                </div>
            </div>

            <!-- App Shortcut Buttons -->
            <div id="shortcut-buttons" class="card p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <a href="https://www.naver.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-green-600 !p-2 !text-sm">
                    <!-- Naver Icon -->
                    <svg class="w-6 h-6 mb-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="20" height="20" rx="4" fill="#03C75A"/>
                        <path d="M12 7V17M12 7L10 9M12 7L14 9M10 17H14" stroke="#e0e5ec" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="11" fill="none" stroke="#03C75A" stroke-width="2"/>
                    </svg>
                    네이버
                </a>
                <a href="https://www.google.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-blue-600 !p-2 !text-sm">
                    <!-- Google Icon -->
                    <i data-lucide="globe-2" class="w-5 h-5 mb-1 text-blue-500" style="text-shadow: 1px 1px 1px #e0e5ec, -1px -1px 1px #c5c9d2;"></i> 
                    Google
                </a>
                <a href="https://www.youtube.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-red-600 !p-2 !text-sm">
                    <!-- YouTube Icon -->
                    <i data-lucide="youtube" class="w-5 h-5 mb-1 text-red-600" style="text-shadow: 1px 1px 1px #e0e5ec, -1px -1px 1px #c5c9d2;"></i> 
                    YouTube
                </a>
                <a href="https://www.clien.net" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-gray-700 !p-2 !text-sm">
                    <!-- Clien Icon -->
                    <i data-lucide="message-square" class="w-5 h-5 mb-1 text-blue-900" style="text-shadow: 1px 1px 1px #e0e5ec, -1px -1px 1px #c5c9d2;"></i> 
                    Clien
                </a>
            </div> 
            
            <!-- Google Calendar Feature -->
            <div id="google-calendar" class="card p-6">
                <h3 class="text-2xl font-bold mb-4 flex items-center text-blue-700">
                    <i data-lucide="calendar" class="mr-2 text-blue-500"></i>Google 캘린더
                </h3>
                <div class="w-full h-[600px] rounded-lg overflow-hidden border-2 border-slate-200">
                     <iframe src="https://calendar.google.com/calendar/embed?src=lesil10%40gmail.com&ctz=Asia%2FSeoul" style="border: 0" width="100%" height="100%" frameborder="0" scrolling="no"></iframe>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-container" class="hidden text-center my-10">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-600 font-semibold"></p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Tab Bar -->
            <div id="tab-bar" class="flex flex-wrap items-end border-b-2 border-slate-300 mb-4">
                <!-- Tabs will be dynamically inserted here -->
            </div>
            
            <!-- Content Area -->
            <main id="tab-content-container"></main>

            <!-- This is no longer used for printing, but kept for legacy/potential reuse -->
            <div id="print-only-modal-content" class="hidden"></div> 
        </div>

        <!-- Fixed Bottom Menu -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-t border-t-2 border-slate-200 z-50">
            <div class="max-w-4xl mx-auto flex justify-around p-2">
                <button id="word-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="list-checks"></i>
                    <span class="text-xs font-medium">단어 목록</span>
                </button>
                <button id="sentence-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="save-all"></i>
                    <span class="text-xs font-medium">예문 저장</span>
                </button>
                <button id="file-storage-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="folder-archive"></i>
                    <span class="text-xs font-medium">파일 보관함</span>
                </button>
                <button id="share-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="share-2"></i>
                    <span class="text-xs font-medium">공유하기</span>
                </button>
            </div>
        </footer>
    </div>
    
    <!-- Content Modal -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideModal(event)">
        <div id="modal-content" class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8 card !mb-0" onclick="event.stopPropagation()">
            <!-- Modal content will be inserted here -->
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="image-modal-container" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center p-4 z-[60] modal" onclick="hideImageModal()">
        <img id="modal-image" src="" class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
        <button onclick="hideImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition" aria-label="Close image view">
            <i data-lucide="x" class="w-10 h-10"></i>
        </button>
    </div>

    <!-- Saved Word/Sentence List Modal -->
    <div id="list-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideListModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card !mb-0" onclick="event.stopPropagation()">
            <div id="list-modal-header" class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 id="list-modal-title" class="text-xl font-bold"></h2>
                <button onclick="hideListModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 flex flex-wrap gap-2 justify-between items-center bg-slate-200 border-b border-slate-300">
                <div>
                    <select id="sort-options" class="px-3 py-1.5 border border-slate-300 rounded-md bg-white">
                        <!-- Sort options -->
                    </select>
                </div>
                <div id="list-actions" class="flex flex-wrap gap-2">
                    <button id="mark-read-btn" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>읽음으로</button>
                    <button id="mark-unread-btn" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 disabled:bg-gray-400" disabled>읽지 않음으로</button>
                    <button id="delete-selected-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 disabled:bg-gray-400" disabled>선택 삭제</button>
                </div>
            </div>
            <div id="list-modal-content" class="p-6 overflow-y-auto flex-grow">
                <!-- List content -->
            </div>
        </div>
    </div>

    <!-- File Storage Modal -->
    <div id="file-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideFileModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card !mb-0" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 class="text-xl font-bold">파일 보관함</h2>
                <button onclick="hideFileModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 border-b border-slate-300">
                <h3 class="font-semibold mb-2">새 파일 올리기 (50MB 이하)</h3>
                <input type="file" id="file-upload-input" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <button id="file-upload-button" class="btn-3d mt-4 w-full">업로드</button>
                <div id="upload-progress-container" class="hidden mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="file-list" class="p-6 overflow-y-auto flex-grow">
                <!-- File list will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-[70] modal">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-sm w-full p-6 card !mb-0">
            <h3 id="confirmation-title" class="text-lg font-bold mb-4">확인</h3>
            <p id="confirmation-message" class="mb-6">이 작업을 정말로 실행하시겠습니까?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="btn-3d">취소</button>
                <button id="confirm-ok-btn" class="btn-3d !bg-red-500 !text-white hover:!bg-red-600">확인</button>
            </div>
        </div>
    </div>


    <!-- Toast Message -->
    <div id="toast-container" class="toast fixed bottom-24 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <!-- Live Translation Tooltip -->
    <div id="word-tooltip" class="hidden absolute z-[100] px-3 py-1.5 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm"></div>

    <!-- NEW: Print Container (Initially hidden) -->
    <div id="print-container" style="display: none;">
        <div class="print-header">
            <h1 class="text-4xl">AI Vocabulary Builder</h1>
            <p>AI와 함께 단어의 모든 것을 탐험하세요</p>
            <hr style="border: 1px solid #ccc; margin-top: 10px;">
        </div>
        <div id="print-content-area">
            <!-- Dynamic content will be inserted here -->
        </div>
    </div>

    <script type="module">
        // Firebase Modular SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // =========================================================================
        // === This section is for deployment on platforms like GitHub Pages. ===
        // === The environment provides these variables automatically.       ===
        const USER_FIREBASE_CONFIG = {
          apiKey: "AIzaSyDKmpQO6htm7jZ2DByUfGnmocZP7dpTJhs",
          authDomain: "projec-48c55.firebaseapp.com",
          projectId: "projec-48c55",
          storageBucket: "projec-48c55.appspot.com",
          messagingSenderId: "376464552007",
          appId: "1:376464552007:web:929b53196fc86af19dc162",
          measurementId: "G-HMKJMNFGM4"
        };
        const USER_GEMINI_API_KEY = "AIzaSyBWH-Fr5xqAV2xClVmkjLKVFJIWv7P2iodY"; // 여기에 본인의 Google AI Studio API 키를 입력하세요.
        // =========================================================================
        
        // ---------------------------
        // 0. Initial Setup & Variable Declaration
        // ---------------------------
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const loadingContainer = document.getElementById('loading-container');
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');
        const searchBarContainer = document.getElementById('search-bar-container'); // For scrolling
        
        // NEW PRINT DOM REFERENCES
        const printContainer = document.getElementById('print-container');
        const printContentArea = document.getElementById('print-content-area');
        
        const apiKey = typeof __gemini_api_key__ !== 'undefined' ? __gemini_api_key__ : USER_GEMINI_API_KEY;
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent`;
        const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict`;
        
        const translationCache = {};

        // Firebase Setup
        let db, auth, storage, userId;
        let app; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ai-vocab-app';
        
        // Tab Management
        let tabs = {};
        let activeTabId = null;
        let tabCounter = 0;
        let savedWords = [];
        let savedSentences = [];
        
        // Firebase Initialization and Authentication
        async function initializeFirebase() {
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(USER_FIREBASE_CONFIG);
            const firebaseConfig = JSON.parse(configString || '{}');

            try {
                // WARNING: Check if Firebase API Key and Gemini API Key are the same.
                if (firebaseConfig.apiKey === USER_GEMINI_API_KEY && USER_GEMINI_API_KEY !== "YOUR_API_KEY_HERE") {
                    console.warn("WARNING: Firebase API Key is the same as the Gemini API Key. They should be different. Check your configuration.");
                }

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.error("Firebase config is missing.");
                    showToast("Firebase configuration is missing. For GitHub deployment, you need to enter it directly into the code.", "error");
                    document.getElementById('app-container').style.visibility = 'visible';
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                    console.log("Authenticated with Custom Token. User ID:", userId);
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                    console.log("Authenticated Anonymously. User ID:", userId);
                }

                document.getElementById('app-container').style.visibility = 'visible';
                loadUserLists();
                listenForFiles();
                safeCreateIcons();
                // initializeCalendar(); // REMOVED: No longer needed

            } catch (error) {
                console.error("Firebase Initialization/Auth Error: ", error);
                showToast("Failed to connect to the database or authenticate.", "error");
            }
        }
        
        // ---------------------------
        // 1. API Communication Functions
        // ---------------------------

        async function fetchWithRetry(baseUrl, payload, retries = 3) {
            // If API Key is missing, do not call and throw an error.
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                showToast("Google AI API Key is not set.", "error");
                throw new Error("Google AI API Key is missing.");
            }

            const finalUrl = `${baseUrl}?key=${apiKey}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(finalUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`API Error Response: ${response.status} - ${errorBody}`);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) {
                        showToast("Failed to get a response from the AI server. Please try again later.", "error");
                        throw error;
                    }
                    const delay = 1000 * Math.pow(2, i) + Math.random() * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        }

        async function callGemini(prompt, isJson = false) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }
            
            const result = await fetchWithRetry(textApiUrl, payload);
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                console.error("Empty response from Gemini:", result);
                throw new Error("Gemini API response is empty.");
            }

            if (isJson) {
                let jsonString = text.trim();
                if (jsonString.startsWith("```json")) {
                    jsonString = jsonString.slice(7, -3).trim();
                } else if (jsonString.startsWith("```")) {
                    jsonString = jsonString.slice(3, -3).trim();
                }
                
                try {
                    return JSON.parse(jsonString);
                } catch (error) {
                    console.error("Failed to parse JSON:", error);
                    console.error("Original text from API:", text);
                    throw error;
                }
            }

            return text;
        }
        
        async function callImagen(prompt) {
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };
            // Added catch block to return a placeholder on image loading failure.
            try {
                const result = await fetchWithRetry(imageApiUrl, payload);
                const base64Data = result.predictions?.[0]?.bytesBase64Encoded;

                if (!base64Data) {
                    console.error("Image generation API response is empty or invalid. Full response:", result);
                    // Return a clear placeholder on failure.
                    return `https://placehold.co/300x300/e74c3c/ffffff?text=Image+Load+Failed`; 
                }
                return `data:image/png;base64,${base64Data}`;
            } catch (e) {
                console.error("Imagen API call failed:", e);
                return `https://placehold.co/300x300/e74c3c/ffffff?text=Image+Load+Failed`; 
            }
        }
        
        // ---------------------------
        // 2. Core Logic: Search and Content Generation
        // ---------------------------
        
        async function handleSearch(query) {
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") { 
                showToast("Google AI API Key is not set. Please enter your key in the code and redeploy.", "error");
                return;
            }
            if (!auth || !auth.currentUser) {
                showToast("Not connected to Firebase. Please check your configuration.", "error");
                return;
            }
            if (!query) {
                showToast("Please enter a search term.", "warning");
                return;
            }

            const isKorean = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(query);

            if (isKorean) {
                showLoader(0, `Checking the meaning of '${query}'...`);
                try {
                    const ambiguityPrompt = `Can the Korean word "${query}" be translated into multiple distinct English words? (e.g., '배' -> ship, pear, stomach). Please answer only in the following JSON format: {"is_ambiguous": boolean, "english_words": ["word1", "word2", ...]}. If not ambiguous, include only one representative English word in the "english_words" array.`;
                    const ambiguityData = await callGemini(ambiguityPrompt, true);
                    
                    if (ambiguityData.is_ambiguous && ambiguityData.english_words.length > 1) {
                        showToast(`Found multiple meanings for '${query}'. Displaying each in a separate tab.`, "info");
                        for (let i = 0; i < ambiguityData.english_words.length; i++) {
                            const word = ambiguityData.english_words[i];
                            await executeSearchForWord(word, i === 0);
                        }
                    } else {
                        await executeSearchForWord(ambiguityData.english_words[0] || query);
                    }
                } catch (error) {
                    console.error("Ambiguity check failed:", error);
                    showToast("An error occurred while checking the word's meaning.", "error");
                    await executeSearchForWord(query);
                } finally {
                    hideLoader();
                }
            } else {
                await executeSearchForWord(query);
            }
        }

        async function executeSearchForWord(wordQuery, makeActive = true) {
            const tabId = addTab(wordQuery, makeActive);
            const currentTab = tabs[tabId];
            const contentContainer = currentTab.contentEl;
            contentContainer.innerHTML = '';
            
            const searchId = ++currentTab.searchId;
            currentTab.fullSearchResult = {};

            showLoader(0, `Starting search for "${wordQuery}"...`);
            searchButton.disabled = true;

            // Scroll to the results area on search start (below the header).
            const headerHeight = document.querySelector('header').offsetHeight || 100;
            window.scrollTo({ top: headerHeight, behavior: 'smooth' });

            try {
                updateLoader(10, "Generating basic information...");
                const initialInfoPrompt = `Please generate comprehensive information for the English word "${wordQuery}". You must follow this JSON format:
                {
                    "word": "the actual English word",
                    "koreanMeaning": "representative Korean meaning",
                    "pronunciation": "pronunciation symbols",
                    "mainImagePrompt": "A detailed, artistic English prompt for generating an image that encapsulates the word. Example for 'brain': 'A hyper-realistic, detailed anatomical illustration of the human brain, showing different lobes with glowing neural pathways, artistic style.'",
                    "episode": {
                        "story": "A very funny, short story (3-4 sentences) to help remember the word easily.",
                        "story_ko": "A natural Korean translation of the story above.",
                        "imagePrompt": "An English prompt for generating a bright, humorous cartoon-style image that matches the story. Example: 'Dr. Slump' manga style."
                    }
                }`;
                const initialData = await callGemini(initialInfoPrompt, true);
                currentTab.fullSearchResult.initialData = initialData;
                if (searchId !== currentTab.searchId) return;

                updateLoader(25, "Displaying basic information...");
                renderPrintButton(currentTab);
                const placeholderImg = "https://placehold.co/300x300/e0e5ec/4a5568?text=Loading...";
                renderBasicInfo(initialData, placeholderImg, contentContainer);
                renderEpisode(initialData, placeholderImg, contentContainer);
                addWordToHistory(initialData.word, initialData.koreanMeaning);

                const meaningImagePromises = [];
                
                callImagen(initialData.mainImagePrompt).then(imageUrl => {
                    currentTab.fullSearchResult.mainImageUrl = imageUrl;
                    if (searchId === currentTab.searchId) {
                        const imgEl = contentContainer.querySelector('#main-image');
                        if (imgEl) {
                            imgEl.src = imageUrl;
                            imgEl.onerror = () => imgEl.src = `https://placehold.co/300x300/e74c3c/ffffff?text=Image+Load+Failed`; 
                            imgEl.onclick = () => showImageModal(imageUrl);
                        }
                    }
                }).catch(e => console.error("Main Image Load Failed:", e));
                
                callImagen(initialData.episode.imagePrompt).then(imageUrl => {
                    currentTab.fullSearchResult.episodeImageUrl = imageUrl;
                    if (searchId === currentTab.searchId) {
                        const imgEl = contentContainer.querySelector('#episode-image');
                        if (imgEl) {
                            imgEl.src = imageUrl;
                            imgEl.onerror = () => imgEl.src = `https://placehold.co/300x300/e74c3c/ffffff?text=Image+Load+Failed`; 
                            imgEl.onclick = () => showImageModal(imageUrl);
                        }
                    }
                }).catch(e => console.error("Episode Image Load Failed:", e));
                
                updateLoader(40, "Generating meaning analysis...");
                const meaningsPrompt = `Analyze the meanings of the English word "${initialData.word}". For each of the core meaning, additional meaning, and idiomatic expressions, provide a description, a representative example sentence, and a funny illustration prompt in the style of 'Dr. Slump' for that sentence. You must follow this JSON format:
                [
                    { "type": "Core Meaning", "description": "Detailed Korean explanation of the core meaning.", "exampleSentence": "A modern, common English example sentence that best represents the meaning.", "exampleSentenceTranslation": "Korean translation of the example sentence.", "imagePrompt": "An English prompt for a funny illustration based on the example sentence, in the style of 'Dr. Slump' manga. Make the character expressions varied and amusing." },
                    { "type": "Additional Meaning", "description": "Korean explanation of additional, figurative, or extended meanings.", "exampleSentence": "A creative English example sentence showing this meaning.", "exampleSentenceTranslation": "Korean translation of the example sentence.", "imagePrompt": "An illustration prompt based on the example sentence." },
                    { "type": "Idiomatic Expression", "description": "Korean explanation of important idioms containing the word and their meanings.", "exampleSentence": "A natural English example sentence using the idiom.", "exampleSentenceTranslation": "Korean translation of the example sentence.", "imagePrompt": "An illustration prompt based on the example sentence." }
                ]`;
                const meaningsData = await callGemini(meaningsPrompt, true);
                currentTab.fullSearchResult.meaningsData = meaningsData;
                if (searchId !== currentTab.searchId) return;

                await renderMeanings(meaningsData, initialData.word, searchId, currentTab, contentContainer, meaningImagePromises);
                
                renderSentenceCrafter(initialData.word, contentContainer);

                updateLoader(75, "Generating advanced learning information...");
                const fastDeepDivePrompt = `Generate advanced learning content for the English word "${initialData.word}". Exclude "encyclopedia" and you must follow this JSON format:
                {
                    "quotes": [
                        {"quote": "Related quote/famous phrase 1", "translation": "Korean translation"},
                        {"quote": "Related quote/famous phrase 2", "translation": "Korean translation"},
                        {"quote": "Related quote/famous phrase 3", "translation": "Korean translation"}
                    ],
                    "synonyms": ["synonym1(meaning1)", "synonym2(meaning2)", "synonym3(meaning3)"],
                    "antonyms": ["antonym1(meaning1)", "antonym2(meaning2)"],
                    "conceptTree": { "superordinate": ["Superordinate concept (English(Korean))"], "coordinate": ["Coordinate concept 1 (English(Korean))", "...(total 10)"], "subordinate": ["Subordinate concept 1 (English(Korean))", "...(total 20)"] },
                    "dialogue": [ 
                        {"speaker": "A", "line": "Dialogue line 1 (English)", "translation": "Dialogue line 1 (Korean)"}, 
                        {"speaker": "B", "line": "Dialogue line 2 (English)", "translation": "Dialogue line 2 (Korean)"}
                    ],
                    "quiz": [
                        { "question": "Difficult 4-choice quiz question 1", "options": ["Option A", "Option B", "Option C", "Option D"], "answer": "Correct option", "explanation": "Detailed Korean explanation for the answer. Must include a Korean translation of the quiz question sentence." }
                    ]
                }`;
                const fastDeepDiveData = await callGemini(fastDeepDivePrompt, true);
                currentTab.fullSearchResult.fastDeepDiveData = fastDeepDiveData;
                if (searchId !== currentTab.searchId) return;
                
                updateLoader(90, "Displaying advanced information...");
                const buttonContainer = renderDeepDiveButtonsContainer(contentContainer);
                appendConceptTreeButton(buttonContainer, fastDeepDiveData.conceptTree);
                renderDeepDive(fastDeepDiveData, contentContainer);
                
                // Wait for all image loadings to complete.
                await Promise.all(meaningImagePromises.map(p => p.catch(e => e))); 
                
                hideLoader();
                showToast("Core information loaded! Generating encyclopedia entry...", "info");

                const encyclopediaPrompt = `Generate an encyclopedic description for the English word "${initialData.word}". The content should be detailed, equivalent to 3 A4 pages, and structured with 'Etymology', 'Historical Background', and 'Usage in Literature/Modern Times' sections. Follow only this JSON format:
                { 
                    "encyclopedia": { 
                        "introduction": "Detailed introduction (English, multiple paragraphs)", "etymology": "In-depth etymological analysis (English, multiple paragraphs)", "history": "Comprehensive historical background and evolution (English, multiple paragraphs)", "usage": "Examples of usage in literature, modern media, and daily life (English, multiple paragraphs)",
                        "introduction_ko": "Korean translation of the above content", "etymology_ko": "Korean translation of the above content", "history_ko": "Korean translation of the above content", "usage_ko": "Korean translation of the above content"
                    }
                }`;
                const encyclopediaFullData = await callGemini(encyclopediaPrompt, true);
                if (searchId !== currentTab.searchId) return;
                
                currentTab.fullSearchResult.encyclopediaData = encyclopediaFullData;
                appendEncyclopediaButton(buttonContainer, encyclopediaFullData.encyclopedia);
                showToast("All content has been generated!", "success");

                const printButton = currentTab.contentEl.querySelector(`#print-btn-${currentTab.id}`);
                if (printButton) {
                    printButton.disabled = false;
                    printButton.innerHTML = `<i data-lucide="printer" class="inline-block mr-2"></i>Print Results`;
                    safeCreateIcons();
                }
                
            } catch (error) {
                console.error("Search failed:", error);
                showToast("An error occurred while generating content.", "error");
                hideLoader();
                contentContainer.innerHTML = `<div class="card p-8 text-center text-red-500">
                    <p>Failed to load search results.</p>
                    <p class="text-sm text-gray-500 mt-2">The word may not exist, or there might be a network issue.</p>
                </div>`;
            } finally {
                searchButton.disabled = false;
            }
        }
        
        // ---------------------------
        // 3. Rendering Functions
        // ---------------------------
        
        function renderPrintButton(tab) {
            const printButton = document.createElement('button');
            printButton.id = `print-btn-${tab.id}`;
            printButton.className = 'btn-3d mb-4';
            printButton.disabled = true;
            printButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>Preparing for print...`;
            printButton.onclick = () => handlePrint(tab.id);
            tab.contentEl.prepend(printButton);
            safeCreateIcons();
        }

        function renderBasicInfo(data, imageUrl, container) {
            const html = `
                <div class="card p-6">
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="w-full md:w-2/5">
                            <img id="main-image" src="${imageUrl}" alt="${data.word}" class="rounded-lg shadow-lg w-full h-auto object-cover clickable-image">
                        </div>
                        <div class="w-full md:w-3/5">
                            <div class="flex items-center gap-4 mb-4">
                                <h2 class="text-5xl font-bold">${data.word}</h2>
                                <button onclick="speak('${data.word}', 'en-US')" class="btn-3d p-3">${createVolumeIcon()}</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <p class="text-2xl text-gray-600">${data.koreanMeaning}</p>
                                <button onclick="speak('${data.koreanMeaning}', 'ko-KR')" class="btn-3d p-3">${createVolumeIcon()}</button>
                            </div>
                            <p class="text-lg text-gray-500 mt-2">[${data.pronunciation}]</p>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            safeCreateIcons();
        }

        function renderEpisode(data, imageUrl, container) {
            const { episode, word } = data;
            const html = `
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 text-yellow-500"></i>Funny Episode</h3>
                    <img id="episode-image" src="${imageUrl}" alt="Episode illustration" class="rounded-lg shadow-md w-full h-auto object-cover mb-4 max-w-sm mx-auto clickable-image">
                    <div class="space-y-2">
                        <p class="text-lg leading-relaxed">${addClickToSearch(episode.story)}</p>
                        <p class="text-md leading-relaxed text-gray-600">${episode.story_ko}</p>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row gap-2">
                        <button class="icon-btn" onclick="speak('${episode.story.replace(/'/g, "\\'")}', 'en-US')">
                            ${createVolumeIcon('w-5 h-5')}
                            <span class="tooltip">Listen (English)</span>
                        </button>
                        <button class="icon-btn" onclick="speak('${episode.story_ko.replace(/'/g, "\\'")}', 'ko-KR')">
                            ${createVolumeIcon('w-5 h-5')}
                            <span class="tooltip">Listen (Korean)</span>
                        </button>
                        <button class="btn-3d flex-grow" onclick="expandStory(this, '${word}', '${episode.story.replace(/'/g, "\\'")}', '${episode.story_ko.replace(/'/g, "\\'")}')">✨ Create More Story</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            safeCreateIcons();
        }

        function renderDeepDiveButtonsContainer(container) {
            const btnContainer = document.createElement('div');
            btnContainer.id = 'deep-dive-buttons';
            btnContainer.className = 'card p-6 grid grid-cols-1 sm:grid-cols-2 gap-4';
            container.appendChild(btnContainer);
            return btnContainer;
        }

        function appendConceptTreeButton(container, conceptTreeData) {
            const conceptTreeBtn = document.createElement('button');
            conceptTreeBtn.id = 'concept-tree-btn';
            conceptTreeBtn.className = 'btn-3d w-full';
            conceptTreeBtn.textContent = 'View Concept Tree';
            conceptTreeBtn.onclick = () => showConceptTree(conceptTreeData);
            container.appendChild(conceptTreeBtn);
        }

        function appendEncyclopediaButton(container, encyclopediaData) {
            const encyclopediaBtn = document.createElement('button');
            encyclopediaBtn.id = 'encyclopedia-btn';
            encyclopediaBtn.className = 'btn-3d w-full';
            encyclopediaBtn.textContent = 'View Encyclopedic Description';
            encyclopediaBtn.onclick = () => showEncyclopedia(encyclopediaData);
            container.prepend(encyclopediaBtn);
        }

        async function renderMeanings(meanings, word, searchId, currentTab, mainContainer) {
            const container = document.createElement('div');
            container.className = 'card p-6 space-y-8';
            container.innerHTML = `<h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="book-open-check" class="mr-2 text-green-600"></i>Meaning Analysis</h3>`;
            mainContainer.appendChild(container);
            
            for (const [index, meaning] of meanings.entries()) {
                if (currentTab.searchId !== searchId) return;
        
                const element = document.createElement('div');
                element.className = 'border-t border-slate-300 pt-6';
                
                const placeholderImg = "https://placehold.co/300x300/e0e5ec/4a5568?text=Loading...";
                const imageHtml = `<img id="meaning-image-${index}" src="${placeholderImg}" alt="${meaning.type}" class="rounded-lg shadow-md w-full h-auto object-cover mb-4 max-w-sm mx-auto clickable-image">`;
                
                // Fetch image for this specific meaning
                callImagen(meaning.imagePrompt).then(imageUrl => {
                    if (currentTab.searchId === searchId) {
                        if (currentTab.fullSearchResult.meaningsData && currentTab.fullSearchResult.meaningsData[index]) {
                            currentTab.fullSearchResult.meaningsData[index].imageUrl = imageUrl;
                        } else {
                            console.warn(`Could not find meaning data at index ${index} to store imageUrl.`);
                        }
                        const imgEl = mainContainer.querySelector(`#meaning-image-${index}`);
                        if (imgEl) {
                            imgEl.src = imageUrl;
                            imgEl.onclick = () => showImageModal(imageUrl);
                        }
                    }
                }).catch(error => {
                    console.error(`Failed to load image for meaning ${index}:`, error);
                });
        
                // Fetch examples for this specific meaning
                const examplesPrompt = `Generate 5 modern, useful English example sentences related to the meaning "${meaning.description}" of the word "${word}", along with their Korean translations. You must follow this JSON format:
                [
                    {"en": "Example sentence 1.", "ko": "Korean translation of example 1."},
                    {"en": "Example sentence 2.", "ko": "Korean translation of example 2."}
                ]`;
                const examples = await callGemini(examplesPrompt, true);
                if (currentTab.searchId !== searchId) return;
                
                if (currentTab.fullSearchResult.meaningsData && currentTab.fullSearchResult.meaningsData[index]) {
                    currentTab.fullSearchResult.meaningsData[index].examples = examples;
                }
        
                const examplesHtml = examples.map((ex, i) => `
                    <li class="flex items-start justify-between gap-3 mt-2">
                        <div class="flex items-start">
                            <span class="text-gray-500 mr-2">${i + 1}.</span>
                            <div>
                                <p class="text-md font-medium">${addClickToSearch(ex.en)}</p>
                                <p class="text-sm text-gray-500">${ex.ko}</p>
                            </div>
                        </div>
                        <div class="flex items-center flex-shrink-0 gap-1">
                            <button class="icon-btn" onclick="speak('${ex.en.replace(/'/g, "\\'")}', 'en-US')">
                                ${createVolumeIcon('w-5 h-5')}
                                <span class="tooltip">Listen (English)</span>
                            </button>
                            <button class="icon-btn" onclick="speak('${ex.ko.replace(/'/g, "\\'")}', 'ko-KR')">
                                ${createVolumeIcon('w-5 h-5')}
                                <span class="tooltip">Listen (Korean)</span>
                            </button>
                            <button class="icon-btn" onclick="saveSentence('${ex.en.replace(/'/g, "\\'")}', '${ex.ko.replace(/'/g, "\\'")}')">
                                ${createSaveIcon('w-5 h-5')}
                                <span class="tooltip">Save</span>
                            </button>
                        </div>
                    </li>`).join('');
        
                element.innerHTML = `
                    <h4 class="text-xl font-semibold text-blue-700">${meaning.type}</h4>
                    ${imageHtml}
                    <p class="text-gray-600 my-2">${meaning.description}</p>
                    <p class="font-medium mt-4 mb-2">Representative Example:</p>
                    <div class="bg-slate-200 p-4 rounded-lg">
                        <div>
                            <p class="text-lg font-semibold">${addClickToSearch(meaning.exampleSentence)}</p>
                            <p class="text-md text-gray-600">${meaning.exampleSentenceTranslation}</p>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <button class="icon-btn" onclick="speak('${meaning.exampleSentence.replace(/'/g, "\\'")}', 'en-US')">
                                ${createVolumeIcon('w-5 h-5')}
                                <span class="tooltip">Listen (English)</span>
                            </button>
                            <button class="icon-btn" onclick="speak('${meaning.exampleSentenceTranslation.replace(/'/g, "\\'")}', 'ko-KR')">
                                ${createVolumeIcon('w-5 h-5')}
                                <span class="tooltip">Listen (Korean)</span>
                            </button>
                            <button class="icon-btn" onclick="saveSentence('${meaning.exampleSentence.replace(/'/g, "\\'")}', '${meaning.exampleSentenceTranslation.replace(/'/g, "\\'")}')">
                                ${createSaveIcon('w-5 h-5')}
                                <span class="tooltip">Save</span>
                            </button>
                        </div>
                    </div>
                    <p class="font-medium mt-4 mb-2">Additional Examples:</p>
                    <ul class="list-inside space-y-2">${examplesHtml}</ul>`;
                container.appendChild(element);
            }
            safeCreateIcons();
        }
        
        function renderSentenceCrafter(word, container) {
            const html = `
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 text-blue-500"></i>AI Sentence Crafter ✨</h3>
                    <p class="text-gray-600 mb-4">Enter a situation where you want to use the word, and the AI will create custom example sentences for you. (e.g., in a meeting, with a friend, writing an email)</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="sentence-context-input" placeholder="Enter a situation..." class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <button id="sentence-craft-button" class="btn-3d w-full sm:w-auto" onclick="craftSentences(this, '${word}')">
                            <i data-lucide="pencil-ruler" class="inline-block mr-2"></i> Generate
                        </button>
                    </div>
                    <div id="sentence-crafter-results" class="mt-4"></div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            safeCreateIcons();
        }

        function renderDeepDive(data, container) {
            const html = `
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="graduation-cap" class="mr-2 text-purple-600"></i>Advanced Learning</h3>
                    <div class="space-y-6">
                        ${renderSection("Related Quotes/Phrases", "quote", data.quotes.map(q => `
                            <div class="border-l-4 border-slate-400 pl-4 py-2">
                                <p class="font-semibold text-lg">${addClickToSearch(q.quote)}</p>
                                <p class="text-gray-600">${q.translation}</p>
                                <div class="mt-2 flex gap-2">
                                    <button class="icon-btn" onclick="speak('${q.quote.replace(/'/g, "\\'")}', 'en-US')">
                                        ${createVolumeIcon('w-5 h-5')}
                                        <span class="tooltip">Listen (English)</span>
                                    </button>
                                    <button class="icon-btn" onclick="speak('${q.translation.replace(/'/g, "\\'")}', 'ko-KR')">
                                        ${createVolumeIcon('w-5 h-5')}
                                        <span class="tooltip">Listen (Korean)</span>
                                    </button>
                                    <button class="icon-btn" onclick="saveSentence('${q.quote.replace(/'/g, "\\'")}', '${q.translation.replace(/'/g, "\\'")}')">
                                        ${createSaveIcon('w-5 h-5')}
                                        <span class="tooltip">Save</span>
                                    </button>
                                </div>
                            </div>`).join('<hr class="my-3 border-slate-300">')
                        )}
                        ${renderSection("Synonyms and Antonyms", "arrow-right-left", `
                            <div>
                               <h5 class="font-semibold">Synonyms:</h5>
                               <div class="flex flex-wrap gap-2 mt-2">${data.synonyms.map(s => `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full clickable-word">${s}</span>`).join('')}</div>
                            </div>
                            <div class="mt-4">
                               <h5 class="font-semibold">Antonyms:</h5>
                               <div class="flex flex-wrap gap-2 mt-2">${data.antonyms.map(a => `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full clickable-word">${a}</span>`).join('')}</div>
                            </div>
                        `)}
                        ${renderSection("AI Scenario Learning", "message-circle", `
                            <div class="bg-slate-200 p-4 rounded-lg space-y-3">
                                ${data.dialogue.map(d => `
                                    <div class="border-b border-slate-300 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0">
                                        <div class="flex justify-between items-start gap-2">
                                            <div class="flex-grow">
                                                <p><span class="font-bold text-blue-600">${d.speaker}:</span> ${addClickToSearch(d.line)}</p>
                                                <p class="text-sm text-gray-500 pl-4">${d.translation}</p>
                                            </div>
                                            <div class="flex items-center flex-shrink-0 gap-1 mt-1">
                                                <button class="icon-btn" onclick="speak('${d.line.replace(/'/g, "\\'")}', 'en-US')">
                                                    ${createVolumeIcon('w-5 h-5')}
                                                    <span class="tooltip">Listen (English)</span>
                                                </button>
                                                <button class="icon-btn" onclick="speak('${d.translation.replace(/'/g, "\\'")}', 'ko-KR')">
                                                    ${createVolumeIcon('w-5 h-5')}
                                                    <span class="tooltip">Listen (Korean)</span>
                                                </button>
                                                <button class="icon-btn" onclick="saveSentence('${d.line.replace(/'/g, "\\'")}', '${d.translation.replace(/'/g, "\\'")}')">
                                                    ${createSaveIcon('w-5 h-5')}
                                                    <span class="tooltip">Save</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `)}
                        ${renderQuiz("4-Choice Quiz", "swords", data.quiz)}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            safeCreateIcons();
        }
        
        function renderSection(title, icon, content) {
            return `
                <div class="border-t border-slate-300 pt-4">
                    <h4 class="text-xl font-semibold mb-3 flex items-center"><i data-lucide="${icon}" class="w-5 h-5 mr-2"></i>${title}</h4>
                    <div>${content}</div>
                </div>
            `;
        }
        
        function renderQuiz(title, icon, quizData) {
            const quizContent = quizData.map((q, index) => {
                const optionsHtml = q.options.map(option => `
                    <label class="block">
                        <input type="radio" name="quiz-${index}" value="${option}" class="mr-2">
                        ${option}
                    </label>
                `).join('');
                return `
                    <div class="mt-4 bg-slate-200 p-4 rounded-lg" id="quiz-container-${index}">
                        <p class="font-semibold">${index + 1}. ${q.question}</p>
                        <div class="my-2 space-y-1">${optionsHtml}</div>
                        <button onclick="checkQuizAnswer(this, ${index}, '${q.answer.replace(/'/g, "\\'")}')" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 quiz-button">Check Answer</button>
                        <div id="quiz-explanation-${index}" class="hidden mt-2 p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
                           <p><strong class="font-bold">Answer: ${q.answer}</strong></p>
                           <p>${q.explanation}</p>
                        </div>
                    </div>
                `;
            }).join('');

            return renderSection(title, icon, quizContent);
        }
        
        // ---------------------------
        // 4. UI/UX and Utility Functions
        // ---------------------------
        
        // --- NEW: Custom Icon functions for Neumorphism styling ---
        function createVolumeIcon(size = 'w-5 h-5') {
            // Volume-2 Lucide SVG (filter for 3D texture is handled in CSS)
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-blue-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
        }
        
        function createSaveIcon(size = 'w-5 h-5') {
            // Save Lucide SVG
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-green-600"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>`;
        }
        // --- END NEW ---

        window.checkQuizAnswer = function(button, index, correctAnswer) {
            const container = button.closest(`#quiz-container-${index}`);
            const selected = container.querySelector(`input[name="quiz-${index}"]:checked`);
            if (!selected) {
                showToast("Please select an answer.", "warning");
                return;
            }
            if (selected.value === correctAnswer) {
                selected.parentElement.classList.add('text-green-600', 'font-bold');
                showToast("Correct!", "success");
            } else {
                selected.parentElement.classList.add('text-red-600', 'font-bold');
                showToast("Incorrect. Try again.", "error");
            }
            container.querySelector(`#quiz-explanation-${index}`).classList.remove('hidden');
        }

        function showLoader(progress, text) {
            loadingContainer.classList.remove('hidden');
            progressBar.style.width = `${progress}%`;
            loadingText.textContent = text;
        }

        function updateLoader(progress, text) {
            progressBar.style.width = `${progress}%`;
            loadingText.textContent = text;
        }

        function hideLoader() {
            loadingContainer.classList.add('hidden');
        }

        function addClickToSearch(text) {
            if(!text) return '';
            return text.replace(/\b[a-zA-Z]{2,}\b/g, (match) => `<span class="clickable-word">${match}</span>`);
        }

        window.speak = function(text, lang = 'en-US') {
            if (!('speechSynthesis' in window)) {
                showToast("Your browser does not support speech synthesis.", "warning");
                return;
            }
            if (!text) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            speechSynthesis.speak(utterance);
        }

        function showToast(message, type = "info") {
            const toast = document.getElementById('toast-container');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;

            toast.className = 'toast show fixed bottom-24 right-5 text-white px-6 py-3 rounded-lg shadow-lg';
            if (type === 'success') toast.classList.add('bg-green-600');
            else if (type === 'error') toast.classList.add('bg-red-600');
            else if (type === 'warning') toast.classList.add('bg-yellow-500');
            else toast.classList.add('bg-gray-800');
            
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
        
        // ---------------------------
        // 5. Modal and Tooltip Functions
        // ---------------------------
        
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const imageModalContainer = document.getElementById('image-modal-container');
        const modalImage = document.getElementById('modal-image');
        const wordTooltip = document.getElementById('word-tooltip');
        const fileModalContainer = document.getElementById('file-modal-container');
        let confirmCallback = null;
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');


        window.showImageModal = function(src) {
            modalImage.src = src;
            imageModalContainer.classList.remove('hidden');
            imageModalContainer.classList.add('flex');
            safeCreateIcons();
        }

        window.hideImageModal = function() {
            imageModalContainer.classList.add('hidden');
            imageModalContainer.classList.remove('flex');
            modalImage.src = ''; 
        }

        // Modified encyclopedia section rendering function to handle null/undefined content
        function renderEncyclopediaSection(title, content_en, content_ko) {
            // Null/undefined check and replace with an empty string
            const safe_content_en = content_en || '';
            const safe_content_ko = content_ko || '';

            if (!safe_content_en && !safe_content_ko) return '';
            
            return `
                <div class="mt-6">
                    <h4 class="text-xl font-bold mb-2">${title}</h4>
                    <div class="prose max-w-none text-justify space-y-4">
                        <p class="text-gray-700">${safe_content_ko.replace(/\n/g, '<br>')}</p>
                        <details class="text-sm">
                            <summary class="cursor-pointer text-gray-500">View original English text</summary>
                            <p class="mt-2 text-gray-600">${addClickToSearch(safe_content_en.replace(/\n/g, '<br>'))}</p>
                        </details>
                    </div>
                </div>
            `;
        }
        
        function getEncyclopediaHtml(data) {
             return `
                <div class="print-section">
                    <h3 class="text-2xl font-bold mb-4">Encyclopedic Deep Dive</h3>
                    ${renderEncyclopediaSection('Introduction', data.introduction, data.introduction_ko)}
                    ${renderEncyclopediaSection('Etymology', data.etymology, data.etymology_ko)}
                    ${renderEncyclopediaSection('Historical Background', data.history, data.history_ko)}
                    ${renderEncyclopediaSection('Usage', data.usage, data.usage_ko)}
                </div>
            `;
        }

        function showEncyclopedia(data) {
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Encyclopedic Description</h3>
                    <button onclick="hideModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
                </div>
                <div id="encyclopedia-content">
                    ${renderEncyclopediaSection('Introduction', data.introduction, data.introduction_ko)}
                    ${renderEncyclopediaSection('Etymology', data.etymology, data.etymology_ko)}
                    ${renderEncyclopediaSection('Historical Background', data.history, data.history_ko)}
                    ${renderEncyclopediaSection('Usage', data.usage, data.usage_ko)}
                </div>
            `;
            
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            safeCreateIcons();
        }
        
        function getConceptTreeHtml(data) {
            const createList = (title, items) => {
                if (!items || items.length === 0) return '';
                // Print-friendly style (remove background color and click effects)
                const itemsHtml = items.map(item => `<span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full">${item}</span>`).join('');
                return `<div><h4 class="font-semibold text-lg mt-4">${title}</h4><div class="flex flex-wrap gap-2 mt-2">${itemsHtml}</div></div>`
            };
            return `
                <div class="print-section mt-8">
                    <h3 class="text-2xl font-bold mb-4">Concept Tree</h3>
                    ${createList('Superordinate Concepts', data.superordinate)}
                    ${createList('Coordinate Concepts', data.coordinate)}
                    ${createList('Subordinate Concepts', data.subordinate)}
                </div>
            `;
        }

        function showConceptTree(data) {
            const createList = (title, items) => {
                if (!items || items.length === 0) return '';
                return `<div><h4 class="font-semibold text-lg mt-4">${title}</h4><div class="flex flex-wrap gap-2 mt-2">${items.map(item => `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full clickable-word">${item}</span>`).join('')}</div></div>`
            };
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Concept Tree</h3>
                    <button onclick="hideModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
                </div>
                <div id="concept-tree-content">
                    ${createList('Superordinate Concepts', data.superordinate)}
                    ${createList('Coordinate Concepts', data.coordinate)}
                    ${createList('Subordinate Concepts', data.subordinate)}
                </div>
            `;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            safeCreateIcons();
        }

        window.hideModal = function(event) {
            if (event && event.currentTarget !== event.target) return;
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
        }

        window.showFileModal = function() {
            fileModalContainer.classList.remove('hidden');
            fileModalContainer.classList.add('flex');
        }

        window.hideFileModal = function(event) {
            if (event && event.currentTarget !== event.target && !event.target.closest('button')) return;
            fileModalContainer.classList.add('hidden');
            fileModalContainer.classList.remove('flex');
        }

        function showConfirmationModal(message, onConfirm) {
            confirmationMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
            confirmCallback = null;
        }

        confirmOkBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmationModal();
        });

        confirmCancelBtn.addEventListener('click', hideConfirmationModal);
        
        // ---------------------------
        // 6. Firestore Data Management
        // ---------------------------
        
        async function addWordToHistory(word, meaning) {
            if (!db || !userId) return;
            const wordRef = doc(db, `artifacts/${appId}/users/${userId}/saved_words/${word}`);
            try {
                await setDoc(wordRef, { word, meaning, timestamp: new Date(), read: false }, { merge: true });
            } catch(e){
                console.error("Error adding word to history: ", e);
            }
        }
        
        window.saveSentence = async function(en, ko) {
            if (!db || !userId) {
                showToast("Not connected to the database.", "error");
                return;
            }
            try {
                const sentenceRef = collection(db, `artifacts/${appId}/users/${userId}/saved_sentences`);
                await addDoc(sentenceRef, { en, ko, timestamp: new Date(), read: false });
                showToast("Example sentence saved.", "success");
            } catch (e) {
                console.error("Error saving sentence: ", e);
                showToast("Failed to save the example sentence.", "error");
            }
        }
        
        function loadUserLists() {
            if (!db || !userId) return;

            const wordsQuery = collection(db, `artifacts/${appId}/users/${userId}/saved_words`);
            onSnapshot(wordsQuery, (snapshot) => {
                savedWords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(currentListType === 'words') renderList();
            }, (error) => console.error("Error loading words:", error));

            const sentencesQuery = collection(db, `artifacts/${appId}/users/${userId}/saved_sentences`);
            onSnapshot(sentencesQuery, (snapshot) => {
                savedSentences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(currentListType === 'sentences') renderList();
            }, (error) => console.error("Error loading sentences:", error));
        }

        // ---------------------------
        // 7. Saved List Modal UI
        // ---------------------------
        
        const listModalContainer = document.getElementById('list-modal-container');
        const listModalTitle = document.getElementById('list-modal-title');
        const listModalContent = document.getElementById('list-modal-content');
        const sortOptions = document.getElementById('sort-options');
        const markReadBtn = document.getElementById('mark-read-btn');
        const markUnreadBtn = document.getElementById('mark-unread-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        
        let currentListType = '';
        let currentSort = 'newest';
        
        function showListModal(type) {
            currentListType = type;
            listModalContainer.classList.remove('hidden');
            listModalContainer.classList.add('flex');
            
            if (type === 'words') {
                listModalTitle.textContent = 'Word List (Search History)';
                sortOptions.innerHTML = `
                    <option value="newest">Newest First</option>
                    <option value="alphabetical">Alphabetical</option>
                `;
            } else {
                listModalTitle.textContent = 'Saved Sentences List';
                sortOptions.innerHTML = `
                    <option value="newest">Newest First</option>
                    <option value="length">By Length</option>
                `;
            }
            sortOptions.value = currentSort;
            renderList();
            updateListActionButtonsState();
        }

        function renderList() {
            let items = currentListType === 'words' ? [...savedWords] : [...savedSentences];

            items.sort((a, b) => {
                if (!a.timestamp || !b.timestamp) return 0;
                const timeA = a.timestamp.toMillis ? a.timestamp.toMillis() : new Date(a.timestamp).getTime();
                const timeB = b.timestamp.toMillis ? b.timestamp.toMillis() : new Date(b.timestamp).getTime();
                return timeB - timeA;
            });

            if (currentSort === 'alphabetical' && currentListType === 'words') {
                items.sort((a, b) => a.word.localeCompare(b.word));
            } else if (currentSort === 'length' && currentListType === 'sentences') {
                items.sort((a, b) => a.en.length - b.en.length);
            }
            
            if (items.length === 0) {
                listModalContent.innerHTML = `<p class="text-center text-gray-500">No saved items found.</p>`;
                return;
            }

            listModalContent.innerHTML = items.map(item => {
                const readClass = item.read ? 'opacity-50' : '';
                const baseHtml = `
                    <div class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-200 ${readClass}" data-id="${item.id}">
                        <div class="flex items-center flex-grow min-w-0">
                            <input type="checkbox" class="mr-4 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 item-checkbox" data-id="${item.id}">
                            <div class="flex-grow min-w-0">
                `;

                if (currentListType === 'words') {
                    return baseHtml + `
                                <p class="font-bold text-lg searchable-list-item cursor-pointer hover:underline" data-word="${item.word}">${item.word}</p>
                                <p class="truncate">${item.meaning}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button onclick="toggleReadStatus('${item.id}', 'words')" class="icon-btn">${item.read ? createEyeOffIcon() : createEyeIcon()} <span class="tooltip">${item.read ? 'Mark as Unread' : 'Mark as Read'}</span></button>
                            <button onclick="deleteListItem('${item.id}', 'words')" class="icon-btn text-red-500 hover:bg-red-100">${createTrashIcon()}<span class="tooltip">Delete</span></button>
                        </div>
                    </div>
                    `;
                } else { // sentences
                    return baseHtml + `
                            <div class="truncate">
                                <p class="font-semibold truncate">${addClickToSearch(item.en)}</p>
                                <p class="text-sm truncate">${item.ko}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <button class="icon-btn" onclick="speak('${item.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">Listen (English)</span></button>
                       <button onclick="toggleReadStatus('${item.id}', 'sentences')" class="icon-btn">${item.read ? createEyeOffIcon() : createEyeIcon()}<span class="tooltip">${item.read ? 'Mark as Unread' : 'Mark as Read'}</span></button>
                       <button onclick="deleteListItem('${item.id}', 'sentences')" class="icon-btn text-red-500 hover:bg-red-100">${createTrashIcon()}<span class="tooltip">Delete</span></button>
                    </div>
                    </div>
                    `;
                }
            }).join('<hr class="my-1 border-slate-300">');
            
            safeCreateIcons();
        }

        // --- NEW: Icon functions for list rendering ---
        function createEyeIcon(size = 'w-5 h-5') {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-gray-500"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        }
        function createEyeOffIcon(size = 'w-5 h-5') {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-gray-500"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.16 13.16 0 0 0 2 12s3 7 10 7a9.92 9.92 0 0 0 5.43-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>`;
        }
        function createTrashIcon(size = 'w-5 h-5') {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-red-500"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"></path></svg>`;
        }
        // --- END NEW ---
        
        window.deleteListItem = function(id, type) {
            showConfirmationModal("Are you sure you want to delete this item?", async () => {
                if (!db || !userId) return;
                const collectionName = type === 'words' ? 'saved_words' : 'saved_sentences';
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${id}`);
                try {
                    await deleteDoc(docRef);
                    showToast("Deleted successfully.", "success");
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showToast("Failed to delete.", "error");
                }
            });
        }
        
        window.toggleReadStatus = async function(id, type) {
            if (!db || !userId) return;
            const collectionName = type === 'words' ? 'saved_words' : 'saved_sentences';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${id}`);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().read;
                    await updateDoc(docRef, { read: !currentStatus });
                }
            } catch (error) {
                console.error("Error toggling read status:", error);
                showToast("Failed to change status.", "error");
            }
        };
        
        function updateListActionButtonsState() {
            const checkedItems = listModalContent.querySelectorAll('.item-checkbox:checked');
            const hasSelection = checkedItems.length > 0;
            markReadBtn.disabled = !hasSelection;
            markUnreadBtn.disabled = !hasSelection;
            deleteSelectedBtn.disabled = !hasSelection;
        }

        listModalContent.addEventListener('change', (e) => {
            if (e.target.classList.contains('item-checkbox')) {
                updateListActionButtonsState();
            }
        });

        async function performBulkAction(action) {
            const checkedItems = listModalContent.querySelectorAll('.item-checkbox:checked');
            if (checkedItems.length === 0) {
                showToast("Please select items.", "warning");
                return;
            }
            
            const actionText = action === 'delete' ? 'delete' : 'change the status of';
            showConfirmationModal(`Are you sure you want to ${actionText} the selected ${checkedItems.length} items?`, async () => {
                if (!db || !userId) return;
                const batch = writeBatch(db);
                const collectionName = currentListType === 'words' ? 'saved_words' : 'saved_sentences';
                
                checkedItems.forEach(item => {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${item.dataset.id}`);
                    if (action === 'delete') {
                        batch.delete(docRef);
                    } else {
                        batch.update(docRef, { read: action === 'mark-read' });
                    }
                });

                try {
                    await batch.commit();
                    showToast("The selected items have been processed.", "success");
                } catch (error) {
                    console.error("Bulk action failed:", error);
                    showToast("The operation failed.", "error");
                }
            });
        }
        
        window.hideListModal = function(event) {
            if(event) {
                if (event.currentTarget !== event.target && !event.target.closest('button')) return;
            }
            listModalContainer.classList.add('hidden');
            listModalContainer.classList.remove('flex');
        }
        
        // ---------------------------
        // 8. Tab & Print Management
        // ---------------------------

        function addTab(query, makeActive = true) {
            const tabId = `tab-${++tabCounter}`;
            const tabBar = document.getElementById('tab-bar');
            const tabContentContainer = document.getElementById('tab-content-container');

            const tabButton = document.createElement('button');
            tabButton.id = `tab-btn-${tabId}`;
            tabButton.className = 'px-4 py-2 -mb-px border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-400 flex items-center';
            tabButton.dataset.tabId = tabId;
            tabButton.innerHTML = `
                <span class="tab-title">${query.length > 10 ? query.substring(0, 10) + '...' : query}</span>
                <span class="close-tab-btn ml-2 hover:bg-red-200 rounded-full w-4 h-4 flex items-center justify-center text-xs font-bold">&times;</span>
            `;
            tabBar.appendChild(tabButton);
            
            const tabContent = document.createElement('div');
            tabContent.id = `tab-content-${tabId}`;
            tabContent.className = 'space-y-8';
            tabContentContainer.appendChild(tabContent);

            tabs[tabId] = { id: tabId, query, contentEl: tabContent, buttonEl: tabButton, searchId: 0, fullSearchResult: null };

            tabButton.addEventListener('click', () => switchTab(tabId));
            tabButton.querySelector('.close-tab-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });

            if (makeActive) {
                switchTab(tabId);
            }

            return tabId;
        }

        function switchTab(tabId) {
            if (!tabs[tabId]) return;
            activeTabId = tabId;
            
            for (const id in tabs) {
                tabs[id].buttonEl.classList.remove('border-blue-500', 'text-gray-900', 'font-semibold');
                tabs[id].buttonEl.classList.add('border-transparent', 'text-gray-500');
                tabs[id].contentEl.classList.add('hidden');
            }
            
            tabs[tabId].buttonEl.classList.add('border-blue-500', 'text-gray-900', 'font-semibold');
            tabs[tabId].buttonEl.classList.remove('border-transparent', 'text-gray-500');
            tabs[tabId].contentEl.classList.remove('hidden');
        }

        function closeTab(tabId) {
            if (!tabs[tabId]) return;

            tabs[tabId].buttonEl.remove();
            tabs[tabId].contentEl.remove();
            delete tabs[tabId];

            if (activeTabId === tabId) {
                const remainingTabIds = Object.keys(tabs);
                if (remainingTabIds.length > 0) {
                    switchTab(remainingTabIds[remainingTabIds.length - 1]);
                } else {
                    activeTabId = null;
                }
            }
        }

        function handlePrint(tabId) {
            const tab = tabs[tabId];
            if (!tab || !tab.fullSearchResult || !tab.fullSearchResult.encyclopediaData || !tab.fullSearchResult.fastDeepDiveData) {
                showToast("Print data is not yet ready. Please wait for all information to load.", "warning");
                return;
            }
            
            // 1. Prepare all content to be printed as an HTML string.
            const mainContentHtml = tab.contentEl.innerHTML;
            const encyclopediaHtml = getEncyclopediaHtml(tab.fullSearchResult.encyclopediaData.encyclopedia);
            const conceptTreeHtml = getConceptTreeHtml(tab.fullSearchResult.fastDeepDiveData.conceptTree);
            
            // 2. Combine all content in a temporary print container.
            printContentArea.innerHTML = mainContentHtml + encyclopediaHtml + conceptTreeHtml;

            // 3. Execute printing.
            printContainer.style.display = 'block'; // Make the print container visible to set it as the print target.
            
            // 4. Rerender Lucide icons inside the print container to include them in the print content.
            if (window.lucide) {
                printContainer.querySelectorAll('[data-lucide]').forEach(el => el.remove());
                window.lucide.createIcons({ attr: 'data-lucide', element: printContainer });
            }

            // 5. Execute printing.
            window.print();
            
            // 6. Clean up after printing: hide the temporary container and clear its content.
            setTimeout(() => {
                printContainer.style.display = 'none';
                printContentArea.innerHTML = '';
            }, 500); 
        }

        // ---------------------------
        // 9. File Storage
        // ---------------------------
        const fileUploadInput = document.getElementById('file-upload-input');
        const fileUploadButton = document.getElementById('file-upload-button');
        
        fileUploadButton.addEventListener('click', () => {
            if (!auth || !auth.currentUser) {
                showToast("Not connected to Firebase. Please check your configuration.", "error");
                return;
            }
             // --- NEW: Add detailed auth logging for debugging ---
            console.log("Attempting file upload. Current user object:", auth.currentUser);
            console.log("User ID being used for path:", userId);
            console.log("App ID being used for path:", appId);
            // --- END NEW ---

            const file = fileUploadInput.files[0];
            if (!file) {
                showToast("Please select a file.", "warning");
                return;
            }

            if (file.size > 50 * 1024 * 1024) { // 50MB
                showToast("File size cannot exceed 50MB.", "error");
                return;
            }
            
            // Firebase Storage path: artifacts/{appId}/users/{userId}/files/{file.name}
            const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/files/${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);
            const uploadProgressContainer = document.getElementById('upload-progress-container');
            const uploadProgressBar = document.getElementById('upload-progress-bar');
            
            // UI for upload start
            uploadProgressContainer.classList.remove('hidden');
            fileUploadButton.disabled = true;

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                }, 
                // --- FIX: Enhanced error handling ---
                (error) => {
                    console.error("Upload failed. Firebase Error Code:", error.code);
                    console.error("Full Error:", error);
                    showToast(`File upload failed. (${error.code})`, "error");
                    
                    // Reset UI
                    uploadProgressContainer.classList.add('hidden');
                    uploadProgressBar.style.width = '0%';
                    fileUploadButton.disabled = false;
                }, 
                // --- On successful upload ---
                async () => {
                    let firestoreError = null;
                    try {
                        const metadata = uploadTask.snapshot.metadata;
                        // Firestore path: artifacts/{appId}/users/{userId}/file_metadata/{docId}
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/file_metadata`), {
                            name: metadata.name,
                            fullPath: metadata.fullPath,
                            size: metadata.size,
                            contentType: metadata.contentType,
                            timestamp: new Date()
                        });
                        
                    } catch (error) {
                        firestoreError = error;
                        console.error("CRITICAL: Error saving file metadata to Firestore:", error.code, error.message);
                        showToast(`Failed to save file information: ${error.code}`, "error");
                        // If metadata saving fails, attempt to delete the file from Storage (cleanup).
                        await deleteObject(uploadTask.snapshot.ref).catch(err => console.error("Orphaned file cleanup failed:", err));
                        
                    } finally {
                        // Reset UI
                        uploadProgressContainer.classList.add('hidden');
                        uploadProgressBar.style.width = '0%';
                        fileUploadInput.value = '';
                        fileUploadButton.disabled = false;
                        if (!firestoreError) {
                            showToast("File uploaded successfully.", "success");
                        }
                    }
                }
            );
        });

        function listenForFiles() {
            if (!db || !userId) return;
            const filesQuery = collection(db, `artifacts/${appId}/users/${userId}/file_metadata`);
            onSnapshot(filesQuery, (snapshot) => {
                const files = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFileList(files);
            }, (error) => {
                console.error("Error listening for files:", error);
                const fileListDiv = document.getElementById('file-list');
                fileListDiv.innerHTML = '<p class="text-center text-red-500">Failed to load file list.</p>';
            });
        }

        function renderFileList(files) {
            const fileListDiv = document.getElementById('file-list');
            if (files.length === 0) {
                fileListDiv.innerHTML = '<p class="text-center text-gray-500">No uploaded files.</p>';
                return;
            }
            fileListDiv.innerHTML = '';
            files.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            files.forEach(fileData => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-slate-200';
                fileElement.innerHTML = `
                    <div class="truncate">
                        <p class="font-semibold truncate">${fileData.name}</p>
                        <p class="text-sm text-gray-500">${(fileData.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <button class="icon-btn" onclick="downloadFile('${fileData.fullPath}')">${createDownloadIcon()}</button>
                        <button class="icon-btn text-red-500" onclick="deleteFile('${fileData.id}', '${fileData.fullPath}')">${createTrashIcon()}</button>
                    </div>
                `;
                fileListDiv.appendChild(fileElement);
            });
            safeCreateIcons();
        }

        // --- NEW: Icon functions for file list buttons ---
        function createDownloadIcon(size = 'w-5 h-5') {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-blue-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>`;
        }
        // --- END NEW ---
        
        window.downloadFile = function(fullPath) {
            getDownloadURL(ref(storage, fullPath))
                .then((url) => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.target = '_blank';
                    a.click();
                })
                .catch((error) => {
                    console.error("Error getting download URL:", error);
                    showToast("Failed to download file.", "error");
                });
        }

        window.deleteFile = function(docId, fullPath) {
            showConfirmationModal("Are you sure you want to delete this file?", async () => {
                const fileRef = ref(storage, fullPath);
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/file_metadata/${docId}`);
                try {
                    await deleteObject(fileRef);
                    await deleteDoc(docRef);
                    showToast("File deleted.", "success");
                } catch (error) {
                    console.error("Error deleting file:", error);
                    if (error.code === 'storage/object-not-found') {
                        try {
                            await deleteDoc(docRef);
                            showToast("File information cleaned up.", "info");
                        } catch (dbError) {
                            console.error("Error deleting orphaned metadata:", dbError);
                            showToast("Failed to delete file.", "error");
                        }
                    } else {
                        showToast("Failed to delete file.", "error");
                    }
                }
            });
        }
        
        // ---------------------------
        // 10. Advanced AI Interactions
        // ---------------------------

        window.expandStory = async function(button, word, story, story_ko) {
            button.disabled = true;
            button.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block animate-spin"></div>`;
            try {
                const prompt = `You are a creative storyteller. Expand the following short, humorous story about the word "${word}" into a more detailed and engaging narrative of 3-4 paragraphs. Keep the funny and lighthearted tone.\n\nOriginal Story (English): "${story}"\nOriginal Story (Korean): "${story_ko}"\n\nPlease provide the expanded story in both English and Korean. Format your response as a JSON object with "expanded_story_en" and "expanded_story_ko" keys.`;
                const result = await callGemini(prompt, true);
                
                const episodeCard = button.closest('.card');
                const storyContainer = episodeCard.querySelector('.space-y-2');
                storyContainer.innerHTML = `
                    <p class="text-lg leading-relaxed">${addClickToSearch(result.expanded_story_en)}</p>
                    <p class="text-md leading-relaxed text-gray-600 mt-2">${result.expanded_story_ko}</p>
                `;
                button.remove(); // Remove button after expansion
            } catch (error) {
                console.error("Failed to expand story:", error);
                showToast("Failed to expand the story.", "error");
                button.disabled = false;
                button.innerHTML = `✨ Create More Story`;
            }
        }
        
        window.craftSentences = async function(button, word) {
            const contextInput = button.parentElement.querySelector('#sentence-context-input');
            const context = contextInput.value.trim();
            if (!context) {
                showToast("Please enter a situation.", "warning");
                return;
            }
            
            const resultsContainer = button.parentElement.parentElement.querySelector('#sentence-crafter-results');
            resultsContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            button.disabled = true;

            try {
                const prompt = `Create 3 example English sentences using the word "${word}" in the context of "${context}". For each sentence, provide a Korean translation. Return the result as a JSON array like this: [{"en": "Sentence 1.", "ko": "Translation 1."}, {"en": "Sentence 2.", "ko": "Translation 2."}]`;
                const sentences = await callGemini(prompt, true);
                
                const sentencesHtml = sentences.map((s, i) => `
                    <li class="flex items-start justify-between gap-3 mt-2">
                        <div class="flex items-start">
                            <span class="text-gray-500 mr-2">${i + 1}.</span>
                            <div>
                                <p class="text-md font-medium">${addClickToSearch(s.en)}</p>
                                <p class="text-sm text-gray-500">${s.ko}</p>
                            </div>
                        </div>
                        <div class="flex items-center flex-shrink-0 gap-1">
                            <button class="icon-btn" onclick="speak('${s.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">Listen (English)</span></button>
                            <button class="icon-btn" onclick="speak('${s.ko.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">Listen (Korean)</span></button>
                            <button class="icon-btn" onclick="saveSentence('${s.en.replace(/'/g, "\\'")}', '${s.ko.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">Save</span></button>
                        </div>
                    </li>
                `).join('');
                resultsContainer.innerHTML = `<ul class="list-inside space-y-2">${sentencesHtml}</ul>`;
                safeCreateIcons();

            } catch(error) {
                console.error("Failed to craft sentences:", error);
                resultsContainer.innerHTML = `<p class="text-red-500">Failed to generate sentences.</p>`;
                showToast("Failed to generate sentences.", "error");
            } finally {
                button.disabled = false;
            }
        }
        
        // ---------------------------
        // 11. Initializers and Event Listeners
        // ---------------------------
        
        function safeCreateIcons() {
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }
        
        async function translateWordOnHover(word) {
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") { 
                return "AI Key Not Set";
            }
            if (translationCache[word]) {
                return translationCache[word];
            }
            try {
                const prompt = `Translate the English word "${word}" to Korean. Provide only the most common meaning.`;
                const translation = await callGemini(prompt);
                translationCache[word] = translation.trim();
                return translationCache[word];
            } catch (error) {
                console.error("Translation on hover failed:", error);
                return "Translation Failed";
            }
        }
        
        document.addEventListener('mouseover', async (e) => {
            if (e.target.classList.contains('clickable-word')) {
                const word = e.target.textContent.trim().replace(/[^a-zA-Z-]/g, '');
                if (!word) return;

                const translation = await translateWordOnHover(word);
                wordTooltip.textContent = translation;
                wordTooltip.classList.remove('hidden');

                const rect = e.target.getBoundingClientRect();
                wordTooltip.style.left = `${rect.left + window.scrollX + rect.width / 2 - wordTooltip.offsetWidth / 2}px`;
                wordTooltip.style.top = `${rect.top + window.scrollY - wordTooltip.offsetHeight - 5}px`;
            }
        });

        document.addEventListener('mouseout', (e) => {
            if (e.target.classList.contains('clickable-word')) {
                wordTooltip.classList.add('hidden');
            }
        });
        
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('clickable-word')) {
                const word = e.target.textContent.trim().replace(/[^a-zA-Z-]/g, '');
                if (word) {
                    searchInput.value = word;
                    handleSearch(word);
                    hideListModal();
                }
            }
            if (e.target.closest('.searchable-list-item')) {
                 const word = e.target.closest('.searchable-list-item').dataset.word;
                if(word) {
                    searchInput.value = word;
                    handleSearch(word);
                    hideListModal();
                }
            }
        });
        
        searchButton.addEventListener('click', () => handleSearch(searchInput.value.trim()));
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleSearch(searchInput.value.trim());
            }
        });
        
        document.getElementById('word-list-btn').addEventListener('click', () => showListModal('words'));
        document.getElementById('sentence-list-btn').addEventListener('click', () => showListModal('sentences'));
        document.getElementById('file-storage-btn').addEventListener('click', showFileModal);
        
        document.getElementById('share-btn').addEventListener('click', () => {
            if(navigator.share) {
                navigator.share({
                    title: 'AI Vocabulary Builder',
                    text: 'Learn new words with AI!',
                    url: window.location.href
                }).catch(err => console.error("Share failed", err));
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast("Link copied to clipboard.", "success");
            }
        });
        
        sortOptions.addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderList();
        });

        markReadBtn.addEventListener('click', () => performBulkAction('mark-read'));
        markUnreadBtn.addEventListener('click', () => performBulkAction('mark-unread'));
        deleteSelectedBtn.addEventListener('click', () => performBulkAction('delete'));
        

        // App Initialization
        document.addEventListener('DOMContentLoaded', initializeFirebase);

    </script>
</body>
</html>



