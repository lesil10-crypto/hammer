<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ìŒì„± ê¸°ë¡ ë° ìš”ì•½ (v2)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ (Tailwind ê¸°ë³¸ í°íŠ¸) -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        /* Tailwind ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        html {
            font-family: 'Inter', sans-serif;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* íŒŒì¼ ì…ë ¥ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì»¤ìŠ¤í…€ ë²„íŠ¼ ì‚¬ìš©) */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 md:p-8">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-900">ì‹¤ì‹œê°„ ìŒì„± ê¸°ë¡ ë° ìš”ì•½</h1>
            <p class="text-gray-600 mt-2">ë§ˆì´í¬ë¥¼ í†µí•´ ë§í•˜ë©´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ë˜ê³ , 'ìš”ì•½í•˜ê¸°' ë²„íŠ¼ìœ¼ë¡œ ë‚´ìš©ì„ ìš”ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </header>

        <main>
            <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ë° ìƒíƒœ -->
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                <button id="recordBtn" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    <span>ë…¹ìŒ ì‹œì‘</span>
                </button>
                <div id="status" class="text-gray-700 font-medium">ëŒ€ê¸° ì¤‘ ğŸ™ï¸</div>
            </div>

            <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
            <div class="text-center mb-6 border-t border-b border-gray-200 py-4">
                <label for="audioFileInput" class="cursor-pointer w-full sm:w-auto px-6 py-2 bg-purple-600 text-white font-medium rounded-lg shadow-sm hover:bg-purple-700 transition-colors">
                    ìŒì„± íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (ë³€í™˜)
                </label>
                <input type="file" id="audioFileInput" accept="audio/*">
                <p id="audioFileName" class="text-sm text-gray-500 mt-2"></p>
                <div id="transcribeLoading" class="hidden flex items-center justify-center mt-2">
                    <div class="loader w-6 h-6 border-4 border-gray-200 rounded-full"></div>
                    <span class="ml-2 text-gray-600">ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ ì¤‘... (íŒŒì¼ í¬ê¸°ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</span>
                </div>
            </div>


            <!-- ê²°ê³¼ ì˜ì—­: ë°›ì•„ì“°ê¸° ë° ìš”ì•½ -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- ë°›ì•„ì“°ê¸° ì˜ì—­ -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold mb-3">ë³€í™˜ëœ í…ìŠ¤íŠ¸</h2>
                    <div id="transcriptBox" class="w-full h-64 p-3 bg-white border border-gray-300 rounded-md overflow-y-auto" contenteditable="true">
                        <span id="final-transcript" class="text-gray-800"></span>
                        <span id="interim-transcript" class="text-gray-500"></span>
                    </div>
                    <button id="copyTranscriptBtn" class="mt-3 w-full px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 transition-colors">
                        í…ìŠ¤íŠ¸ ë³µì‚¬
                    </button>
                </div>

                <!-- ìš”ì•½ ì˜ì—­ -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold mb-3">AI ìš”ì•½</h2>
                    <button id="summarizeBtn" class="w-full px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-300 ease-in-out mb-3">
                        ìš”ì•½í•˜ê¸°
                    </button>
                    <div id="summaryLoading" class="hidden flex items-center justify-center h-48">
                        <div class="loader w-12 h-12 border-4 border-gray-200 rounded-full"></div>
                    </div>
                    <div id="summaryBox" class="w-full h-48 p-3 bg-white border border-gray-300 rounded-md overflow-y-auto">
                        <span class="text-gray-400">ìš”ì•½ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</span>
                    </div>
                    <button id="copySummaryBtn" class="mt-3 w-full px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 transition-colors">
                        ìš”ì•½ ë³µì‚¬
                    </button>
                </div>
            </div>

            <!-- ì˜¤ë””ì˜¤ ì¬ìƒ ì˜ì—­ -->
            <div id="playbackSection" class="hidden mt-6">
                <h2 class="text-xl font-semibold mb-3 text-center">ë…¹ìŒ ë‹¤ì‹œ ë“£ê¸°</h2>
                <audio id="audioPlayer" controls class="w-full"></audio>
            </div>
        </main>

        <footer class="mt-6 text-center text-sm text-gray-500">
            <p>ì°¸ê³ : Web Speech APIëŠ” Chrome ë¸Œë¼ìš°ì €ì—ì„œ ê°€ì¥ ì˜ ì‘ë™í•©ë‹ˆë‹¤.</p>
            <p id="error-log" class="text-red-500"></p>
        </footer>
    </div>

    <script>
        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const recordBtn = document.getElementById('recordBtn');
        const statusEl = document.getElementById('status');
        const finalTranscriptEl = document.getElementById('final-transcript');
        const interimTranscriptEl = document.getElementById('interim-transcript');
        const transcriptBox = document.getElementById('transcriptBox');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const summaryBox = document.getElementById('summaryBox');
        const summaryLoading = document.getElementById('summaryLoading');
        const errorLog = document.getElementById('error-log');
        const copyTranscriptBtn = document.getElementById('copyTranscriptBtn');
        const copySummaryBtn = document.getElementById('copySummaryBtn');
        const audioFileInput = document.getElementById('audioFileInput');
        const audioFileName = document.getElementById('audioFileName');
        const transcribeLoading = document.getElementById('transcribeLoading');
        const playbackSection = document.getElementById('playbackSection');
        const audioPlayer = document.getElementById('audioPlayer');

        // SpeechRecognition API ì„¤ì •
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        // MediaRecorder API ì„¤ì •
        let mediaRecorder;
        let audioChunks = [];
        let mediaStream;

        if (!SpeechRecognition) {
            statusEl.textContent = 'ì˜¤ë¥˜: ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            recordBtn.disabled = true;
            summarizeBtn.disabled = true;
        } else {
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •
            recognition.interimResults = true; // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
            recognition.continuous = true; // ê³„ì†í•´ì„œ ì¸ì‹
        }

        let isRecording = false;
        let finalTranscript = '';

        // ë…¹ìŒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // ë…¹ìŒ ì‹œì‘
        async function startRecording() {
            try {
                // 1. ë§ˆì´í¬ ì ‘ê·¼ ë° ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. ê¸°ì¡´ í…ìŠ¤íŠ¸ ë° ì˜¤ë””ì˜¤ ì´ˆê¸°í™”
                finalTranscript = transcriptBox.textContent || ''; 
                audioChunks = [];
                playbackSection.classList.add('hidden');
                audioPlayer.src = '';
                errorLog.textContent = '';
                
                // 3. ìŒì„± ì¸ì‹ (SpeechRecognition) ì„¤ì • ë° ì‹œì‘
                recognition.start();

                // 4. ì˜¤ë””ì˜¤ ë…¹ìŒ (MediaRecorder) ì„¤ì • ë° ì‹œì‘
                mediaRecorder = new MediaRecorder(mediaStream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    playbackSection.classList.remove('hidden');
                };
                
                mediaRecorder.start();

                // 5. UI ì—…ë°ì´íŠ¸
                isRecording = true;
                recordBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A11.002 11.002 0 0112 21a11.001 11.001 0 01-9-5.21M3 11.21A11.001 11.001 0 0112 3a11.001 11.001 0 019 5.21" />
                    </svg>
                    <span>ë…¹ìŒ ì¤‘ì§€</span>
                `;
                recordBtn.classList.replace('bg-blue-600', 'bg-red-600');
                recordBtn.classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
                statusEl.textContent = 'ë…¹ìŒ ì¤‘... ğŸ¤';
                
            } catch (e) {
                errorLog.textContent = `ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜: ${e.message}`;
                if (e.name === "NotAllowedError" || e.name === "PermissionDeniedError") {
                    errorLog.textContent = "ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.";
                } else {
                    errorLog.textContent = `ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜: ${e.message}`;
                }
            }
        }

        // ë…¹ìŒ ì¤‘ì§€
        function stopRecording() {
            if (recognition) recognition.stop();
            if (mediaRecorder) mediaRecorder.stop();
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop()); // ë§ˆì´í¬ ë„ê¸°
            }
            
            isRecording = false;
            recordBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
                <span>ë…¹ìŒ ì‹œì‘</span>
            `;
            recordBtn.classList.replace('bg-red-600', 'bg-blue-600');
            recordBtn.classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
            statusEl.textContent = 'ëŒ€ê¸° ì¤‘ ğŸ™ï¸';
        }

        // ìŒì„± ì¸ì‹ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        if (recognition) {
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                finalTranscriptEl.textContent = finalTranscript;
                interimTranscriptEl.textContent = interimTranscript;
                // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
                transcriptBox.scrollTop = transcriptBox.scrollHeight;
            };

            recognition.onerror = (event) => {
                let errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (event.error === 'no-speech') {
                    errorMessage = 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆì´í¬ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'ë§ˆì´í¬ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'ë§ˆì´í¬ ì‚¬ìš©ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
                }
                errorLog.textContent = `ì˜¤ë¥˜: ${errorMessage}`;
                if(isRecording) stopRecording();
            };

            // ì¸ì‹ì´ ìë™ìœ¼ë¡œ ì¢…ë£Œë˜ë©´ (ì˜ˆ: ê¸´ ì¹¨ë¬µ í›„)
            recognition.onend = () => {
                if (isRecording) {
                    // ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€í•œ ê²Œ ì•„ë‹ˆë©´, ë…¹ìŒ/ì¸ì‹ ì¬ì‹œì‘ (ìŠ¤íŠ¸ë¦¼ì€ ì´ë¯¸ í™œì„± ìƒíƒœ)
                    // Note: 'continuous' ëª¨ë“œì—ì„œëŠ” ì´ëŸ´ í•„ìš”ê°€ ì—†ì„ ìˆ˜ ìˆì§€ë§Œ, ì¼ë¶€ ë¸Œë¼ìš°ì €ì˜ íƒ€ì„ì•„ì›ƒ ëŒ€ë¹„
                    recognition.start();
                }
            };
        }
        
        // í…ìŠ¤íŠ¸ ë³µì‚¬ ë²„íŠ¼
        copyTranscriptBtn.addEventListener('click', () => {
            copyToClipboard(transcriptBox.textContent);
        });

        copySummaryBtn.addEventListener('click', () => {
            copyToClipboard(summaryBox.textContent);
        });

        function copyToClipboard(text) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy'); 
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                errorLog.textContent = 'í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }
            document.body.removeChild(tempTextArea);
        }

        // í…ìŠ¤íŠ¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        audioFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (!file.type.startsWith('audio/')) {
                errorLog.textContent = 'ì˜¤ë¥˜: ì˜¤ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                audioFileName.textContent = '';
                return;
            }

            audioFileName.textContent = `ë¶ˆëŸ¬ì˜¨ íŒŒì¼: ${file.name}`;
            errorLog.textContent = '';
            transcribeLoading.classList.remove('hidden');
            // í…ìŠ¤íŠ¸ ìƒì ë¹„ìš°ê¸°
            finalTranscriptEl.textContent = '';
            finalTranscript = '';
            interimTranscriptEl.textContent = '';
            summaryBox.innerHTML = '<span class="text-gray-400">ìš”ì•½ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</span>';


            const reader = new FileReader();
            reader.onload = async (e) => {
                const audioDataUrl = e.target.result;
                // Data URL: "data:audio/mp3;base64,..."
                // 1. MIME íƒ€ì… ì¶”ì¶œ
                const mimeType = audioDataUrl.split(';')[0].split(':')[1];
                // 2. Base64 ë°ì´í„° ì¶”ì¶œ
                const base64Data = audioDataUrl.split(',')[1];
                
                try {
                    const transcribedText = await transcribeAudioFile(base64Data, mimeType);
                    finalTranscriptEl.textContent = transcribedText;
                    finalTranscript = transcribedText;
                    // í…ìŠ¤íŠ¸ ë³€í™˜ ì™„ë£Œ í›„, ë…¹ìŒ ì¬ìƒ ì„¹ì…˜ì€ ìˆ¨ê¹€
                    playbackSection.classList.add('hidden');
                    audioPlayer.src = '';

                } catch (error) {
                    console.error('ìŒì„± íŒŒì¼ ë³€í™˜ ì˜¤ë¥˜:', error);
                    errorLog.textContent = `ìŒì„± íŒŒì¼ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                    finalTranscriptEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                } finally {
                    transcribeLoading.classList.add('hidden');
                    // Reset file input so the same file can be uploaded again
                    audioFileInput.value = null;
                }
            };
            reader.readAsDataURL(file);
        });
        
        // Gemini APIë¡œ ì˜¤ë””ì˜¤ íŒŒì¼ ë³€í™˜ (ADDED)
        async function transcribeAudioFile(base64Data, mimeType) {
            const apiKey = ""; // API í‚¤ëŠ” Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const prompt = "ë‹¤ìŒ ì˜¤ë””ì˜¤ íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•´ ì£¼ì„¸ìš”. ì˜¤ë””ì˜¤ì˜ ëª¨ë“  ë‚´ìš©ì„ ë¹ ì§ì—†ì´ í…ìŠ¤íŠ¸ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.";
            
            const payload = {
                contents: [
                    {
                        "parts": [
                            { "text": prompt },
                            {
                                "inlineData": {
                                    "mimeType": mimeType,
                                    "data": base64Data
                                }
                            }
                        ]
                    }
                ]
            };

            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API ì˜¤ë¥˜: ${response.status} ${response.statusText} - ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            } else {
                console.warn('API ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', result);
                if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                     throw new Error('ì•ˆì „ìƒì˜ ì´ìœ ë¡œ ì½˜í…ì¸ ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                throw new Error('ë³€í™˜ëœ í…ìŠ¤íŠ¸ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }


        // ìš”ì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        summarizeBtn.addEventListener('click', async () => {
            // contenteditable divì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¬ ë•Œ, span íƒœê·¸ ë‚´ë¶€ì˜ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©
            const textToSummarize = finalTranscriptEl.textContent || transcriptBox.textContent;
            
            if (!textToSummarize.trim()) {
                summaryBox.textContent = 'ìš”ì•½í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë…¹ìŒì„ ì§„í–‰í•˜ê±°ë‚˜ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.';
                return;
            }

            summaryLoading.classList.remove('hidden');
            summaryBox.innerHTML = ''; // ì´ì „ ê²°ê³¼ ì§€ìš°ê¸°
            summarizeBtn.disabled = true;

            try {
                const summary = await callGeminiApi(textToSummarize);
                summaryBox.textContent = summary;
            } catch (error) {
                console.error('ìš”ì•½ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                summaryBox.textContent = `ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
            } finally {
                summaryLoading.classList.add('hidden');
                summarizeBtn.disabled = false;
            }
        });

        // Gemini API í˜¸ì¶œ í•¨ìˆ˜ (ìš”ì•½)
        async function callGeminiApi(text) {
            const apiKey = ""; // API í‚¤ëŠ” Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "ë‹¹ì‹ ì€ ì „ë¬¸ ìš”ì•½ ë¹„ì„œì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ ì¤‘ìš”í•œ í•µì‹¬ ë‚´ìš©ë§Œ ë½‘ì•„ì„œ ê°„ê²°í•˜ê²Œ í•œêµ­ì–´ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ë¶ˆí•„ìš”í•œ ë¯¸ì‚¬ì—¬êµ¬ë‚˜ ì„œë¡ ì„ ë¹¼ê³ , ì£¼ìš” í•­ëª©ì„ ëª…í™•í•˜ê²Œ ì •ë¦¬í•©ë‹ˆë‹¤.";
            
            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API ì˜¤ë¥˜: ${response.status} ${response.statusText} - ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            } else {
                console.warn('API ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', result);
                throw new Error('ìš”ì•½ëœ í…ìŠ¤íŠ¸ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•œ fetch ì¬ì‹œë„
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                return await fetch(url, options);
            } catch (error) {
                if (retries > 0) {
                    await sleep(delay);
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

    </script>
</body>
</html>
