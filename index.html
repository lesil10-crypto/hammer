<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vocabulary Builder</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-icons@0.378.0/dist/lucide.min.js"></script>
    <!-- FirebaseUI CSS -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />
    <style>
        /* Noto Sans KR 폰트 전역 적용 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f2f5; /* 눈이 편안한 은색 배경 */
        }
        /* 입체적인 텍스처(볼록 효과) 버튼 스타일 */
        .btn-3d {
            background-color: #e0e5ec;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            color: #4a5568;
            box-shadow: 6px 6px 12px #c5c9d2, -6px -6px 12px #fdffff;
            transition: all 0.2s ease-in-out;
            outline: none;
        }
        .btn-3d:hover {
            box-shadow: 4px 4px 8px #c5c9d2, -4px -4px 8px #fdffff;
        }
        .btn-3d:active {
            box-shadow: inset 4px 4px 8px #c5c9d2, inset -4px -4px 8px #fdffff;
        }
        /* 카드 디자인 */
        .card {
            background-color: #e0e5ec;
            border-radius: 15px;
            box-shadow: 8px 8px 16px #c5c9d2, -8px -8px 16px #fdffff;
        }
        /* 클릭 투 서치 스타일 */
        .clickable-word {
            cursor: pointer;
            font-weight: 500;
            color: #2b6cb0;
            transition: color 0.2s;
            border-bottom: 1px dotted #2b6cb0;
        }
        .clickable-word:hover {
            color: #2c5282;
            background-color: #bee3f8;
        }
        /* 로딩 스피너 */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 모달 스타일 */
        .modal {
            transition: opacity 0.3s ease;
        }
        /* 토스트 메시지 스타일 */
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .clickable-image {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .clickable-image:hover {
            transform: scale(1.03);
        }
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem; /* 36px */
            height: 2.25rem; /* 36px */
            border-radius: 9999px;
            background-color: #e2e8f0;
            transition: all 0.2s;
            color: #4a5568;
            box-shadow: 3px 3px 6px #c5c9d2, -3px -3px 6px #fdffff;
            position: relative; /* For tooltip positioning */
        }
        .icon-btn:hover {
            color: #1a202c;
            box-shadow: 2px 2px 4px #c5c9d2, -2px -2px 4px #fdffff;
        }
        .icon-btn:active {
            box-shadow: inset 2px 2px 4px #c5c9d2, inset -2px -2px 4px #fdffff;
        }
        /* Tooltip styles */
        .tooltip {
            visibility: hidden;
            opacity: 0;
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the button */
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.2s;
            white-space: nowrap;
            font-size: 0.75rem;
        }
        .icon-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        @media print {
            body { background-color: #fff !important; font-family: 'Times New Roman', serif; }
            #app-container > header, .sticky, #tab-bar, footer, .modal, .toast, .tooltip, #auth-container { display: none !important; }
            #tab-content-container > div { display: none !important; }
            .active-tab-content { display: block !important; }
            #app-container { max-width: 100%; padding: 0; margin: 0; }
            .card, .btn-3d, .icon-btn { box-shadow: none; border: 1px solid #ccc; background-color: #fff !important; }
            .clickable-word { color: #000; border: none; font-weight: bold; }
            img { page-break-inside: avoid; }
            /* Hide action buttons in print view */
            .icon-btn, .btn-3d[onclick*="speak"], #print-btn { display: none !important; }
            .quiz-button, [id^="print-btn"] { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">
    <div id="auth-container" class="max-w-md mx-auto mt-20 p-8 card">
        <h2 class="text-2xl font-bold text-center mb-6">로그인</h2>
        <div id="firebaseui-auth-container"></div>
    </div>

    <div id="app-container" class="hidden">
        <div class="max-w-4xl mx-auto p-4 pb-24">
            <!-- 헤더 -->
            <header class="text-center my-8 flex justify-between items-center">
                <div></div>
                <div>
                    <h1 class="text-4xl font-bold text-gray-700" style="text-shadow: 2px 2px 4px #d1d9e6;">AI Vocabulary Builder</h1>
                    <p class="text-gray-500 mt-2">AI와 함께 단어의 모든 것을 탐험하세요</p>
                </div>
                <button id="logout-button" class="btn-3d !p-3">
                    <i data-lucide="log-out"></i>
                </button>
            </header>

            <!-- 검색창 -->
            <div class="card p-6 mb-8 sticky top-4 z-10">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-input" placeholder="영단어 또는 한글 뜻을 입력하세요..." class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    <button id="search-button" class="btn-3d w-full sm:w-auto">
                        <i data-lucide="search" class="inline-block mr-2"></i> 검색
                    </button>
                </div>
            </div>

            <!-- 로딩 상태 표시줄 -->
            <div id="loading-container" class="hidden text-center my-10">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-600 font-semibold"></p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Tab Bar -->
            <div id="tab-bar" class="flex flex-wrap items-end border-b-2 border-slate-300 mb-4">
                <!-- Tabs will be dynamically inserted here -->
            </div>
            
            <!-- 콘텐츠 영역 -->
            <main id="tab-content-container"></main>
        </div>

        <!-- 고정 하단 메뉴 -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-t border-t-2 border-slate-200 z-50">
            <div class="max-w-4xl mx-auto flex justify-around p-2">
                <button id="word-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="list-checks"></i>
                    <span class="text-xs font-medium">단어 목록</span>
                </button>
                <button id="sentence-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="save-all"></i>
                    <span class="text-xs font-medium">예문 저장</span>
                </button>
                <button id="file-storage-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="folder-archive"></i>
                    <span class="text-xs font-medium">파일 보관함</span>
                </button>
                <button id="share-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="share-2"></i>
                    <span class="text-xs font-medium">공유하기</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- 콘텐츠 모달 -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideModal(event)">
        <div id="modal-content" class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8 card" onclick="event.stopPropagation()">
            <!-- 모달 내용이 여기에 삽입됩니다 -->
        </div>
    </div>

    <!-- 이미지 모달 -->
    <div id="image-modal-container" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center p-4 z-[60] modal" onclick="hideImageModal()">
        <img id="modal-image" src="" class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
        <button onclick="hideImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition" aria-label="Close image view">
            <i data-lucide="x" class="w-10 h-10"></i>
        </button>
    </div>
    
    <!-- 저장된 단어/예문 목록 모달 -->
    <div id="list-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideListModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card" onclick="event.stopPropagation()">
            <div id="list-modal-header" class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 id="list-modal-title" class="text-xl font-bold"></h2>
                <button onclick="hideListModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 flex flex-wrap gap-2 justify-between items-center bg-slate-200 border-b border-slate-300">
                <div>
                    <select id="sort-options" class="px-3 py-1.5 border border-slate-300 rounded-md bg-white">
                        <!-- 정렬 옵션 -->
                    </select>
                </div>
                <div id="list-actions" class="flex flex-wrap gap-2">
                     <button id="mark-read-btn" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>읽음으로</button>
                     <button id="mark-unread-btn" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 disabled:bg-gray-400" disabled>읽지 않음으로</button>
                     <button id="delete-selected-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 disabled:bg-gray-400" disabled>선택 삭제</button>
                </div>
            </div>
            <div id="list-modal-content" class="p-6 overflow-y-auto flex-grow">
                <!-- 목록 내용 -->
            </div>
        </div>
    </div>
    
    <!-- 파일 보관함 모달 -->
    <div id="file-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideFileModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 class="text-xl font-bold">파일 보관함</h2>
                <button onclick="hideFileModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 border-b border-slate-300">
                 <h3 class="font-semibold mb-2">새 파일 올리기 (50MB 이하)</h3>
                 <input type="file" id="file-upload-input" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                 <button id="file-upload-button" class="btn-3d mt-4 w-full">업로드</button>
                 <div id="upload-progress-container" class="hidden mt-2">
                     <div class="w-full bg-gray-200 rounded-full h-2.5">
                         <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                     </div>
                 </div>
            </div>
            <div id="file-list" class="p-6 overflow-y-auto flex-grow">
                <!-- 파일 목록이 여기에 표시됩니다. -->
            </div>
        </div>
    </div>

    <!-- 토스트 메시지 -->
    <div id="toast-container" class="toast fixed bottom-24 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>
    
    <!-- 실시간 번역 툴팁 -->
    <div id="word-tooltip" class="hidden absolute z-[100] px-3 py-1.5 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm"></div>

    <!-- Firebase SDK and custom script -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
    <script>
    (function() {
        // ---------------------------
        // 0. 초기 설정 및 변수 선언
        // ---------------------------
        let db, auth, storage, userId, app;
        
        // Firebase 구성 정보
        const firebaseConfig = {
            apiKey: "AIzaSyDKmpQO6htm7jZ2DByUfGnmocZP7dpTJhs",
            authDomain: "projec-48c55.firebaseapp.com",
            projectId: "projec-48c55",
            storageBucket: "projec-48c55.appspot.com",
            messagingSenderId: "376464552007",
            appId: "1:376464552007:web:929b53196fc86af19dc162",
            measurementId: "G-HMKJMNFGM4"
        };
        const firestoreAppId = firebaseConfig.projectId || 'default-app-id';

        // UI 요소
        const searchInput = document.getElementById('search-input');
        const logoutButton = document.getElementById('logout-button');
        const fileUploadButton = document.getElementById('file-upload-button');
        const fileUploadInput = document.getElementById('file-upload-input');
        
        // 상태 변수
        const translationCache = {};
        let tabs = {};
        let activeTabId = null;
        let tabCounter = 0;

        // ---------------------------
        // 1. Firebase 초기화 및 인증
        // ---------------------------
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                
                const ui = new firebaseui.auth.AuthUI(auth);

                auth.onAuthStateChanged(user => {
                    const authContainer = document.getElementById('auth-container');
                    const appContainer = document.getElementById('app-container');
                    
                    if (user) {
                        userId = user.uid;
                        authContainer.style.display = 'none';
                        appContainer.classList.remove('hidden');
                        loadInitialData();
                    } else {
                        userId = null;
                        authContainer.style.display = 'block';
                        appContainer.classList.add('hidden');
                        ui.start('#firebaseui-auth-container', {
                            signInOptions: [firebase.auth.GoogleAuthProvider.PROVIDER_ID],
                            callbacks: {
                                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                                    return false; // 로그인 후 리디렉션 방지
                                },
                            },
                            signInFlow: 'redirect',
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase 초기화/인증 오류: ", error);
                showToast("데이터베이스 연결 또는 인증에 실패했습니다.", "error");
            }
        }
        
        function loadInitialData() {
            // 이전에 있던 loadUserLists(), loadFiles() 등의 함수를 호출
            loadFiles();
            safeCreateIcons();
        }

        // ---------------------------
        // 2. 파일 보관함 기능 (오류 수정됨)
        // ---------------------------
        function handleFileUpload() {
            if (!userId) {
                showToast("로그인이 필요합니다.", "error");
                return;
            }
            const file = fileUploadInput.files[0];
            if (!file) {
                showToast("업로드할 파일을 선택해주세요.", "info");
                return;
            }
            if (file.size > 50 * 1024 * 1024) { // 50MB 제한
                showToast("파일 크기는 50MB를 초과할 수 없습니다.", "error");
                return;
            }
            
            // [수정됨] Firestore 보안 규칙과 일치하도록 사용자별 저장소 경로를 지정합니다.
            // 이렇게 하면 각 사용자는 자신의 파일에만 접근할 수 있습니다.
            const storagePath = `artifacts/${firestoreAppId}/users/${userId}/files/${file.name}`;
            const fileRef = storage.ref(storagePath);
            const task = fileRef.put(file);

            const progressContainer = document.getElementById('upload-progress-container');
            const progressBar = document.getElementById('upload-progress-bar');
            progressContainer.classList.remove('hidden');

            task.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                },
                (error) => {
                    console.error("파일 업로드 오류:", error);
                    showToast(`업로드 실패: ${error.message}`, "error");
                    progressContainer.classList.add('hidden');
                },
                () => {
                    showToast("파일이 성공적으로 업로드되었습니다.", "success");
                    progressContainer.classList.add('hidden');
                    fileUploadInput.value = ''; // 입력 필드 초기화
                    loadFiles(); // 파일 목록 새로고침
                }
            );
        }

        async function loadFiles() {
            if (!userId) return;

            const fileListDiv = document.getElementById('file-list');
            fileListDiv.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                // [수정됨] 파일을 가져올 때도 업로드 시 사용한 것과 동일한 사용자별 경로를 사용합니다.
                const storagePath = `artifacts/${firestoreAppId}/users/${userId}/files`;
                const listRef = storage.ref(storagePath);
                const res = await listRef.listAll();

                if (res.items.length === 0) {
                    fileListDiv.innerHTML = '<p class="text-gray-500 text-center">보관된 파일이 없습니다.</p>';
                    return;
                }

                const fileItems = await Promise.all(res.items.map(async (itemRef) => {
                    const metadata = await itemRef.getMetadata();
                    const url = await itemRef.getDownloadURL();
                    return { ref: itemRef, metadata, url };
                }));

                fileListDiv.innerHTML = fileItems.map(file => `
                    <div class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-200 transition-colors">
                        <a href="${file.url}" target="_blank" rel="noopener noreferrer" class="flex-grow truncate text-blue-600 hover:underline" title="${file.metadata.name}">
                            <i data-lucide="file-text" class="inline-block mr-2"></i>
                            ${file.metadata.name}
                        </a>
                        <span class="text-sm text-gray-500 mr-4">${(file.metadata.size / 1024).toFixed(2)} KB</span>
                        <button class="text-red-500 hover:text-red-700" onclick="deleteFile('${file.ref.fullPath}')">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                `).join('');
                safeCreateIcons();

            } catch (error) {
                console.error("파일 목록 로드 오류:", error);
                 if (error.code === 'storage/object-not-found' || error.code === 'storage/unauthorized') {
                     fileListDiv.innerHTML = '<p class="text-gray-500 text-center">보관된 파일이 없거나 접근 권한이 없습니다.</p>';
                 } else {
                    fileListDiv.innerHTML = '<p class="text-red-500 text-center">파일을 불러오는 중 오류가 발생했습니다.</p>';
                 }
            }
        }
        
        window.deleteFile = async function(fullPath) {
             if (!confirm("정말로 이 파일을 삭제하시겠습니까?")) return;
             try {
                 await storage.ref(fullPath).delete();
                 showToast("파일이 삭제되었습니다.", "success");
                 loadFiles();
             } catch(error) {
                 console.error("파일 삭제 오류: ", error);
                 showToast("파일 삭제에 실패했습니다.", "error");
             }
        }
        
        // ---------------------------
        // 3. UI 이벤트 리스너 및 유틸리티 함수
        // ---------------------------
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toastMessage = document.getElementById('toast-message');
            
            toastContainer.classList.remove('bg-gray-800', 'bg-green-600', 'bg-red-600', 'bg-blue-600');
            if (type === 'success') {
                toastContainer.classList.add('bg-green-600');
            } else if (type === 'error') {
                toastContainer.classList.add('bg-red-600');
            } else if (type === 'info') {
                toastContainer.classList.add('bg-blue-600');
            } else {
                 toastContainer.classList.add('bg-gray-800');
            }

            toastMessage.textContent = message;
            toastContainer.classList.add('show');
            setTimeout(() => {
                toastContainer.classList.remove('show');
            }, 3000);
        }

        function safeCreateIcons() {
             if (typeof lucide !== 'undefined') {
                lucide.createIcons();
             }
        }

        // DOM이 로드된 후 스크립트 실행
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            
            // 파일 업로드 버튼 이벤트 리스너
            if(fileUploadButton) {
                fileUploadButton.addEventListener('click', handleFileUpload);
            }
            
            // 로그아웃 버튼 이벤트 리스너
            if(logoutButton) {
                logoutButton.addEventListener('click', () => {
                    auth.signOut().catch(error => {
                        console.error("로그아웃 오류:", error);
                        showToast("로그아웃에 실패했습니다.", "error");
                    });
                });
            }
            
            // 하단 메뉴 버튼 이벤트 리스너
            document.getElementById('file-storage-btn').addEventListener('click', () => {
                if (!userId) {
                    showToast("로그인이 필요합니다.", "error");
                    return;
                }
                loadFiles(); // 모달을 열 때마다 파일 목록을 새로고침
                document.getElementById('file-modal-container').classList.remove('hidden');
                document.getElementById('file-modal-container').classList.add('flex');
            });
        });
        
        // 전역 스코프에 모달 숨기기 함수 노출
        window.hideFileModal = function(event) {
            const modal = document.getElementById('file-modal-container');
            // 배경 클릭 시에만 닫히도록
            if (event.target === modal) {
                 modal.classList.add('hidden');
                 modal.classList.remove('flex');
            }
        };


        // ... (나머지 UI 및 검색 관련 스크립트 코드는 이전 버전과 동일) ...
        // ... 여기에 단어 검색, 탭 관리, 단어/예문 목록 모달 등의 코드가 위치합니다 ...


    })();
    </script>
</body>
</html>

