<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vocabulary Builder</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-icons@0.378.0/dist/lucide.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #e0e5ec; 
            color: #4a5568;
        }
        body, h1, h2, h3, h4, p, span, div, button, a {
            text-shadow: 1px 1px 1px #ffffff, -1px -1px 1px #c5c9d2;
        }
        input, select, textarea {
            text-shadow: none;
            background-color: #e0e5ec;
        }
        .prose p, .prose li { text-shadow: none; }

        .btn-3d {
            background-color: #e0e5ec;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            color: #4a5568;
            box-shadow: 6px 6px 12px #c5c9d2, -6px -6px 12px #fdffff;
            transition: all 0.2s ease-in-out;
            outline: none;
            text-shadow: 1px 1px 1px #ffffff, -1px -1px 1px #c5c9d2;
        }
        .btn-3d:hover { box-shadow: 4px 4px 8px #c5c9d2, -4px -4px 8px #fdffff; }
        .btn-3d:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: inset 2px 2px 4px #c5c9d2, inset -2px -2px 4px #fdffff;
        }
        .btn-3d:active { box-shadow: inset 4px 4px 8px #c5c9d2, inset -4px -4px 8px #fdffff; }
        
        .card {
            background-color: #e0e5ec;
            border-radius: 15px;
            box-shadow: 8px 8px 16px #c5c9d2, -8px -8px 16px #fdffff;
            margin-bottom: 2rem;
        }
        
        .clickable-word {
            cursor: pointer;
            font-weight: 500;
            color: #2b6cb0;
            transition: color 0.2s;
            border-bottom: 1px dotted #2b6cb0;
            text-shadow: none;
        }
        .clickable-word:hover {
            color: #2c5282;
            background-color: #bee3f8;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal { transition: opacity 0.3s ease; }
        
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        
        .clickable-image {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .clickable-image:hover { transform: scale(1.03); }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem; /* 36px */
            height: 2.25rem; /* 36px */
            border-radius: 9999px;
            background-color: #e2e8f0;
            transition: all 0.2s;
            color: #4a5568;
            box-shadow: 3px 3px 6px #c5c9d2, -3px -3px 6px #fdffff;
            position: relative;
        }
        .icon-btn:hover {
            color: #1a202c;
            box-shadow: 2px 2px 4px #c5c9d2, -2px -2px 4px #fdffff;
        }
        .icon-btn:active { box-shadow: inset 2px 2px 4px #c5c9d2, inset -2px -2px 4px #fdffff; }

        .icon-btn svg path, .icon-btn svg circle, .icon-btn svg polygon, .icon-btn svg line {
            filter: drop-shadow(1px 1px 1px rgba(255, 255, 255, 0.7)) drop-shadow(-1px -1px 1px rgba(0, 0, 0, 0.2));
            transition: filter 0.2s;
        }
        
        .tooltip {
            visibility: hidden;
            opacity: 0;
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%; 
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.2s;
            white-space: nowrap;
            font-size: 0.75rem;
            text-shadow: none;
        }

        .icon-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* ë…¹ìŒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .record-btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            background-color: #dbf0ff;
            color: #2b6cb0;
            border: 1px solid #a3c9e6;
            border-radius: 8px;
            transition: all 0.2s;
            text-shadow: 1px 1px 1px #fff;
            box-shadow: 2px 2px 4px #c5c9d2, -2px -2px 4px #fdffff;
        }
        .record-btn:hover { background-color: #cce7ff; }
        .record-btn.recording {
            background-color: #fed7d7;
            color: #c53030;
            border-color: #f7b0b0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }
        
        /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        .audio-player {
            height: 30px;
            margin-top: 8px;
            filter: sepia(20%) saturate(70%) grayscale(100%) contrast(100%) brightness(100%);
        }

        @media print {
            body {
                background-color: #fff !important;
                font-family: 'Times New Roman', serif;
                margin: 0;
                padding: 0;
            }
            
            #app-container,
            #search-bar-container,
            #shortcut-buttons, 
            #loading-container,
            #tab-bar, 
            footer, 
            .modal, .toast, .tooltip, #auth-container, #confirmation-modal, #password-modal {
                display: none !important;
            }

            #print-container {
                display: block !important;
                width: 100%;
                margin: 0 auto;
                padding: 0 1cm;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                padding-top: 10px;
            }
            .print-header h1 {
                font-size: 24pt;
                font-weight: bold;
                color: #000;
                text-shadow: none;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                background-color: #fff !important;
                margin-bottom: 1.5rem;
                padding: 10px !important;
            }
            
            img {
                max-width: 100%;
                height: auto;
                page-break-inside: avoid;
            }

            #print-container * {
                text-shadow: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">
    <div id="app-container" style="visibility: hidden;">
        <div class="max-w-4xl mx-auto p-4 pb-24">
            
            <header class="text-center my-8 flex justify-center items-center">
                <div>
                    <h1 class="text-4xl font-bold text-gray-700" style="text-shadow: 2px 2px 4px #d1d9e6;">AI Vocabulary Builder</h1>
                    <p class="text-gray-500 mt-2">AIì™€ í•¨ê»˜ ë‹¨ì–´ì˜ ëª¨ë“  ê²ƒì„ íƒí—˜í•˜ì„¸ìš”</p>
                </div>
            </header>

            
            <div id="search-bar-container" class="card p-6 mb-8 sticky top-4 z-10">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-input" placeholder="ê²€ìƒ‰í•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”..." class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" disabled>
                    <button id="search-button" class="btn-3d w-full sm:w-auto">
                        <i data-lucide="search" class="inline-block mr-2"></i> ê²€ìƒ‰
                    </button>
                </div>
            </div>

            
            <div id="shortcut-buttons" class="card p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <a href="https://www.naver.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-green-600 !p-2 !text-sm">
                    <svg class="w-6 h-6 mb-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="20" height="20" rx="4" fill="#03C75A"/>
                        <path d="M12 7V17M12 7L10 9M12 7L14 9M10 17H14" stroke="#e0e5ec" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="11" fill="none" stroke="#03C75A" stroke-width="2"/>
                    </svg>
                    ë„¤ì´ë²„
                </a>
                <a href="https://www.google.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-blue-600 !p-2 !text-sm">
                    <i data-lucide="globe-2" class="w-5 h-5 mb-1 text-blue-500" style="text-shadow: 1px 1px 1px #e0e5ec, -1px -1px 1px #c5c9d2;"></i> 
                    Google
                </a>
                <a href="https://www.youtube.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-red-600 !p-2 !text-sm">
                    <i data-lucide="youtube" class="w-5 h-5 mb-1 text-red-600" style="text-shadow: 1px 1px 1px #e0e5ec, -1px -1px 1px #c5c9d2;"></i> 
                    YouTube
                </a>
                <a href="https://www.clien.net" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 text-gray-700 !p-2 !text-sm">
                    <i data-lucide="message-square" class="w-5 h-5 mb-1 text-blue-900" style="text-shadow: 1px 1px 1px #e0e5ec, -1px -1px 1px #c5c9d2;"></i> 
                    Clien
                </a>
            </div> 
            
            
            <div id="google-calendar" class="card p-6">
                <h3 class="text-2xl font-bold mb-4 flex items-center text-blue-700">
                    <i data-lucide="calendar" class="mr-2 text-blue-500"></i>Google ìº˜ë¦°ë”
                </h3>
                <div class="w-full h-[600px] rounded-lg overflow-hidden border-2 border-slate-200">
                     <iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=Asia%2FSeoul&showPrint=0&src=bGVzaWwxMEBnbWFpbC5jb20&src=aGs2Y2Qzb2ZoYmc3NHRuajA2cjFzNGUxaWNAZ3JvdXAuY2FsZW5kYXIuZ29vZ2xlLmNvbQ&src=a28uc291dGhfa29yZWEjaG9saWRheUBncm91cC52LmNhbGVuZGFyLmdvb2dsZS5jb20&color=%23e67c73&color=%238e24aa&color=%237986cb" style="border:solid 1px #777" width="100%" height="100%" frameborder="0" scrolling="no"></iframe>
                </div>
            </div>

            
            <div id="loading-container" class="hidden text-center my-10">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-600 font-semibold"></p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            
            
            <div id="tab-bar" class="flex flex-wrap items-end border-b-2 border-slate-300 mb-4">
            </div>
            
            
            <main id="tab-content-container"></main>

            
            <div id="print-only-modal-content" class="hidden"></div> 
        </div>

        
        <footer class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-t border-t-2 border-slate-200 z-50">
            <div class="max-w-4xl mx-auto flex justify-around p-2">
                <button id="word-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="list-checks"></i>
                    <span class="text-xs font-medium">ë‹¨ì–´ ëª©ë¡</span>
                </button>
                <button id="sentence-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="save-all"></i>
                    <span class="text-xs font-medium">ì˜ˆë¬¸ ì €ì¥</span>
                </button>
                <button id="file-storage-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="folder-archive"></i>
                    <span class="text-xs font-medium">íŒŒì¼ ë³´ê´€í•¨</span>
                </button>
                <button id="share-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="share-2"></i>
                    <span class="text-xs font-medium">ê³µìœ í•˜ê¸°</span>
                </button>
            </div>
        </footer>
    </div>
    
    
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideModal(event)">
        <div id="modal-content" class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8 card !mb-0" onclick="event.stopPropagation()">
        </div>
    </div>
    
    
    <div id="image-modal-container" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center p-4 z-[60] modal" onclick="hideImageModal()">
        <img id="modal-image" src="" class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
        
        <div id="image-caption-container" class="hidden absolute bottom-4 left-4 right-4 p-4 bg-black/70 text-white rounded-lg">
            <h4 class="font-bold text-lg mb-2">AI ì´ë¯¸ì§€ ë¶„ì„</h4>
            <p id="image-caption-text" class="text-sm"></p>
            <div id="image-caption-loader" class="loader !w-8 !h-8 !border-2 !border-t-blue-500 mx-auto my-2"></div>
        </div>
        
        <button onclick="hideImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition" aria-label="Close image view">
            <i data-lucide="x" class="w-10 h-10"></i>
        </button>
    </div>

    
    <div id="list-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideListModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card !mb-0" onclick="event.stopPropagation()">
            <div id="list-modal-header" class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 id="list-modal-title" class="text-xl font-bold"></h2>
                <button onclick="hideListModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 flex flex-wrap gap-2 justify-between items-center bg-slate-200 border-b border-slate-300">
                <div>
                    <select id="sort-options" class="px-3 py-1.5 border border-slate-300 rounded-md bg-white">
                    </select>
                </div>
                <div id="list-actions" class="flex flex-wrap gap-2">
                    <button id="mark-read-btn" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>ì½ìŒìœ¼ë¡œ</button>
                    <button id="mark-unread-btn" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 disabled:bg-gray-400" disabled>ì½ì§€ ì•ŠìŒìœ¼ë¡œ</button>
                    <button id="delete-selected-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 disabled:bg-gray-400" disabled>ì„ íƒ ì‚­ì œ</button>
                </div>
            </div>
            <div id="list-modal-content" class="p-6 overflow-y-auto flex-grow">
            </div>
        </div>
    </div>

    
    <div id="file-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideFileModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card !mb-0" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 class="text-xl font-bold">íŒŒì¼ ë³´ê´€í•¨</h2>
                <button onclick="hideFileModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 border-b border-slate-300">
                <h3 class="font-semibold mb-2">ìƒˆ íŒŒì¼ ì˜¬ë¦¬ê¸° (50MB ì´í•˜)</h3>
                <input type="file" id="file-upload-input" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <button id="file-upload-button" class="btn-3d mt-4 w-full">ì—…ë¡œë“œ</button>
                <div id="upload-progress-container" class="hidden mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="file-list" class="p-6 overflow-y-auto flex-grow">
            </div>
        </div>
    </div>

    
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-[70] modal">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-sm w-full p-6 card !mb-0">
            <h3 id="confirmation-title" class="text-lg font-bold mb-4">í™•ì¸</h3>
            <p id="confirmation-message" class="mb-6">ì´ ì‘ì—…ì„ ì •ë§ë¡œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="btn-3d">ì·¨ì†Œ</button>
                <button id="confirm-ok-btn" class="btn-3d !bg-red-500 !text-white hover:!bg-red-600">í™•ì¸</button>
            </div>
        </div>
    </div>
    
    
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-[70] modal">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-sm w-full p-6 card !mb-0">
            <h3 class="text-lg font-bold mb-4">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h3>
            <p class="mb-4">ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸(6195)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="password-input" class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥...">
            <div class="flex justify-end gap-4 mt-6">
                <button id="password-cancel-btn" class="btn-3d">ì·¨ì†Œ</button>
                <button id="password-ok-btn" class="btn-3d">í™•ì¸</button>
            </div>
        </div>
    </div>


    
    <div id="toast-container" class="toast fixed bottom-24 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    
    <div id="word-tooltip" class="hidden absolute z-[100] px-3 py-1.5 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm"></div>

    
    <div id="print-container" style="display: none;">
        <div class="print-header">
            <h1 class="text-4xl">AI Vocabulary Builder</h1>
            <p>AIì™€ í•¨ê»˜ ë‹¨ì–´ì˜ ëª¨ë“  ê²ƒì„ íƒí—˜í•˜ì„¸ìš”</p>
            <hr style="border: 1px solid #ccc; margin-top: 10px;">
        </div>
        <div id="print-content-area">
        </div>
    </div>

    
    <!-- 
      ì´ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì•ˆì— ë‹¤ìŒ íŒŒì¼ (script.js)ì˜ 
      ëª¨ë“  JavaScript ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    -->
    <script type="module">
       // Firebase Modular SDK imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// =========================================================================
// === ì‚¬ìš©ì ì„¤ì •: Firebase ë° Google Cloud API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. ===
// =========================================================================
const USER_FIREBASE_CONFIG = {
  apiKey: "AIzaSyDKmpQO6htm7jZ2DByUfGnmocZP7dpTJhs",
  authDomain: "projec-48c55.firebaseapp.com",
  projectId: "projec-48c55",
  storageBucket: "projec-48c55.appspot.com",
  messagingSenderId: "376464552007",
  appId: "1:376464552007:web:929b53196fc86af19dc162",
  measurementId: "G-HMKJMNFGM4"
};
const USER_GEMINI_API_KEY = "AIzaSyDKmpQO6htm7jZ2DByUfGnmocZP7dpTJhs"; 
// =========================================================================

// 0. Initial Setup & Variable Declaration
const searchInput = document.getElementById('search-input');
const searchButton = document.getElementById('search-button');
const loadingContainer = document.getElementById('loading-container');
const loadingText = document.getElementById('loading-text');
const progressBar = document.getElementById('progress-bar');
const printContainer = document.getElementById('print-container');
const printContentArea = document.getElementById('print-content-area');

const apiKey = USER_GEMINI_API_KEY; 
const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;
const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict`;
const visionApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

const translationCache = {};

// Firebase Setup
let db, auth, storage, userId;
let app; 
const appId = 'default-ai-vocab-app'; // GitHub Pagesìš© ê³ ì • ID

// Tab Management
let tabs = {};
let activeTabId = null;
let tabCounter = 0;
let savedWords = [];
let savedSentences = [];

// Password Lock
let isSearchUnlocked = false;
const passwordModal = document.getElementById('password-modal');
const passwordInput = document.getElementById('password-input');
const passwordOkBtn = document.getElementById('password-ok-btn');
const passwordCancelBtn = document.getElementById('password-cancel-btn');

// Audio Recording
let mediaRecorder;
let audioChunks = [];

// =========================================================================
// === ëª¨ë“  ì£¼ìš” í•¨ìˆ˜ë“¤ì„ ì´ê³³ì— ë¨¼ì € ì •ì˜í•©ë‹ˆë‹¤. ===
// =========================================================================
function renderFileList(files) {
    const fileListDiv = document.getElementById('file-list');
    if (files.length === 0) {
        fileListDiv.innerHTML = '<p class="text-center text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    fileListDiv.innerHTML = '';
    files.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

    files.forEach(fileData => {
        const fileElement = document.createElement('div');
        fileElement.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-slate-200';
        fileElement.innerHTML = `
            <div class="truncate">
                <p class="font-semibold truncate">${fileData.name}</p>
                <p class="text-sm text-gray-500">${(fileData.size / 1024 / 1024).toFixed(2)} MB</p>
            </div>
            <div class="flex items-center gap-1 flex-shrink-0">
                <button class="icon-btn" onclick="downloadFile('${fileData.fullPath}')">${createDownloadIcon()}<span class="tooltip">ë‹¤ìš´ë¡œë“œ</span></button>
                <button class="icon-btn text-red-500" onclick="deleteFile('${fileData.id}', '${fileData.fullPath}')">${createTrashIcon()}<span class="tooltip">ì‚­ì œ</span></button>
            </div>
        `;
        fileListDiv.appendChild(fileElement);
    });
    safeCreateIcons();
}

function showToast(message, type = "info") {
    const toast = document.getElementById('toast-container');
    const toastMessage = document.getElementById('toast-message');
    toastMessage.textContent = message;

    toast.className = 'toast show fixed bottom-24 right-5 text-white px-6 py-3 rounded-lg shadow-lg';
    if (type === 'success') toast.classList.add('bg-green-600');
    else if (type === 'error') toast.classList.add('bg-red-600');
    else if (type === 'warning') toast.classList.add('bg-yellow-500');
    else toast.classList.add('bg-gray-800');
    
    setTimeout(() => { toast.className = 'toast'; }, 3000);
}

function loadUserLists() {
    if (!db || !userId) return;

    const wordsQuery = collection(db, `artifacts/${appId}/users/${userId}/saved_words`);
    onSnapshot(wordsQuery, (snapshot) => {
        savedWords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if(window.currentListType === 'words') window.renderList();
    }, (error) => console.error("Error loading words:", error));

    const sentencesQuery = collection(db, `artifacts/${appId}/users/${userId}/saved_sentences`);
    onSnapshot(sentencesQuery, (snapshot) => {
        savedSentences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if(window.currentListType === 'sentences') window.renderList();
    }, (error) => console.error("Error loading sentences:", error));
}

function listenForFiles() {
    if (!db || !userId) return;
    const filesQuery = collection(db, `artifacts/${appId}/users/${userId}/file_metadata`);
    onSnapshot(filesQuery, (snapshot) => {
        const files = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderFileList(files);
    }, (error) => {
        console.error("Error listening for files:", error);
        const fileListDiv = document.getElementById('file-list');
        fileListDiv.innerHTML = '<p class="text-center text-red-500">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    });
}

function safeCreateIcons() {
    if (window.lucide) {
        window.lucide.createIcons();
    }
}
// =========================================================================

// Firebase Initialization and Authentication
async function initializeFirebase() {
    try {
        if (!USER_FIREBASE_CONFIG.apiKey) {
            console.error("Firebase config is missing.");
            showToast("Firebase êµ¬ì„± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.", "error");
            document.getElementById('app-container').style.visibility = 'visible';
            return;
        }
        
        app = initializeApp(USER_FIREBASE_CONFIG);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);

        const userCredential = await signInAnonymously(auth);
        userId = userCredential.user.uid;
        console.log("Authenticated Anonymously. User ID:", userId);

        document.getElementById('app-container').style.visibility = 'visible';
        loadUserLists();
        listenForFiles();
        safeCreateIcons();

    } catch (error) {
        console.error("Firebase Initialization/Auth Error: ", error);
        showToast("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë˜ëŠ” ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
    }
}

// ---------------------------
// 1. API Communication Functions
// ---------------------------

async function fetchWithRetry(baseUrl, payload, retries = 3) {
    if (!apiKey) {
        showToast("Google AI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");
        throw new Error("Google AI API Key is missing.");
    }

    const finalUrl = `${baseUrl}?key=${apiKey}`;
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(finalUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.text();
                console.error(`API Error Response: ${response.status} - ${errorBody}`);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Attempt ${i + 1} failed:`, error);
            if (i === retries - 1) {
                showToast("AI ì„œë²„ ì‘ë‹µì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
                throw error;
            }
            const delay = 1000 * Math.pow(2, i) + Math.random() * 1000;
            await new Promise(res => setTimeout(res, delay));
        }
    }
}

async function callGemini(prompt, isJson = false, config = {}) {
    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        ...config
    };
    if (isJson) {
        payload.generationConfig = { ...(payload.generationConfig || {}), responseMimeType: "application/json" };
    }
    
    const result = await fetchWithRetry(textApiUrl, payload);
    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) {
        if(result.candidates?.[0]?.finishReason === "SAFETY") {
             throw new Error("SAFETY_POLICY_VIOLATION");
        }
        console.error("Empty response from Gemini:", result);
        throw new Error("Gemini API response is empty.");
    }

    if (isJson) {
        let jsonString = text.trim();
        if (jsonString.startsWith("```json")) {
            jsonString = jsonString.slice(7, -3).trim();
        } else if (jsonString.startsWith("```")) {
            jsonString = jsonString.slice(3, -3).trim();
        }
        
        try {
            return JSON.parse(jsonString);
        } catch (error) {
            console.error("Failed to parse JSON:", error);
            console.error("Original text from API:", text);
            throw error;
        }
    }

    return text;
}

async function callImagen(prompt, retries = 2) {
    const payload = {
        instances: [{ prompt: prompt }],
        parameters: { "sampleCount": 1 }
    };
    for (let i = 0; i < retries; i++) {
        try {
            const result = await fetchWithRetry(imageApiUrl, payload);
            if (!result.predictions || result.predictions.length === 0) {
                 throw new Error("NO_PREDICTIONS");
            }
            const base64Data = result.predictions?.[0]?.bytesBase64Encoded;
            if (!base64Data) {
                throw new Error("EMPTY_IMAGE_DATA");
            }
            return `data:image/png;base64,${base64Data}`;
        } catch (e) {
            console.error(`Imagen API call attempt ${i + 1} failed:`, e);
            if (i === retries - 1) {
                if (e.message.includes("SAFETY")) {
                     return "POLICY_VIOLATION";
                }
                return "LOAD_FAILED";
            }
            await new Promise(res => setTimeout(res, 1000));
        }
    }
}

async function callVisionApi(prompt, base64ImageData, mimeType) {
    const payload = {
        contents: [
            {
                role: "user",
                parts: [
                    { text: prompt },
                    {
                        inlineData: {
                            mimeType: mimeType,
                            data: base64ImageData
                        }
                    }
                ]
            }
        ],
    };
    const result = await fetchWithRetry(visionApiUrl, payload);
    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) {
        console.error("Empty response from Vision API:", result);
        throw new Error("Vision API response is empty.");
    }
    return text;
}


// ---------------------------
// 2. Core Logic: Search and Content Generation
// ---------------------------

async function handleSearch(query) {
    if (!apiKey) { 
        showToast("Google AI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");
        return;
    }
    if (!auth || !auth.currentUser) {
        showToast("Firebaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. êµ¬ì„± ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.", "error");
        return;
    }
    if (!query) {
        showToast("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        return;
    }

    const isKorean = /[ã„±-ã…|ã…-ã…£|ê°€-í£]/.test(query);

    if (isKorean) {
        showLoader(0, `'${query}'ì— ëŒ€í•œ ì˜ë¯¸ í™•ì¸ ì¤‘...`);
        try {
            const ambiguityPrompt = `í•œêµ­ì–´ ë‹¨ì–´ "${query}"ê°€ ì—¬ëŸ¬ ê°œì˜ ëšœë ·í•˜ê²Œ ë‹¤ë¥¸ ì˜ì–´ ë‹¨ì–´ë¡œ ë²ˆì—­ë  ìˆ˜ ìˆë‚˜ìš”? (ì˜ˆ: 'ë°°' -> ship, pear, stomach). ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ëŒ€ë‹µí•´ì¤˜: {"is_ambiguous": boolean, "english_words": ["ë‹¨ì–´1", "ë‹¨ì–´2", ...]}. ëª¨í˜¸í•˜ì§€ ì•Šìœ¼ë©´ "english_words" ë°°ì—´ì— ëŒ€í‘œ ì˜ì–´ ë‹¨ì–´ í•˜ë‚˜ë§Œ í¬í•¨í•´ì¤˜.`;
            const ambiguityData = await callGemini(ambiguityPrompt, true);
            
            if (ambiguityData.is_ambiguous && ambiguityData.english_words.length > 1) {
                showToast(`'${query}'ì— ëŒ€í•´ ì—¬ëŸ¬ ì˜ë¯¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ê°ê° íƒ­ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.`, "info");
                for (let i = 0; i < ambiguityData.english_words.length; i++) {
                    const word = ambiguityData.english_words[i];
                    await executeSearchForWord(word, i === 0);
                }
            } else {
                await executeSearchForWord(ambiguityData.english_words[0] || query);
            }
        } catch (error) {
            console.error("Ambiguity check failed:", error);
            showToast("ë‹¨ì–´ ì˜ë¯¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            await executeSearchForWord(query);
        } finally {
            hideLoader();
        }
    } else {
        await executeSearchForWord(query);
    }
}

function getErrorImageSrc(reason) {
    if (reason === "POLICY_VIOLATION") {
        return `https://placehold.co/300x300/e74c3c/ffffff?text=ì•ˆì „+ì •ì±…ì—+ì˜í•´\ní‘œì‹œí• +ìˆ˜+ì—†ìŠµë‹ˆë‹¤`;
    }
    return `https://placehold.co/300x300/e74c3c/ffffff?text=ì´ë¯¸ì§€+ë¡œë“œ+ì‹¤íŒ¨`;
}

async function executeSearchForWord(wordQuery, makeActive = true) {
    const tabId = addTab(wordQuery, makeActive);
    const currentTab = tabs[tabId];
    const contentContainer = currentTab.contentEl;
    contentContainer.innerHTML = '';
    
    const searchId = ++currentTab.searchId;
    currentTab.fullSearchResult = {};

    showLoader(0, `"${wordQuery}" ê²€ìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤...`);
    searchButton.disabled = true;

    const headerHeight = document.querySelector('header').offsetHeight || 100;
    window.scrollTo({ top: headerHeight, behavior: 'smooth' });

    try {
        updateLoader(10, "ê¸°ë³¸ ì •ë³´ ìƒì„± ì¤‘...");
        const initialInfoPrompt = `ì˜ì–´ ë‹¨ì–´ "${wordQuery}"ì— ëŒ€í•œ ì¢…í•©ì ì¸ ì •ë³´ë¥¼ ìƒì„±í•´ì¤˜. ë‹¤ìŒ JSON í˜•ì‹ì„ ë°˜ë“œì‹œ ë”°ë¼ì¤˜:
        {
            "word": "ì‹¤ì œ ì˜ì–´ ë‹¨ì–´",
            "koreanMeaning": "ëŒ€í‘œì ì¸ í•œê¸€ ëœ»",
            "pronunciation": "ë°œìŒ ê¸°í˜¸",
            "mainImagePrompt": "ë‹¨ì–´ë¥¼ í•¨ì¶•ì ìœ¼ë¡œ í‘œí˜„í•˜ëŠ”, ì˜ˆìˆ ì ì´ê³  ìƒì„¸í•œ ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•œ ì˜ì–´ í”„ë¡¬í”„íŠ¸. ì˜ˆ: 'brain' -> 'A hyper-realistic, detailed anatomical illustration of the human brain, showing different lobes with glowing neural pathways, artistic style.'",
            "episode": {
                "story": "ë‹¨ì–´ë¥¼ ì‰½ê²Œ ê¸°ì–µí•  ìˆ˜ ìˆëŠ” ë§¤ìš° ì›ƒê¸°ê³  ì¬ë¯¸ìˆëŠ” ì§§ì€ ì´ì•¼ê¸° (3~4 ë¬¸ì¥).",
                "story_ko": "ìœ„ ì´ì•¼ê¸°ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í•œê¸€ ë²ˆì—­.",
                "imagePrompt": "ì´ì•¼ê¸° ë‚´ìš©ì— ë§ëŠ”, ë°ê³  ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§Œí™” ìŠ¤íƒ€ì¼ì˜ ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•œ ì˜ì–´ í”„ë¡¬í”„íŠ¸. ì˜ˆ: 'Dr. Slump' ë§Œí™” ìŠ¤íƒ€ì¼."
            }
        }`;
        const initialData = await callGemini(initialInfoPrompt, true);
        currentTab.fullSearchResult.initialData = initialData;
        if (searchId !== currentTab.searchId) return;

        updateLoader(25, "ê¸°ë³¸ ì •ë³´ í‘œì‹œ ì¤‘...");
        renderPrintButton(currentTab);
        const placeholderImg = "https://placehold.co/300x300/e0e5ec/4a5568?text=Loading...";
        renderBasicInfo(initialData, placeholderImg, contentContainer, tabId);
        renderEpisode(initialData, placeholderImg, contentContainer, tabId);
        addWordToHistory(initialData.word, initialData.koreanMeaning);

        callImagen(initialData.mainImagePrompt).then(imageUrlOrReason => {
            currentTab.fullSearchResult.mainImageUrl = imageUrlOrReason;
            if (searchId === currentTab.searchId) {
                const imgEl = contentContainer.querySelector('#main-image');
                if (imgEl) {
                    const src = (imageUrlOrReason === "LOAD_FAILED" || imageUrlOrReason === "POLICY_VIOLATION") ? getErrorImageSrc(imageUrlOrReason) : imageUrlOrReason;
                    imgEl.src = src;
                    if (imageUrlOrReason !== "LOAD_FAILED" && imageUrlOrReason !== "POLICY_VIOLATION") {
                         imgEl.onclick = () => showImageModal(imageUrlOrReason, initialData.word);
                    } else {
                        imgEl.onclick = null;
                        imgEl.classList.remove('clickable-image');
                    }
                }
            }
        }).catch(e => console.error("Main Image Load Failed:", e));
        
        callImagen(initialData.episode.imagePrompt).then(imageUrlOrReason => {
            currentTab.fullSearchResult.episodeImageUrl = imageUrlOrReason;
            if (searchId === currentTab.searchId) {
                const imgEl = contentContainer.querySelector('#episode-image');
                if (imgEl) {
                    const src = (imageUrlOrReason === "LOAD_FAILED" || imageUrlOrReason === "POLICY_VIOLATION") ? getErrorImageSrc(imageUrlOrReason) : imageUrlOrReason;
                    imgEl.src = src;
                    if (imageUrlOrReason !== "LOAD_FAILED" && imageUrlOrReason !== "POLICY_VIOLATION") {
                        imgEl.onclick = () => showImageModal(imageUrlOrReason, "ì—í”¼ì†Œë“œ");
                    } else {
                        imgEl.onclick = null;
                        imgEl.classList.remove('clickable-image');
                    }
                }
            }
        }).catch(e => console.error("Episode Image Load Failed:", e));
        
        updateLoader(40, "ì˜ë¯¸ ë¶„ì„ ìƒì„± ì¤‘...");
        const meaningsPrompt = `ì˜ì–´ ë‹¨ì–´ "${initialData.word}"ì˜ ì˜ë¯¸ë¥¼ ë¶„ì„í•´ì¤˜. í•µì‹¬ ì˜ë¯¸, ë¶€ê°€ì  ì˜ë¯¸, ìˆ™ì–´ í‘œí˜„ ê°ê°ì— ëŒ€í•´ ì„¤ëª…ê³¼ ëŒ€í‘œ ì˜ˆë¬¸, ê·¸ë¦¬ê³  ê·¸ ì˜ˆë¬¸ì— ë§ëŠ” 'Dr. Slump' ìŠ¤íƒ€ì¼ì˜ ì¬ë¯¸ìˆëŠ” ì‚½í™” í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ì¤˜. ë‹¤ìŒ JSON í˜•ì‹ì„ ë°˜ë“œì‹œ ë”°ë¼ì¤˜:
        [
            { "type": "í•µì‹¬ ì˜ë¯¸", "description": "í•µì‹¬ ì˜ë¯¸ì— ëŒ€í•œ ìì„¸í•œ í•œê¸€ ì„¤ëª….", "exampleSentence": "ì˜ë¯¸ë¥¼ ê°€ì¥ ì˜ ë‚˜íƒ€ë‚´ëŠ” í˜„ëŒ€ì ì´ê³  ì¼ë°˜ì ì¸ ì˜ì–´ ì˜ˆë¬¸.", "exampleSentenceTranslation": "ìœ„ ì˜ˆë¬¸ì˜ í•œê¸€ ë²ˆì—­.", "imagePrompt": "ìœ„ ì˜ˆë¬¸ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ, 'Dr.slump' ë§Œí™” ìŠ¤íƒ€ì¼ì˜ ì¬ë¯¸ìˆëŠ” ì‚½í™” ìƒì„±ì„ ìœ„í•œ ì˜ì–´ í”„ë¡¬í”„íŠ¸. ì¸ë¬¼ í‘œì •ì€ ë‹¤ì–‘í•˜ê³  ì¬ë¯¸ìˆê²Œ." },
            { "type": "ë¶€ê°€ì  ì˜ë¯¸", "description": "ë¶€ê°€ì , ë¹„ìœ ì , í™•ì¥ëœ ì˜ë¯¸ì— ëŒ€í•œ í•œê¸€ ì„¤ëª….", "exampleSentence": "í•´ë‹¹ ì˜ë¯¸ë¥¼ ë³´ì—¬ì£¼ëŠ” ì°½ì˜ì ì¸ ì˜ì–´ ì˜ˆë¬¸.", "exampleSentenceTranslation": "ìœ„ ì˜ˆë¬¸ì˜ í•œê¸€ ë²ˆì—­.", "imagePrompt": "ìœ„ ì˜ˆë¬¸ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‚½í™” í”„ë¡¬í”„íŠ¸." },
            { "type": "ìˆ™ì–´ í‘œí˜„", "description": "ë‹¨ì–´ê°€ í¬í•¨ëœ ì¤‘ìš” ìˆ™ì–´ì™€ ê·¸ ì˜ë¯¸ì— ëŒ€í•œ í•œê¸€ ì„¤ëª….", "exampleSentence": "ìˆ™ì–´ê°€ ì‚¬ìš©ëœ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ ì˜ˆë¬¸.", "exampleSentenceTranslation": "ìœ„ ì˜ˆë¬¸ì˜ í•œê¸€ ë²ˆì—­.", "imagePrompt": "ìœ„ ì˜ˆë¬¸ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‚½í™” í”„ë¡¬í”„íŠ¸." }
        ]`;
        const meaningsData = await callGemini(meaningsPrompt, true);
        currentTab.fullSearchResult.meaningsData = meaningsData;
        if (searchId !== currentTab.searchId) return;

        await renderMeanings(meaningsData, initialData.word, searchId, currentTab, contentContainer, tabId);
        
        renderSentenceCrafter(initialData.word, contentContainer, tabId);

        updateLoader(75, "ì‹¬í™” í•™ìŠµ ì •ë³´ ìƒì„± ì¤‘...");
        const fastDeepDivePrompt = `ì˜ì–´ ë‹¨ì–´ "${initialData.word}"ì— ëŒ€í•œ ì‹¬í™” í•™ìŠµ ì½˜í…ì¸ ë¥¼ ìƒì„±í•´ì¤˜. "encyclopedia"ëŠ” ì œì™¸í•˜ê³  ë‹¤ìŒ JSON í˜•ì‹ì„ ë°˜ë“œì‹œ ë”°ë¼ì¤˜:
        {
            "quotes": [
                {"quote": "ê´€ë ¨ ëª…ì–¸/ìœ ëª… ë¬¸êµ¬ 1", "translation": "í•œê¸€ ë²ˆì—­"},
                {"quote": "ê´€ë ¨ ëª…ì–¸/ìœ ëª… ë¬¸êµ¬ 2", "translation": "í•œê¸€ ë²ˆì—­"},
                {"quote": "ê´€ë ¨ ëª…ì–¸/ìœ ëª… ë¬¸êµ¬ 3", "translation": "í•œê¸€ ë²ˆì—­"}
            ],
            "synonyms": ["ìœ ì˜ì–´1(ëœ»1)", "ìœ ì˜ì–´2(ëœ»2)", "ìœ ì˜ì–´3(ëœ»3)"],
            "antonyms": ["ë°˜ì˜ì–´1(ëœ»1)", "ë°˜ì˜ì–´2(ëœ»2)"],
            "conceptTree": { "superordinate": ["ìƒìœ„ ê°œë… (ì˜ì–´(í•œê¸€))"], "coordinate": ["ë™ìœ„ ê°œë… 1 (ì˜ì–´(í•œê¸€))", "...(ì´ 10ê°œ)"], "subordinate": ["í•˜ìœ„ ê°œë… 1 (ì˜ì–´(í•œê¸€))", "...(ì´ 20ê°œ)"] },
            "dialogue": [ 
                {"speaker": "A", "line": "ëŒ€í™” ë¬¸ì¥ 1 (ì˜ì–´)", "translation": "ëŒ€í™” ë¬¸ì¥ 1 (í•œê¸€)"}, 
                {"speaker": "B", "line": "ëŒ€í™” ë¬¸ì¥ 2 (ì˜ì–´)", "translation": "ëŒ€í™” ë¬¸ì¥ 2 (í•œê¸€)"}
            ],
            "quiz": [
                { "question": "ë‚œì´ë„ ë†’ì€ 4ì§€ì„ ë‹¤ í€´ì¦ˆ ë¬¸ì œ 1", "options": ["ì„ íƒì§€ A", "ì„ íƒì§€ B", "ì„ íƒì§€ C", "ì„ íƒì§€ D"], "answer": "ì •ë‹µ ì„ íƒì§€", "explanation": "ì •ë‹µì— ëŒ€í•œ ìƒì„¸í•œ í•œê¸€ í•´ì„¤. í€´ì¦ˆ ë¬¸ì œ ë¬¸ì¥ì— ëŒ€í•œ í•œê¸€ í•´ì„ì„ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤." }
            ]
        }`;
        const fastDeepDiveData = await callGemini(fastDeepDivePrompt, true);
        currentTab.fullSearchResult.fastDeepDiveData = fastDeepDiveData;
        if (searchId !== currentTab.searchId) return;
        
        updateLoader(90, "ì‹¬í™” ì •ë³´ í‘œì‹œ ì¤‘...");
        const buttonContainer = renderDeepDiveButtonsContainer(contentContainer);
        appendConceptTreeButton(buttonContainer, fastDeepDiveData.conceptTree);
        renderDeepDive(fastDeepDiveData, contentContainer, tabId);
        
        
        hideLoader();
        showToast("í•µì‹¬ ì •ë³´ ë¡œë”© ì™„ë£Œ! ë°±ê³¼ì‚¬ì „ ì •ë³´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤...", "info");

        const encyclopediaPrompt = `ì˜ì–´ ë‹¨ì–´ "${initialData.word}"ì— ëŒ€í•œ ë°±ê³¼ì‚¬ì „ì‹ ì„¤ëª…ì„ ìƒì„±í•´ì¤˜. A4 ìš©ì§€ 3ì¥ ë¶„ëŸ‰ì— ì¤€í•˜ëŠ” ìƒì„¸í•œ ë‚´ìš©ì´ì–´ì•¼ í•˜ë©°, 'ì–´ì›', 'ì—­ì‚¬ì  ë°°ê²½', 'ë¬¸í•™/í˜„ëŒ€ì—ì„œì˜ ì‚¬ìš©' ì„¹ì…˜ì„ í¬í•¨í•˜ì—¬ êµ¬ì¡°í™”í•´ì¤˜. ë‹¤ìŒ JSON í˜•ì‹ë§Œ ë”°ë¼ì¤˜:
        { 
            "encyclopedia": { 
                "introduction": "ìƒì„¸í•œ ì„œë¡  (ì˜ì–´, ì—¬ëŸ¬ ë¬¸ë‹¨)", "etymology": "ê¹Šì´ ìˆëŠ” ì–´ì› ë¶„ì„ (ì˜ì–´, ì—¬ëŸ¬ ë¬¸ë‹¨)", "history": "í¬ê´„ì ì¸ ì—­ì‚¬ì  ë°°ê²½ê³¼ ë³€í™” ê³¼ì • (ì˜ì–´, ì—¬ëŸ¬ ë¬¸ë‹¨)", "usage": "ë¬¸í•™, í˜„ëŒ€ ë¯¸ë””ì–´, ì¼ìƒì—ì„œì˜ ì‚¬ìš© ì˜ˆì‹œ (ì˜ì–´, ì—¬ëŸ¬ ë¬¸ë‹¨)",
                "introduction_ko": "ìœ„ ë‚´ìš©ì˜ í•œê¸€ ë²ˆì—­", "etymology_ko": "ìœ„ ë‚´ìš©ì˜ í•œê¸€ ë²ˆì—­", "history_ko": "ìœ„ ë‚´ìš©ì˜ í•œê¸€ ë²ˆì—­", "usage_ko": "ìœ„ ë‚´ìš©ì˜ í•œê¸€ ë²ˆì—­"
            }
        }`;
        const encyclopediaFullData = await callGemini(encyclopediaPrompt, true);
        if (searchId !== currentTab.searchId) return;
        
        currentTab.fullSearchResult.encyclopediaData = encyclopediaFullData;
        appendEncyclopediaButton(buttonContainer, encyclopediaFullData.encyclopedia);
        showToast("ëª¨ë“  ì½˜í…ì¸  ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", "success");

        const printButton = currentTab.contentEl.querySelector(`#print-btn-${currentTab.id}`);
        if (printButton) {
            printButton.disabled = false;
            printButton.innerHTML = `<i data-lucide="printer" class="inline-block mr-2"></i>ê²°ê³¼ ì¸ì‡„í•˜ê¸°`;
            safeCreateIcons();
        }
        
    } catch (error) {
        console.error("Search failed:", error);
        showToast("ì½˜í…ì¸  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        hideLoader();
        contentContainer.innerHTML = `<div class="card p-8 text-center text-red-500">
            <p>ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-sm text-gray-500 mt-2">ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‹¨ì–´ì´ê±°ë‚˜, ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>`;
    } finally {
        searchButton.disabled = false;
    }
}

// ---------------------------
// 3. Rendering Functions
// ---------------------------

function renderPrintButton(tab) {
    const printButton = document.createElement('button');
    printButton.id = `print-btn-${tab.id}`;
    printButton.className = 'btn-3d mb-4';
    printButton.disabled = true;
    printButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>ì¸ì‡„ ì¤€ë¹„ ì¤‘...`;
    printButton.onclick = () => handlePrint(tab.id);
    tab.contentEl.prepend(printButton);
    safeCreateIcons();
}

function renderBasicInfo(data, imageUrl, container, tabId) {
    const feedbackId = `feedback-basic-${tabId}`;
    const recordingId = `recording-basic-${tabId}`;
    
    const html = `
        <div class="card p-6">
            <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="w-full md:w-2/5">
                    <img id="main-image" src="${imageUrl}" alt="${data.word}" class="rounded-lg shadow-lg w-full h-auto object-cover clickable-image">
                </div>
                <div class="w-full md:w-3/5">
                    <div class="flex items-center gap-4 mb-4">
                        <h2 class="text-5xl font-bold">${data.word}</h2>
                        <button onclick="speak('${data.word}', 'en-US')" class="btn-3d p-3">${createVolumeIcon()}</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="text-2xl text-gray-600">${data.koreanMeaning}</p>
                        <button onclick="speak('${data.koreanMeaning}', 'ko-KR')" class="btn-3d p-3">${createVolumeIcon()}</button>
                    </div>
                    <p class="text-lg text-gray-500 mt-2">[${data.pronunciation}]</p>
                    <div class="mt-4 flex flex-wrap gap-2">
                         <button class="pronunciation-check-btn btn-3d !p-2 !text-sm" onclick="startPronunciationCheck(this, '${data.word}', '${feedbackId}')">âœ¨ ë°œìŒ í”¼ë“œë°±</button>
                         <button class="record-btn" data-target="${recordingId}" data-text="${data.word}">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
                    </div>
                    <div id="${feedbackId}" class="mt-2 text-sm"></div>
                    <div id="${recordingId}" class="mt-2"></div>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    safeCreateIcons();
}

function renderEpisode(data, imageUrl, container, tabId) {
    const { episode, word } = data;
    const feedbackId = `feedback-episode-${tabId}`;
    const recordingId = `recording-episode-${tabId}`;
    
    const html = `
        <div class="card p-6">
            <h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 text-yellow-500"></i>ì¬ë¯¸ìˆëŠ” ì—í”¼ì†Œë“œ</h3>
            <img id="episode-image" src="${imageUrl}" alt="Episode illustration" class="rounded-lg shadow-md w-full h-auto object-cover mb-4 max-w-sm mx-auto clickable-image">
            <div class="space-y-2">
                <p class="text-lg leading-relaxed">${addClickToSearch(episode.story)}</p>
                <p class="text-md leading-relaxed text-gray-600">${episode.story_ko}</p>
            </div>
            <div class="mt-4 flex flex-wrap gap-2">
                <button class="icon-btn" onclick="speak('${episode.story.replace(/'/g, "\\'")}', 'en-US')">
                    ${createVolumeIcon('w-5 h-5')}
                    <span class="tooltip">ì˜ì–´ ë“£ê¸°</span>
                </button>
                <button class="icon-btn" onclick="speak('${episode.story_ko.replace(/'/g, "\\'")}', 'ko-KR')">
                    ${createVolumeIcon('w-5 h-5')}
                    <span class="tooltip">í•œêµ­ì–´ ë“£ê¸°</span>
                </button>
                 <button class="pronunciation-check-btn btn-3d !p-2 !text-sm" onclick="startPronunciationCheck(this, '${episode.story.replace(/'/g, "\\'")}', '${feedbackId}')">âœ¨ ë°œìŒ í”¼ë“œë°±</button>
                 <button class="record-btn" data-target="${recordingId}" data-text="${episode.story.replace(/'/g, "\\'")}">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
                <button class="btn-3d flex-grow !p-2 !text-sm" onclick="expandStory(this, '${word}', '${episode.story.replace(/'/g, "\\'")}', '${episode.story_ko.replace(/'/g, "\\'")}')">âœ¨ ì´ì•¼ê¸° ë” ë§Œë“¤ê¸°</button>
            </div>
            <div id="${feedbackId}" class="mt-2 text-sm"></div>
            <div id="${recordingId}" class="mt-2"></div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    safeCreateIcons();
}

function renderDeepDiveButtonsContainer(container) {
    const btnContainer = document.createElement('div');
    btnContainer.id = 'deep-dive-buttons';
    btnContainer.className = 'card p-6 grid grid-cols-1 sm:grid-cols-2 gap-4';
    container.appendChild(btnContainer);
    return btnContainer;
}

function appendConceptTreeButton(container, conceptTreeData) {
    const conceptTreeBtn = document.createElement('button');
    conceptTreeBtn.id = 'concept-tree-btn';
    conceptTreeBtn.className = 'btn-3d w-full';
    conceptTreeBtn.textContent = 'ê°œë… íŠ¸ë¦¬ ë³´ê¸°';
    conceptTreeBtn.onclick = () => showConceptTree(conceptTreeData);
    container.appendChild(conceptTreeBtn);
}

function appendEncyclopediaButton(container, encyclopediaData) {
    const encyclopediaBtn = document.createElement('button');
    encyclopediaBtn.id = 'encyclopedia-btn';
    encyclopediaBtn.className = 'btn-3d w-full';
    encyclopediaBtn.textContent = 'ë°±ê³¼ì‚¬ì „ì‹ ì„¤ëª… ë³´ê¸°';
    encyclopediaBtn.onclick = () => showEncyclopedia(encyclopediaData);
    container.prepend(encyclopediaBtn);
}

async function renderMeanings(meanings, word, searchId, currentTab, mainContainer, tabId) {
    const container = document.createElement('div');
    container.className = 'card p-6 space-y-8';
    container.innerHTML = `<h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="book-open-check" class="mr-2 text-green-600"></i>ì˜ë¯¸ ë¶„ì„</h3>`;
    mainContainer.appendChild(container);
    
    for (const [index, meaning] of meanings.entries()) {
        if (currentTab.searchId !== searchId) return;

        const element = document.createElement('div');
        element.className = 'border-t border-slate-300 pt-6';
        
        const placeholderImg = "https://placehold.co/300x300/e0e5ec/4a5568?text=Loading...";
        const imageHtml = `<img id="meaning-image-${tabId}-${index}" src="${placeholderImg}" alt="${meaning.type}" class="rounded-lg shadow-md w-full h-auto object-cover mb-4 max-w-sm mx-auto clickable-image">`;
        
        callImagen(meaning.imagePrompt).then(imageUrlOrReason => {
            if (currentTab.searchId === searchId) {
                if (currentTab.fullSearchResult.meaningsData && currentTab.fullSearchResult.meaningsData[index]) {
                    currentTab.fullSearchResult.meaningsData[index].imageUrl = imageUrlOrReason;
                }
                const imgEl = mainContainer.querySelector(`#meaning-image-${tabId}-${index}`);
                if (imgEl) {
                    const src = (imageUrlOrReason === "LOAD_FAILED" || imageUrlOrReason === "POLICY_VIOLATION") ? getErrorImageSrc(imageUrlOrReason) : imageUrlOrReason;
                    imgEl.src = src;
                     if (imageUrlOrReason !== "LOAD_FAILED" && imageUrlOrReason !== "POLICY_VIOLATION") {
                        imgEl.onclick = () => showImageModal(imageUrlOrReason, meaning.type);
                    } else {
                        imgEl.onclick = null;
                        imgEl.classList.remove('clickable-image');
                    }
                }
            }
        }).catch(error => {
            console.error(`Failed to load image for meaning ${index}:`, error);
        });

        const examplesPrompt = `ì˜ì–´ ë‹¨ì–´ "${word}"ì˜ "${meaning.description}" ì˜ë¯¸ì™€ ê´€ë ¨ëœ, í˜„ëŒ€ì ì´ê³  ìœ ìš©í•œ ì˜ì–´ ì˜ˆë¬¸ 5ê°œì™€ ê°ê°ì˜ í•œê¸€ ë²ˆì—­ì„ ìƒì„±í•´ì¤˜. ë‹¤ìŒ JSON í˜•ì‹ì„ ë°˜ë“œì‹œ ë”°ë¼ì¤˜:
        [
            {"en": "Example sentence 1.", "ko": "ì˜ˆë¬¸ 1 í•œê¸€ ë²ˆì—­."},
            {"en": "Example sentence 2.", "ko": "ì˜ˆë¬¸ 2 í•œê¸€ ë²ˆì—­."}
        ]`;
        const examples = await callGemini(examplesPrompt, true);
        if (currentTab.searchId !== searchId) return;
        
        if (currentTab.fullSearchResult.meaningsData && currentTab.fullSearchResult.meaningsData[index]) {
            currentTab.fullSearchResult.meaningsData[index].examples = examples;
        }

        const examplesHtml = examples.map((ex, i) => `
            <li class="flex items-start justify-between gap-3 mt-2">
                <div class="flex items-start">
                    <span class="text-gray-500 mr-2">${i + 1}.</span>
                    <div>
                        <p class="text-md font-medium">${addClickToSearch(ex.en)}</p>
                        <p class="text-sm text-gray-500">${ex.ko}</p>
                    </div>
                </div>
                <div class="flex items-center flex-shrink-0 gap-1">
                    <button class="icon-btn" onclick="speak('${ex.en.replace(/'/g, "\\'")}', 'en-US')">
                        ${createVolumeIcon('w-5 h-5')}
                        <span class="tooltip">ì˜ì–´ ë“£ê¸°</span>
                    </button>
                    <button class="icon-btn" onclick="saveSentence('${ex.en.replace(/'/g, "\\'")}', '${ex.ko.replace(/'/g, "\\'")}')">
                        ${createSaveIcon('w-5 h-5')}
                        <span class="tooltip">ì €ì¥í•˜ê¸°</span>
                    </button>
                </div>
            </li>
            <div class="ml-6 mb-2 flex flex-wrap gap-2">
                <button class="pronunciation-check-btn btn-3d !p-1 !text-xs" onclick="startPronunciationCheck(this, '${ex.en.replace(/'/g, "\\'")}', 'feedback-ex-${tabId}-${index}-${i}')">âœ¨ í”¼ë“œë°±</button>
                <button class="record-btn !text-xs !p-1" data-target="recording-ex-${tabId}-${index}-${i}" data-text="${ex.en.replace(/'/g, "\\"|'|`/")}">ğŸ¤ ë…¹ìŒ</button>
            </div>
            <div id="feedback-ex-${tabId}-${index}-${i}" class="ml-6 text-sm"></div>
            <div id="recording-ex-${tabId}-${index}-${i}" class="ml-6"></div>
        `).join('');

        const feedbackId = `feedback-meaning-${tabId}-${index}`;
        const recordingId = `recording-meaning-${tabId}-${index}`;
        
        element.innerHTML = `
            <h4 class="text-xl font-semibold text-blue-700">${meaning.type}</h4>
            ${imageHtml}
            <p class="text-gray-600 my-2">${meaning.description}</p>
            <p class="font-medium mt-4 mb-2">ëŒ€í‘œ ì˜ˆë¬¸:</p>
            <div class="bg-slate-200 p-4 rounded-lg">
                <div>
                    <p class="text-lg font-semibold">${addClickToSearch(meaning.exampleSentence)}</p>
                    <p class="text-md text-gray-600">${meaning.exampleSentenceTranslation}</p>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <button class="icon-btn" onclick="speak('${meaning.exampleSentence.replace(/'/g, "\\'")}', 'en-US')">
                        ${createVolumeIcon('w-5 h-5')}
                        <span class="tooltip">ì˜ì–´ ë“£ê¸°</span>
                    </button>
                    <button class="icon-btn" onclick="saveSentence('${meaning.exampleSentence.replace(/'/g, "\\'")}', '${meaning.exampleSentenceTranslation.replace(/'/g, "\\'")}')">
                        ${createSaveIcon('w-5 h-5')}
                        <span class="tooltip">ì €ì¥í•˜ê¸°</span>
                    </button>
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button class="pronunciation-check-btn btn-3d !p-2 !text-sm" onclick="startPronunciationCheck(this, '${meaning.exampleSentence.replace(/'/g, "\\'")}', '${feedbackId}')">âœ¨ ë°œìŒ í”¼ë“œë°±</button>
                    <button class="record-btn" data-target="${recordingId}" data-text="${meaning.exampleSentence.replace(/'/g, "\\'")}">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
                </div>
                <div id="${feedbackId}" class="mt-2 text-sm"></div>
                <div id="${recordingId}" class="mt-2"></div>
            </div>
            <p class="font-medium mt-4 mb-2">ì¶”ê°€ ì˜ˆë¬¸:</p>
            <ul class="list-inside space-y-2">${examplesHtml}</ul>`;
        container.appendChild(element);
    }
    safeCreateIcons();
}

function renderSentenceCrafter(word, container, tabId) {
    const html = `
        <div class="card p-6">
            <h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 text-blue-500"></i>AI ë¬¸ì¥ ë§Œë“¤ê¸° âœ¨</h3>
            <p class="text-gray-600 mb-4">ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ìƒí™©ì„ ì…ë ¥í•˜ë©´ AIê°€ ë§ì¶¤ ì˜ˆë¬¸ì„ ë§Œë“¤ì–´ ë“œë¦½ë‹ˆë‹¤. (ì˜ˆ: íšŒì˜, ì¹œêµ¬ì™€ì˜ ëŒ€í™”, ì´ë©”ì¼ ì‘ì„±)</p>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="sentence-context-input-${tabId}" placeholder="ìƒí™©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                <button id="sentence-craft-button-${tabId}" class="btn-3d w-full sm:w-auto" onclick="craftSentences(this, '${word}', '${tabId}')">
                    <i data-lucide="pencil-ruler" class="inline-block mr-2"></i> ìƒì„±
                </button>
            </div>
            <div id="sentence-crafter-results-${tabId}" class="mt-4"></div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    safeCreateIcons();
}

function renderDeepDive(data, container, tabId) {
    const html = `
        <div class="card p-6">
            <h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="graduation-cap" class="mr-2 text-purple-600"></i>ì‹¬í™” í•™ìŠµ</h3>
            <div class="space-y-6">
                ${renderSection("ê´€ë ¨ ëª…ì–¸/ë¬¸êµ¬", "quote", data.quotes.map((q, i) => {
                    const feedbackId = `feedback-quote-${tabId}-${i}`;
                    const recordingId = `recording-quote-${tabId}-${i}`;
                    return `
                    <div class="border-l-4 border-slate-400 pl-4 py-2">
                        <p class="font-semibold text-lg">${addClickToSearch(q.quote)}</p>
                        <p class="text-gray-600">${q.translation}</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button class="icon-btn" onclick="speak('${q.quote.replace(/'/g, "\\'")}', 'en-US')">
                                ${createVolumeIcon('w-5 h-5')}
                                <span class="tooltip">ì˜ì–´ ë“£ê¸°</span>
                            </button>
                            <button class="icon-btn" onclick="saveSentence('${q.quote.replace(/'/g, "\\'")}', '${q.translation.replace(/'/g, "\\'")}')">
                                ${createSaveIcon('w-5 h-5')}
                                <span class="tooltip">ì €ì¥í•˜ê¸°</span>
                            </button>
                            <button class="pronunciation-check-btn btn-3d !p-2 !text-sm" onclick="startPronunciationCheck(this, '${q.quote.replace(/'/g, "\\'")}', '${feedbackId}')">âœ¨ ë°œìŒ í”¼ë“œë°±</button>
                            <button class="record-btn" data-target="${recordingId}" data-text="${q.quote.replace(/'/g, "\\'")}">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
                        </div>
                        <div id="${feedbackId}" class="mt-2 text-sm"></div>
                        <div id="${recordingId}" class="mt-2"></div>
                    </div>`;
                }).join('<hr class="my-3 border-slate-300">')
                )}
                ${renderSection("ìœ ì˜ì–´ ë° ë°˜ì˜ì–´", "arrow-right-left", `
                    <div>
                       <h5 class="font-semibold">ìœ ì˜ì–´:</h5>
                       <div class="flex flex-wrap gap-2 mt-2">${data.synonyms.map(s => `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full clickable-word">${s}</span>`).join('')}</div>
                    </div>
                    <div class="mt-4">
                       <h5 class="font-semibold">ë°˜ì˜ì–´:</h5>
                       <div class="flex flex-wrap gap-2 mt-2">${data.antonyms.map(a => `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full clickable-word">${a}</span>`).join('')}</div>
                    </div>
                `)}
                ${renderSection("AI ì‹œë‚˜ë¦¬ì˜¤ í•™ìŠµ", "message-circle", `
                    <div class="bg-slate-200 p-4 rounded-lg space-y-3">
                        ${data.dialogue.map((d, i) => {
                            const feedbackId = `feedback-dialogue-${tabId}-${i}`;
                            const recordingId = `recording-dialogue-${tabId}-${i}`;
                            return `
                            <div class="border-b border-slate-300 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0">
                                <div class="flex justify-between items-start gap-2">
                                    <div class="flex-grow">
                                        <p><span class="font-bold text-blue-600">${d.speaker}:</span> ${addClickToSearch(d.line)}</p>
                                        <p class="text-sm text-gray-500 pl-4">${d.translation}</p>
                                    </div>
                                    <div class="flex items-center flex-shrink-0 gap-1 mt-1">
                                        <button class="icon-btn" onclick="speak('${d.line.replace(/'/g, "\\'")}', 'en-US')">
                                            ${createVolumeIcon('w-5 h-5')}
                                            <span class="tooltip">ì˜ì–´ ë“£ê¸°</span>
                                        </button>
                                        <button class="icon-btn" onclick="saveSentence('${d.line.replace(/'/g, "\\'")}', '${d.translation.replace(/'/g, "\\'")}')">
                                            ${createSaveIcon('w-5 h-5')}
                                            <span class="tooltip">ì €ì¥í•˜ê¸°</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2 ml-4 flex flex-wrap gap-2">
                                    <button class="pronunciation-check-btn btn-3d !p-1 !text-xs" onclick="startPronunciationCheck(this, '${d.line.replace(/'/g, "\\'")}', '${feedbackId}')">âœ¨ í”¼ë“œë°±</button>
                                    <button class="record-btn !text-xs !p-1" data-target="${recordingId}" data-text="${d.line.replace(/'/g, "\\"|'|`/")}">ğŸ¤ ë…¹ìŒ</button>
                                </div>
                                <div id="${feedbackId}" class="ml-6 text-sm"></div>
                                <div id="${recordingId}" class="ml-6"></div>
                            </div>
                        `}).join('')}
                    </div>
                `)}
                ${renderQuiz("4ì§€ì„ ë‹¤ í€´ì¦ˆ", "swords", data.quiz, tabId)}
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    safeCreateIcons();
}

function renderSection(title, icon, content) {
    return `
        <div class="border-t border-slate-300 pt-4">
            <h4 class="text-xl font-semibold mb-3 flex items-center"><i data-lucide="${icon}" class="w-5 h-5 mr-2"></i>${title}</h4>
            <div>${content}</div>
        </div>
    `;
}

function renderQuiz(title, icon, quizData, tabId) {
    const quizContent = quizData.map((q, index) => {
        const optionsHtml = q.options.map(option => `
            <label class="block">
                <input type="radio" name="quiz-${tabId}-${index}" value="${option}" class="mr-2">
                ${option}
            </label>
        `).join('');
        return `
            <div class="mt-4 bg-slate-200 p-4 rounded-lg" id="quiz-container-${tabId}-${index}">
                <p class="font-semibold">${index + 1}. ${q.question}</p>
                <div class="my-2 space-y-1">${optionsHtml}</div>
                <button onclick="checkQuizAnswer(this, '${tabId}-${index}', '${q.answer.replace(/'/g, "\\'")}')" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 quiz-button">ì •ë‹µ í™•ì¸</button>
                <div id="quiz-explanation-${tabId}-${index}" class="hidden mt-2 p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
                   <p><strong class="font-bold">ì •ë‹µ: ${q.answer}</strong></p>
                   <p>${q.explanation}</p>
                </div>
            </div>
        `;
    }).join('');

    return renderSection(title, icon, quizContent);
}

// ---------------------------
// 4. UI/UX and Utility Functions
// ---------------------------

function createVolumeIcon(size = 'w-5 h-5') {
    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-blue-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
}

function createSaveIcon(size = 'w-5 h-5') {
    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-green-600"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>`;
}

function createDownloadIcon(size = 'w-5 h-5') {
    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-blue-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>`;
}

function createTrashIcon(size = 'w-5 h-5') {
    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-red-500"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"></path></svg>`;
}

function createEyeIcon(size = 'w-5 h-5') {
    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-gray-500"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
}

function createEyeOffIcon(size = 'w-5 h-5') {
    return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-gray-500"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.16 13.16 0 0 0 2 12s3 7 10 7a9.92 9.92 0 0 0 5.43-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>`;
}


window.checkQuizAnswer = function(button, tabIndex, correctAnswer) {
    const container = button.closest(`#quiz-container-${tabIndex}`);
    const selected = container.querySelector(`input[name="quiz-${tabIndex}"]:checked`);
    if (!selected) {
        showToast("ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
        return;
    }
    if (selected.value === correctAnswer) {
        selected.parentElement.classList.add('text-green-600', 'font-bold');
        showToast("ì •ë‹µì…ë‹ˆë‹¤!", "success");
    } else {
        selected.parentElement.classList.add('text-red-600', 'font-bold');
        showToast("ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.", "error");
    }
    container.querySelector(`#quiz-explanation-${tabIndex}`).classList.remove('hidden');
}

function showLoader(progress, text) {
    loadingContainer.classList.remove('hidden');
    progressBar.style.width = `${progress}%`;
    loadingText.textContent = text;
}

function updateLoader(progress, text) {
    progressBar.style.width = `${progress}%`;
    loadingText.textContent = text;
}

function hideLoader() {
    loadingContainer.classList.add('hidden');
}

function addClickToSearch(text) {
    if(!text) return '';
    return text.replace(/\b[a-zA-Z]{2,}\b/g, (match) => `<span class="clickable-word">${match}</span>`);
}

window.speak = function(text, lang = 'en-US') {
    if (!('speechSynthesis' in window)) {
        showToast("í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¶œë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "warning");
        return;
    }
    if (!text) return;
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    speechSynthesis.speak(utterance);
}

// ---------------------------
// 5. Modal and Tooltip Functions
// ---------------------------

const modalContainer = document.getElementById('modal-container');
const modalContent = document.getElementById('modal-content');
const imageModalContainer = document.getElementById('image-modal-container');
const modalImage = document.getElementById('modal-image');
const wordTooltip = document.getElementById('word-tooltip');
const fileModalContainer = document.getElementById('file-modal-container');
let confirmCallback = null;
const confirmationModal = document.getElementById('confirmation-modal');
const confirmationMessage = document.getElementById('confirmation-message');
const confirmOkBtn = document.getElementById('confirm-ok-btn');
const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
const imageCaptionContainer = document.getElementById('image-caption-container');
const imageCaptionText = document.getElementById('image-caption-text');
const imageCaptionLoader = document.getElementById('image-caption-loader');


window.showImageModal = async function(src, word) {
    if (src.startsWith('data:image')) {
        modalImage.src = src;
        imageModalContainer.classList.remove('hidden');
        imageModalContainer.classList.add('flex');
        
        imageCaptionContainer.classList.remove('hidden');
        imageCaptionLoader.classList.remove('hidden');
        imageCaptionText.classList.add('hidden');
        imageCaptionText.textContent = '';
        
        try {
            const base64Data = src.split(',')[1];
            const mimeType = src.match(/data:(image\/[a-zA-Z+]+);base64,/)[1];
            
            const prompt = `ì´ ì´ë¯¸ì§€ëŠ” "${word}"ë¼ëŠ” ë‹¨ì–´ì˜ ì‹œê°ì  í‘œí˜„ì…ë‹ˆë‹¤. ì´ ì´ë¯¸ì§€ê°€ "${word}"ì˜ ì–´ë–¤ ì˜ë¯¸ë‚˜ ë§¥ë½ì„ ë‚˜íƒ€ë‚´ëŠ”ì§€ í•œêµ­ì–´ë¡œ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.`;
            const caption = await callVisionApi(prompt, base64Data, mimeType);
            
            imageCaptionText.textContent = caption;
        } catch (error) {
            console.error("Image caption failed:", error);
            imageCaptionText.textContent = "AI ì´ë¯¸ì§€ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        } finally {
            imageCaptionLoader.classList.add('hidden');
            imageCaptionText.classList.remove('hidden');
            safeCreateIcons();
        }
    } else {
        // Placeholder or Error Image
        modalImage.src = src;
        imageModalContainer.classList.remove('hidden');
        imageModalContainer.classList.add('flex');
        imageCaptionContainer.classList.add('hidden');
        safeCreateIcons();
    }
}

window.hideImageModal = function() {
    imageModalContainer.classList.add('hidden');
    imageModalContainer.classList.remove('flex');
    modalImage.src = ''; 
    imageCaptionText.textContent = '';
    imageCaptionContainer.classList.add('hidden');
}

function renderEncyclopediaSection(title, content_en, content_ko) {
    const safe_content_en = content_en || '';
    const safe_content_ko = content_ko || '';

    if (!safe_content_en && !safe_content_ko) return '';
    
    return `
        <div class="mt-6">
            <h4 class="text-xl font-bold mb-2">${title}</h4>
            <div class="prose max-w-none text-justify space-y-4">
                <p class="text-gray-700">${safe_content_ko.replace(/\n/g, '<br>')}</p>
                <details class="text-sm">
                    <summary class="cursor-pointer text-gray-500">ì˜ì–´ ì›ë¬¸ ë³´ê¸°</summary>
                    <p class="mt-2 text-gray-600">${addClickToSearch(safe_content_en.replace(/\n/g, '<br>'))}</p>
                </details>
            </div>
        </div>
    `;
}

function getEncyclopediaHtml(data) {
     return `
        <div class="print-section">
            <h3 class="text-2xl font-bold mb-4">ë°±ê³¼ì‚¬ì „ì‹ ì‹¬í™” ì„¤ëª…</h3>
            ${renderEncyclopediaSection('ì„œë¡  (Introduction)', data.introduction, data.introduction_ko)}
            ${renderEncyclopediaSection('ì–´ì› (Etymology)', data.etymology, data.etymology_ko)}
            ${renderEncyclopediaSection('ì—­ì‚¬ì  ë°°ê²½ (Historical Background)', data.history, data.history_ko)}
            ${renderEncyclopediaSection('ë¬¸í•™/í˜„ëŒ€ì—ì„œì˜ ì‚¬ìš© (Usage)', data.usage, data.usage_ko)}
        </div>
    `;
}

function showEncyclopedia(data) {
    modalContent.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold">ë°±ê³¼ì‚¬ì „ì‹ ì„¤ëª…</h3>
            <button onclick="hideModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
        </div>
        <div id="encyclopedia-content">
            ${renderEncyclopediaSection('ì„œë¡  (Introduction)', data.introduction, data.introduction_ko)}
            ${renderEncyclopediaSection('ì–´ì› (Etymology)', data.etymology, data.etymology_ko)}
            ${renderEncyclopediaSection('ì—­ì‚¬ì  ë°°ê²½ (Historical Background)', data.history, data.history_ko)}
            ${renderEncyclopediaSection('ë¬¸í•™/í˜„ëŒ€ì—ì„œì˜ ì‚¬ìš© (Usage)', data.usage, data.usage_ko)}
        </div>
    `;
    
    modalContainer.classList.remove('hidden');
    modalContainer.classList.add('flex');
    safeCreateIcons();
}

function getConceptTreeHtml(data) {
    const createList = (title, items) => {
        if (!items || items.length === 0) return '';
        const itemsHtml = items.map(item => `<span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full">${item}</span>`).join('');
        return `<div><h4 class="font-semibold text-lg mt-4">${title}</h4><div class="flex flex-wrap gap-2 mt-2">${itemsHtml}</div></div>`
    };
    return `
        <div class="print-section mt-8">
            <h3 class="text-2xl font-bold mb-4">ê°œë… íŠ¸ë¦¬</h3>
            ${createList('ìƒìœ„ ê°œë…', data.superordinate)}
            ${createList('ë™ìœ„ ê°œë…', data.coordinate)}
            ${createList('í•˜ìœ„ ê°œë…', data.subordinate)}
        </div>
    `;
}

function showConceptTree(data) {
    const createList = (title, items) => {
        if (!items || items.length === 0) return '';
        return `<div><h4 class="font-semibold text-lg mt-4">${title}</h4><div class="flex flex-wrap gap-2 mt-2">${items.map(item => `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full clickable-word">${item}</span>`).join('')}</div></div>`
    };
    modalContent.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold">ê°œë… íŠ¸ë¦¬</h3>
            <button onclick="hideModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
        </div>
        <div id="concept-tree-content">
            ${createList('ìƒìœ„ ê°œë…', data.superordinate)}
            ${createList('ë™ìœ„ ê°œë…', data.coordinate)}
            ${createList('í•˜ìœ„ ê°œë…', data.subordinate)}
        </div>
    `;
    modalContainer.classList.remove('hidden');
    modalContainer.classList.add('flex');
    safeCreateIcons();
}

window.hideModal = function(event) {
    if (event && event.currentTarget !== event.target) return;
    modalContainer.classList.add('hidden');
    modalContainer.classList.remove('flex');
}

window.showFileModal = function() {
    fileModalContainer.classList.remove('hidden');
    fileModalContainer.classList.add('flex');
}

window.hideFileModal = function(event) {
    if (event && event.currentTarget !== event.target && !event.target.closest('button')) return;
    fileModalContainer.classList.add('hidden');
    fileModalContainer.classList.remove('flex');
}

function showConfirmationModal(message, onConfirm) {
    confirmationMessage.textContent = message;
    confirmCallback = onConfirm;
    confirmationModal.classList.remove('hidden');
    confirmationModal.classList.add('flex');
}

function hideConfirmationModal() {
    confirmationModal.classList.add('hidden');
    confirmationModal.classList.remove('flex');
    confirmCallback = null;
}

confirmOkBtn.addEventListener('click', () => {
    if (confirmCallback) {
        confirmCallback();
    }
    hideConfirmationModal();
});

confirmCancelBtn.addEventListener('click', hideConfirmationModal);

function showPasswordModal() {
    if (isSearchUnlocked) return;
    passwordInput.value = '';
    passwordModal.classList.remove('hidden');
    passwordModal.classList.add('flex');
    passwordInput.focus();
}

function hidePasswordModal() {
    passwordModal.classList.add('hidden');
    passwordModal.classList.remove('flex');
}

function handlePasswordSubmit() {
    if (passwordInput.value === '6195') {
        isSearchUnlocked = true;
        searchInput.disabled = false;
        searchInput.placeholder = 'ì˜ë‹¨ì–´ ë˜ëŠ” í•œê¸€ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”...';
        
        hidePasswordModal();
        
        setTimeout(() => {
             searchInput.focus();
        }, 100);

        searchInput.onclick = null;
        searchInput.onfocus = null;
        searchButton.onclick = () => handleSearch(searchInput.value.trim());

    } else {
        showToast("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "error");
        passwordInput.value = '';
    }
}
window.handlePasswordSubmit = handlePasswordSubmit;


// ---------------------------
// 6. Firestore Data Management
// ---------------------------

async function addWordToHistory(word, meaning) {
    if (!db || !userId) return;
    const wordRef = doc(db, `artifacts/${appId}/users/${userId}/saved_words/${word}`);
    try {
        await setDoc(wordRef, { word, meaning, timestamp: new Date(), read: false }, { merge: true });
    } catch(e){
        console.error("Error adding word to history: ", e);
    }
}

window.saveSentence = async function(en, ko) {
    if (!db || !userId) {
        showToast("ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");
        return;
    }
    try {
        const sentenceRef = collection(db, `artifacts/${appId}/users/${userId}/saved_sentences`);
        await addDoc(sentenceRef, { en, ko, timestamp: new Date(), read: false });
        showToast("ì˜ˆë¬¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
    } catch (e) {
        console.error("Error saving sentence: ", e);
        showToast("ì˜ˆë¬¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
    }
}


// ---------------------------
// 7. Saved List Modal UI
// ---------------------------

const listModalContainer = document.getElementById('list-modal-container');
const listModalTitle = document.getElementById('list-modal-title');
const listModalContent = document.getElementById('list-modal-content');
const sortOptions = document.getElementById('sort-options');
const markReadBtn = document.getElementById('mark-read-btn');
const markUnreadBtn = document.getElementById('mark-unread-btn');
const deleteSelectedBtn = document.getElementById('delete-selected-btn');

let currentListType = '';
let currentSort = 'newest';

function showListModal(type) {
    currentListType = type;
    listModalContainer.classList.remove('hidden');
    listModalContainer.classList.add('flex');
    
    if (type === 'words') {
        listModalTitle.textContent = 'ë‹¨ì–´ ëª©ë¡ (ê²€ìƒ‰ ê¸°ë¡)';
        sortOptions.innerHTML = `
            <option value="newest">ìµœì‹ ìˆœ</option>
            <option value="alphabetical">ì•ŒíŒŒë²³ìˆœ</option>
        `;
    } else {
        listModalTitle.textContent = 'ì €ì¥ëœ ì˜ˆë¬¸ ëª©ë¡';
        sortOptions.innerHTML = `
            <option value="newest">ìµœì‹ ìˆœ</option>
            <option value="length">ê¸¸ì´ìˆœ</option>
        `;
    }
    sortOptions.value = currentSort;
    renderList();
    updateListActionButtonsState();
}

function renderList() {
    let items = currentListType === 'words' ? [...savedWords] : [...savedSentences];

    items.sort((a, b) => {
        if (!a.timestamp || !b.timestamp) return 0;
        const timeA = a.timestamp.toMillis ? a.timestamp.toMillis() : new Date(a.timestamp).getTime();
        const timeB = b.timestamp.toMillis ? b.timestamp.toMillis() : new Date(b.timestamp).getTime();
        return timeB - timeA;
    });

    if (currentSort === 'alphabetical' && currentListType === 'words') {
        items.sort((a, b) => a.word.localeCompare(b.word));
    } else if (currentSort === 'length' && currentListType === 'sentences') {
        items.sort((a, b) => a.en.length - b.en.length);
    }
    
    if (items.length === 0) {
        listModalContent.innerHTML = `<p class="text-center text-gray-500">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        return;
    }

    listModalContent.innerHTML = items.map(item => {
        const readClass = item.read ? 'opacity-50' : '';
        const baseHtml = `
            <div class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-200 ${readClass}" data-id="${item.id}">
                <div class="flex items-center flex-grow min-w-0">
                    <input type="checkbox" class="mr-4 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 item-checkbox" data-id="${item.id}">
                    <div class="flex-grow min-w-0">
        `;

        if (currentListType === 'words') {
            return baseHtml + `
                        <p class="font-bold text-lg searchable-list-item cursor-pointer hover:underline" data-word="${item.word}">${item.word}</p>
                        <p class="truncate">${item.meaning}</p>
                    </div>
                </div>
                <div class="flex items-center gap-1 flex-shrink-0">
                    <button onclick="toggleReadStatus('${item.id}', 'words')" class="icon-btn">${item.read ? createEyeOffIcon() : createEyeIcon()} <span class="tooltip">${item.read ? 'ì½ì§€ ì•ŠìŒìœ¼ë¡œ' : 'ì½ìŒìœ¼ë¡œ'}</span></button>
                    <button onclick="deleteListItem('${item.id}', 'words')" class="icon-btn text-red-500 hover:bg-red-100">${createTrashIcon()}<span class="tooltip">ì‚­ì œ</span></button>
                </div>
            </div>
            `;
        } else { // sentences
            return baseHtml + `
                    <div class="truncate">
                        <p class="font-semibold truncate">${addClickToSearch(item.en)}</p>
                        <p class="text-sm truncate">${item.ko}</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-1 flex-shrink-0">
                <button class="icon-btn" onclick="speak('${item.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">ì˜ì–´ ë“£ê¸°</span></button>
               <button onclick="toggleReadStatus('${item.id}', 'sentences')" class="icon-btn">${item.read ? createEyeOffIcon() : createEyeIcon()}<span class="tooltip">${item.read ? 'ì½ì§€ ì•ŠìŒìœ¼ë¡œ' : 'ì½ìŒìœ¼ë¡œ'}</span></button>
               <button onclick="deleteListItem('${item.id}', 'sentences')" class="icon-btn text-red-500 hover:bg-red-100">${createTrashIcon()}<span class="tooltip">ì‚­ì œ</span></button>
            </div>
            </div>
            `;
        }
    }).join('<hr class="my-1 border-slate-300">');
    
    safeCreateIcons();
}
window.renderList = renderList;

window.deleteListItem = function(id, type) {
    showConfirmationModal("ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
        if (!db || !userId) return;
        const collectionName = type === 'words' ? 'saved_words' : 'saved_sentences';
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${id}`);
        try {
            await deleteDoc(docRef);
            showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } catch (error) {
            console.error("Error deleting item:", error);
            showToast("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
        }
    });
}

window.toggleReadStatus = async function(id, type) {
    if (!db || !userId) return;
    const collectionName = type === 'words' ? 'saved_words' : 'saved_sentences';
    const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${id}`);
    try {
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const currentStatus = docSnap.data().read;
            await updateDoc(docRef, { read: !currentStatus });
        }
    } catch (error) {
        console.error("Error toggling read status:", error);
        showToast("ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
    }
};

function updateListActionButtonsState() {
    const checkedItems = listModalContent.querySelectorAll('.item-checkbox:checked');
    const hasSelection = checkedItems.length > 0;
    markReadBtn.disabled = !hasSelection;
    markUnreadBtn.disabled = !hasSelection;
    deleteSelectedBtn.disabled = !hasSelection;
}

listModalContent.addEventListener('change', (e) => {
    if (e.target.classList.contains('item-checkbox')) {
        updateListActionButtonsState();
    }
});

async function performBulkAction(action) {
    const checkedItems = listModalContent.querySelectorAll('.item-checkbox:checked');
    if (checkedItems.length === 0) {
        showToast("í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
        return;
    }
    
    const actionText = action === 'delete' ? 'ì‚­ì œ' : 'ìƒíƒœ ë³€ê²½';
    showConfirmationModal(`ì„ íƒí•œ ${checkedItems.length}ê°œ í•­ëª©ì„ ì •ë§ë¡œ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
        if (!db || !userId) return;
        const batch = writeBatch(db);
        const collectionName = currentListType === 'words' ? 'saved_words' : 'saved_sentences';
        
        checkedItems.forEach(item => {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${item.dataset.id}`);
            if (action === 'delete') {
                batch.delete(docRef);
            } else {
                batch.update(docRef, { read: action === 'mark-read' });
            }
        });

        try {
            await batch.commit();
            showToast("ì„ íƒí•œ í•­ëª©ë“¤ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } catch (error) {
            console.error("Bulk action failed:", error);
            showToast("ì‘ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
        }
    });
}

window.hideListModal = function(event) {
    if(event) {
        if (event.currentTarget !== event.target && !event.target.closest('button')) return;
    }
    listModalContainer.classList.add('hidden');
    listModalContainer.classList.remove('flex');
}

// ---------------------------
// 8. Tab & Print Management
// ---------------------------

function addTab(query, makeActive = true) {
    const tabId = `tab-${++tabCounter}`;
    const tabBar = document.getElementById('tab-bar');
    const tabContentContainer = document.getElementById('tab-content-container');

    const tabButton = document.createElement('button');
    tabButton.id = `tab-btn-${tabId}`;
    tabButton.className = 'px-4 py-2 -mb-px border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-400 flex items-center';
    tabButton.dataset.tabId = tabId;
    tabButton.innerHTML = `
        <span class="tab-title">${query.length > 10 ? query.substring(0, 10) + '...' : query}</span>
        <span class="close-tab-btn ml-2 hover:bg-red-200 rounded-full w-4 h-4 flex items-center justify-center text-xs font-bold">&times;</span>
    `;
    tabBar.appendChild(tabButton);
    
    const tabContent = document.createElement('div');
    tabContent.id = `tab-content-${tabId}`;
    tabContent.className = 'space-y-8';
    tabContentContainer.appendChild(tabContent);

    tabs[tabId] = { id: tabId, query, contentEl: tabContent, buttonEl: tabButton, searchId: 0, fullSearchResult: null };

    tabButton.addEventListener('click', () => switchTab(tabId));
    tabButton.querySelector('.close-tab-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        closeTab(tabId);
    });

    if (makeActive) {
        switchTab(tabId);
    }

    return tabId;
}

function switchTab(tabId) {
    if (!tabs[tabId]) return;
    activeTabId = tabId;
    
    for (const id in tabs) {
        tabs[id].buttonEl.classList.remove('border-blue-500', 'text-gray-900', 'font-semibold');
        tabs[id].buttonEl.classList.add('border-transparent', 'text-gray-500');
        tabs[id].contentEl.classList.add('hidden');
    }
    
    tabs[tabId].buttonEl.classList.add('border-blue-500', 'text-gray-900', 'font-semibold');
    tabs[tabId].buttonEl.classList.remove('border-transparent', 'text-gray-500');
    tabs[tabId].contentEl.classList.remove('hidden');
}

function closeTab(tabId) {
    if (!tabs[tabId]) return;

    tabs[tabId].buttonEl.remove();
    tabs[tabId].contentEl.remove();
    delete tabs[tabId];

    if (activeTabId === tabId) {
        const remainingTabIds = Object.keys(tabs);
        if (remainingTabIds.length > 0) {
            switchTab(remainingTabIds[remainingTabIds.length - 1]);
        } else {
            activeTabId = null;
        }
    }
}

function handlePrint(tabId) {
    const tab = tabs[tabId];
    if (!tab || !tab.fullSearchResult || !tab.fullSearchResult.encyclopediaData || !tab.fullSearchResult.fastDeepDiveData) {
        showToast("ì¸ì‡„ ë°ì´í„°ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª¨ë“  ì •ë³´ê°€ ë¡œë”©ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.", "warning");
        return;
    }
    
    const mainContentHtml = tab.contentEl.innerHTML;
    const encyclopediaHtml = getEncyclopediaHtml(tab.fullSearchResult.encyclopediaData.encyclopedia);
    const conceptTreeHtml = getConceptTreeHtml(tab.fullSearchResult.fastDeepDiveData.conceptTree);
    
    printContentArea.innerHTML = mainContentHtml + encyclopediaHtml + conceptTreeHtml;
    printContainer.style.display = 'block'; 
    
    if (window.lucide) {
        printContainer.querySelectorAll('[data-lucide]').forEach(el => el.remove());
        window.lucide.createIcons({ attr: 'data-lucide', element: printContainer });
    }

    window.print();
    
    setTimeout(() => {
        printContainer.style.display = 'none';
        printContentArea.innerHTML = '';
    }, 500); 
}

// ---------------------------
// 9. File Storage
// ---------------------------
const fileUploadInput = document.getElementById('file-upload-input');
const fileUploadButton = document.getElementById('file-upload-button');

fileUploadButton.addEventListener('click', () => {
    if (!auth || !auth.currentUser) {
        showToast("Firebaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. êµ¬ì„± ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.", "error");
        return;
    }
    
    const file = fileUploadInput.files[0];
    if (!file) {
        showToast("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
        return;
    }

    if (file.size > 50 * 1024 * 1024) { // 50MB
        showToast("íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
        return;
    }
    
    const storagePath = `artifacts/${appId}/users/${userId}/files/${file.name}`;
    const storageRef = ref(storage, storagePath);
    
    const uploadProgressContainer = document.getElementById('upload-progress-container');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    uploadProgressContainer.classList.remove('hidden');
    fileUploadButton.disabled = true;
    
    const uploadTask = uploadBytesResumable(storageRef, file);

    uploadTask.on('state_changed', 
        (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            uploadProgressBar.style.width = progress + '%';
        }, 
        (error) => {
            console.error("Upload failed. Firebase Error Code:", error.code);
            console.error("Full Error:", error);
            showToast(`íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Storage ê·œì¹™ í™•ì¸ í•„ìš”: ${error.code})`, "error");
            
            uploadProgressContainer.classList.add('hidden');
            uploadProgressBar.style.width = '0%';
            fileUploadButton.disabled = false;
        }, 
        async () => {
            let firestoreError = null;
            try {
                const metadata = uploadTask.snapshot.metadata;
                
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/file_metadata`), {
                    name: metadata.name,
                    fullPath: metadata.fullPath,
                    size: metadata.size,
                    contentType: metadata.contentType,
                    timestamp: new Date()
                });
                
            } catch (error) {
                firestoreError = error;
                console.error("CRITICAL: Error saving file metadata to Firestore:", error.code, error.message);
                showToast(`íŒŒì¼ ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ${error.code} (Firestore ê·œì¹™ í™•ì¸ í•„ìš”)`, "error");
                await deleteObject(uploadTask.snapshot.ref).catch(err => console.error("Orphaned file cleanup failed:", err));
                
            } finally {
                uploadProgressContainer.classList.add('hidden');
                uploadProgressBar.style.width = '0%';
                fileUploadInput.value = '';
                fileUploadButton.disabled = false;
                if (!firestoreError) {
                    showToast("íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                }
            }
        }
    );
});

window.downloadFile = function(fullPath) {
    getDownloadURL(ref(storage, fullPath))
        .then((url) => {
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.click();
        })
        .catch((error) => {
            console.error("Error getting download URL:", error);
            showToast("íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
        });
}

window.deleteFile = function(docId, fullPath) {
    showConfirmationModal("ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
        const fileRef = ref(storage, fullPath);
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/file_metadata/${docId}`);
        
        try {
            await deleteObject(fileRef);
            await deleteDoc(docRef);
            showToast("íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } catch (error) {
            console.error("Error deleting file:", error);
            if (error.code === 'storage/object-not-found') {
                try {
                    await deleteDoc(docRef);
                    showToast("íŒŒì¼ ì •ë³´ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
                } catch (dbError) {
                    console.error("Error deleting orphaned metadata:", dbError);
                    showToast("íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                }
            } else {
                showToast("íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            }
        }
    });
}

// ---------------------------
// 10. Advanced AI Interactions
// ---------------------------

window.expandStory = async function(button, word, story, story_ko) {
    button.disabled = true;
    button.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block animate-spin"></div>`;
    try {
        const prompt = `You are a creative storyteller. Expand the following short, humorous story about the word "${word}" into a more detailed and engaging narrative of 3-4 paragraphs. Keep the funny and lighthearted tone.\n\nOriginal Story (English): "${story}"\nOriginal Story (Korean): "${story_ko}"\n\nPlease provide the expanded story in both English and Korean. Format your response as a JSON object with "expanded_story_en" and "expanded_story_ko" keys.`;
        const result = await callGemini(prompt, true);
        
        const episodeCard = button.closest('.card');
        const storyContainer = episodeCard.querySelector('.space-y-2');
        storyContainer.innerHTML = `
            <p class="text-lg leading-relaxed">${addClickToSearch(result.expanded_story_en)}</p>
            <p class="text-md leading-relaxed text-gray-600 mt-2">${result.expanded_story_ko}</p>
        `;
        button.remove(); // Remove button after expansion
    } catch (error) {
        console.error("Failed to expand story:", error);
        showToast("ìŠ¤í† ë¦¬ í™•ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
        button.disabled = false;
        button.innerHTML = `âœ¨ ì´ì•¼ê¸° ë” ë§Œë“¤ê¸°`;
    }
}

window.craftSentences = async function(button, word, tabId) {
    const contextInput = document.getElementById(`sentence-context-input-${tabId}`);
    const context = contextInput.value.trim();
    if (!context) {
        showToast("ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warning");
        return;
    }
    
    const resultsContainer = document.getElementById(`sentence-crafter-results-${tabId}`);
    resultsContainer.innerHTML = `<div class="loader mx-auto"></div>`;
    button.disabled = true;

    try {
        const prompt = `Create 3 example English sentences using the word "${word}" in the context of "${context}". For each sentence, provide a Korean translation. Return the result as a JSON array like this: [{"en": "Sentence 1.", "ko": "ë²ˆì—­ 1."}, {"en": "Sentence 2.", "ko": "ë²ˆì—­ 2."}]`;
        const sentences = await callGemini(prompt, true);
        
        const sentencesHtml = sentences.map((s, i) => {
            const feedbackId = `feedback-crafted-${tabId}-${i}`;
            const recordingId = `recording-crafted-${tabId}-${i}`;
            return `
            <li class="flex items-start justify-between gap-3 mt-2">
                <div class="flex items-start">
                    <span class="text-gray-500 mr-2">${i + 1}.</span>
                    <div>
                        <p class="text-md font-medium">${addClickToSearch(s.en)}</p>
                        <p class="text-sm text-gray-500">${s.ko}</p>
                    </div>
                </div>
                <div class="flex items-center flex-shrink-0 gap-1">
                    <button class="icon-btn" onclick="speak('${s.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">ì˜ì–´ ë“£ê¸°</span></button>
                    <button class="icon-btn" onclick="saveSentence('${s.en.replace(/'/g, "\\'")}', '${s.ko.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">ì €ì¥í•˜ê¸°</span></button>
                </div>
            </li>
            <div class="ml-6 mb-2 flex flex-wrap gap-2">
                <button class="pronunciation-check-btn btn-3d !p-1 !text-xs" onclick="startPronunciationCheck(this, '${s.en.replace(/'/g, "\\'")}', '${feedbackId}')">âœ¨ í”¼ë“œë°±</button>
                <button class="record-btn !text-xs !p-1" data-target="${recordingId}" data-text="${s.en.replace(/'/g, "\\"|'|`/")}">ğŸ¤ ë…¹ìŒ</button>
            </div>
            <div id="${feedbackId}" class="ml-6 text-sm"></div>
            <div id="${recordingId}" class="ml-6"></div>
        `}).join('');
        resultsContainer.innerHTML = `<ul class="list-inside space-y-2">${sentencesHtml}</ul>`;
        safeCreateIcons();

    } catch(error) {
        console.error("Failed to craft sentences:", error);
        resultsContainer.innerHTML = `<p class="text-red-500">ë¬¸ì¥ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
        showToast("ë¬¸ì¥ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
    } finally {
        button.disabled = false;
    }
}

window.startPronunciationCheck = async function(button, textToPractice, feedbackElementId) {
    const feedbackEl = document.getElementById(feedbackElementId);
    if (!feedbackEl) return;
    
    button.disabled = true;
    feedbackEl.innerHTML = `<div class="loader !w-5 !h-5 !border-2 !border-t-blue-500 inline-block mr-2 animate-spin"></div> AIê°€ ë°œìŒ í”¼ë“œë°±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...`;

    try {
        const prompt = `ë‹¹ì‹ ì€ ì›ì–´ë¯¼ ì˜ì–´ ë°œìŒ ì½”ì¹˜ì…ë‹ˆë‹¤. í•œêµ­ì¸ í™”ìê°€ "${textToPractice}" ë¬¸ì¥ì„ ë°œìŒí•œë‹¤ê³  ê°€ì •í•˜ê³ , ê°€ì¥ í”í•˜ê²Œ ì €ì§€ë¥´ëŠ” ë°œìŒ ì‹¤ìˆ˜ 3ê°€ì§€ë¥¼ ì˜ˆì¸¡í•˜ì—¬ ì§€ì í•´ì£¼ì„¸ìš”. ê·¸ë¦¬ê³  êµì • ë°©ë²•ì„ í•œêµ­ì–´ë¡œ ë§¤ìš° êµ¬ì²´ì ì´ê³  ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.
        
        ì‘ë‹µ ì˜ˆì‹œ:
        "ì•„ì£¼ ì¢‹ì€ ì‹œë„ì…ë‹ˆë‹¤! í•œêµ­ì–´ í™”ìë¶„ë“¤ì´ ì´ ë¬¸ì¥ì—ì„œ ìì£¼ ì‹¤ìˆ˜í•˜ëŠ” ë¶€ë¶„ë“¤ì„ ì§šì–´ ë“œë¦´ê²Œìš”:
        1. [ì²« ë²ˆì§¸ ì‹¤ìˆ˜ì™€ êµì • ë°©ë²•]
        2. [ë‘ ë²ˆì§¸ ì‹¤ìˆ˜ì™€ êµì • ë°©ë²•]
        3. [ì„¸ ë²ˆì§¸ ì‹¤ìˆ˜ì™€ êµì • ë°©ë²•]
        ì´ ë¶€ë¶„ë“¤ì— ì§‘ì¤‘í•´ì„œ ë‹¤ì‹œ ì—°ìŠµí•´ ë³´ì„¸ìš”!"`;
        
        const feedback = await callGemini(prompt);
        feedbackEl.innerHTML = `<div class="mt-2 p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-700">${feedback.replace(/\n/g, '<br>')}</div>`;
    } catch (error) {
        console.error("Pronunciation feedback failed:", error);
        feedbackEl.innerHTML = `<p class="text-red-500">í”¼ë“œë°± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
    } finally {
        button.disabled = false;
    }
}

window.startRecording = async function(button, targetId) {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        return;
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                targetEl.innerHTML = `<audio controls class="audio-player w-full" src="${audioUrl}"></audio>`;
            }
            
            button.textContent = 'ğŸ¤ ë…¹ìŒ ì‹œì‘';
            button.classList.remove('recording');
            
            stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        button.textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘ì§€';
        button.classList.add('recording');
        
    } catch (err) {
        console.error('Error starting recording:', err);
        showToast('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'error');
    }
}

// ---------------------------
// 11. Initializers and Event Listeners
// ---------------------------

async function translateWordOnHover(word) {
    if (!apiKey) { 
        return "AI í‚¤ ë¯¸ì„¤ì •";
    }
    if (translationCache[word]) {
        return translationCache[word];
    }
    try {
        const prompt = `Translate the English word "${word}" to Korean. Provide only the most common meaning.`;
        const translation = await callGemini(prompt);
        translationCache[word] = translation.trim();
        return translationCache[word];
    } catch (error) {
        console.error("Translation on hover failed:", error);
        return "ë²ˆì—­ ì‹¤íŒ¨";
    }
}

document.addEventListener('mouseover', async (e) => {
    if (e.target.classList.contains('clickable-word')) {
        const word = e.target.textContent.trim().replace(/[^a-zA-Z-]/g, '');
        if (!word) return;

        const translation = await translateWordOnHover(word);
        wordTooltip.textContent = translation;
        wordTooltip.classList.remove('hidden');

        const rect = e.target.getBoundingClientRect();
        wordTooltip.style.left = `${rect.left + window.scrollX + rect.width / 2 - wordTooltip.offsetWidth / 2}px`;
        wordTooltip.style.top = `${rect.top + window.scrollY - wordTooltip.offsetHeight - 5}px`;
    }
});

document.addEventListener('mouseout', (e) => {
    if (e.target.classList.contains('clickable-word')) {
        wordTooltip.classList.add('hidden');
    }
});

document.addEventListener('click', (e) => {
    if (e.target.classList.contains('clickable-word')) {
        if (!isSearchUnlocked) {
            showPasswordModal();
            return;
        }
        const word = e.target.textContent.trim().replace(/[^a-zA-Z-]/g, '');
        if (word) {
            searchInput.value = word;
            handleSearch(word);
            hideListModal();
        }
    }
    if (e.target.closest('.searchable-list-item')) {
         if (!isSearchUnlocked) {
            showPasswordModal();
            return;
        }
        const word = e.target.closest('.searchable-list-item').dataset.word;
        if(word) {
            searchInput.value = word;
            handleSearch(word);
            hideListModal();
        }
    }
    if (e.target.classList.contains('record-btn')) {
        const targetId = e.target.dataset.target;
        startRecording(e.target, targetId);
    }
});

// Password Modal Listeners
searchInput.onclick = showPasswordModal;
searchInput.onfocus = showPasswordModal;
searchButton.onclick = showPasswordModal;
passwordOkBtn.addEventListener('click', handlePasswordSubmit);
passwordCancelBtn.addEventListener('click', hidePasswordModal);
passwordInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handlePasswordSubmit();
});

// Footer Menu Listeners
document.getElementById('word-list-btn').addEventListener('click', () => showListModal('words'));
document.getElementById('sentence-list-btn').addEventListener('click', () => showListModal('sentences'));
document.getElementById('file-storage-btn').addEventListener('click', showFileModal);

document.getElementById('share-btn').addEventListener('click', () => {
    if(navigator.share) {
        navigator.share({
            title: 'AI Vocabulary Builder',
            text: 'AIì™€ í•¨ê»˜ ìƒˆë¡œìš´ ë‹¨ì–´ë¥¼ ë°°ì›Œë³´ì„¸ìš”!',
            url: window.location.href
        }).catch(err => console.error("Share failed", err));
    } else {
        try {
            document.execCommand('copy');
            showToast("ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } catch (err) {
             showToast("ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
        }
    }
});

// List Modal Listeners
sortOptions.addEventListener('change', (e) => {
    currentSort = e.target.value;
    renderList();
});

markReadBtn.addEventListener('click', () => performBulkAction('mark-read'));
markUnreadBtn.addEventListener('click', () => performBulkAction('mark-unread'));
deleteSelectedBtn.addEventListener('click', () => performBulkAction('delete'));

// App Initialization
document.addEventListener('DOMContentLoaded', initializeFirebase);

 // 2ë²ˆ íŒŒì¼ (script.js)ì˜ ëª¨ë“  ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        // ì´ ì£¼ì„ì€ ì‚­ì œí•˜ì…”ë„ ë©ë‹ˆë‹¤.
    </script>
</body>
</html>

